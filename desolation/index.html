<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desolation: Tears of the Moon</title>
    <style>
        /* ========== GLOBAL & LAYOUT ========== */
        /* Change colors, fonts, or spacing here. .action-grid = the button area (2 columns, scrollable in #action-buttons). */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: #0c0a0f;
            color: #e8e0e8;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ========== CINEMA / INTRO OVERLAY ========== */
        .cinema {
            position: fixed;
            inset: 0;
            z-index: 20000;
            pointer-events: none;
        }
        .cinema .skip-intro-btn {
            pointer-events: auto;
            cursor: pointer;
            position: absolute;
            bottom: 24px;
            right: 24px;
            z-index: 20002;
        }
        .cinema .howl-continue {
            pointer-events: auto;
            cursor: pointer;
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20002;
            color: #b8a8c8;
            font-size: 1em;
            padding: 12px 24px;
        }
        .cinema.hidden { display: none; }
        .menu-overlay {
            position: absolute;
            inset: 0;
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }
        .menu-overlay.hidden { display: none !important; }
        .menu-overlay-content {
            background: rgba(0, 0, 0, 0.75);
            padding: 40px 48px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(160, 140, 180, 0.4);
        }
        .menu-overlay-content .game-title {
            font-size: 2.4em;
            margin-bottom: 6px;
        }
        .menu-overlay-content .game-subtitle {
            font-size: 0.95em;
            margin-bottom: 28px;
        }
        .menu-overlay-content .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 260px;
        }
        .cinema .screen {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        .cinema .screen.visible { opacity: 1; pointer-events: auto; }
        .cinema .screen img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .cinema .screen.white { background: #fff; }
        .cinema .screen.black { background: #000; }
        .cinema .logo-marquee {
            position: absolute;
            white-space: nowrap;
            animation: marqueeFly 2.5s ease-out forwards;
        }
        @keyframes marqueeFly {
            from { transform: translateX(-120%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .cinema .flash { animation: flash 0.4s ease; }
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .cinema .overlay-img {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            object-fit: contain;
            object-position: bottom center;
            max-height: 55%;
        }
        .cinema .heli-ascend {
            animation: heliAscend 4s ease-in forwards;
        }
        @keyframes heliAscend {
            from { transform: translateY(0); }
            to { transform: translateY(-120%); }
        }
        #prologue-bg.prologue-fade-in {
            opacity: 0;
            animation: prologueFadeIn 1.8s ease-out forwards;
        }
        @keyframes prologueFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .cinema .dialog-box {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.85);
            color: #e8e0e8;
            padding: 20px 24px;
            font-size: 1.05em;
            line-height: 1.5;
        }
        .cinema .dialog-box .next { margin-top: 12px; font-size: 0.9em; opacity: 0.8; }

        .title-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at 50% 30%, #1a1525 0%, #0c0a0f 60%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 1.2s ease;
        }
        .title-screen.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .title-content { text-align: center; animation: slideUp 1s ease 0.3s both; }
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .game-title {
            font-size: 3.2em;
            font-weight: 300;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
            color: #c4b5d4;
            text-shadow: 0 0 40px rgba(180, 140, 220, 0.4);
        }
        .game-subtitle {
            font-size: 1em;
            letter-spacing: 0.2em;
            opacity: 0.7;
            margin-bottom: 48px;
            color: #9a8aaa;
        }

        .menu-buttons { display: flex; flex-direction: column; gap: 12px; min-width: 300px; }
        .menu-btn {
            padding: 14px 28px;
            font-size: 1em;
            font-family: inherit;
            background: rgba(100, 80, 120, 0.25);
            border: 1px solid rgba(160, 140, 180, 0.4);
            color: #e8e0e8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .menu-btn:hover {
            background: rgba(120, 100, 150, 0.4);
            border-color: rgba(180, 160, 200, 0.6);
            transform: translateY(-1px);
        }
        .menu-btn.coming-soon { opacity: 0.7; cursor: not-allowed; }

        .options-panel {
            position: fixed;
            inset: 0;
            z-index: 15000;
            background: rgba(12, 10, 20, 0.98);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .options-panel.visible { display: flex; }
        .options-panel h2 { color: #b8a8c8; margin-bottom: 20px; font-size: 1.4em; }
        .options-panel .opt-row { margin: 10px 0; display: flex; align-items: center; gap: 12px; }
        .options-panel .opt-row label { cursor: pointer; }
        .options-panel select { padding: 8px 12px; background: #1a1525; color: #e8e0e8; border: 1px solid rgba(140,120,160,0.4); border-radius: 4px; min-width: 200px; }
        .options-panel .back-btn { margin-top: 24px; }
        .options-panel { z-index: 21000; }
        .btn-danger { background: rgba(140, 60, 60, 0.4); border-color: rgba(180, 80, 80, 0.5); }

        .top-bar {
            background: rgba(12, 10, 15, 0.9);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(140, 120, 160, 0.3);
        }
        .time-display { display: flex; gap: 24px; align-items: center; }
        .time-item { display: flex; align-items: center; gap: 8px; font-size: 0.95em; }
        .speed-controls { display: flex; align-items: center; gap: 4px; margin-left: 16px; }
        .speed-controls .btn-small { padding: 4px 10px; font-size: 0.85em; }
        .moon-display { display: flex; align-items: center; gap: 12px; }
        .moon-icon {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #e8e0e0, #a090b0);
            box-shadow: 0 0 12px rgba(200, 180, 220, 0.4);
        }
        .moon-icon::after {
            content: '';
            position: absolute;
            width: 55%;
            height: 55%;
            border-radius: 50%;
            background: #1a1525;
            top: 22%;
            left: 22%;
        }

        .game-container {
            display: grid;
            grid-template-columns: 240px 1fr 240px;
            grid-template-rows: 1fr auto;
            gap: 12px;
            padding: 12px;
            height: calc(100vh - 56px);
        }

        .panel {
            background: rgba(20, 18, 28, 0.85);
            border-radius: 6px;
            padding: 16px;
            overflow-y: auto;
            border: 1px solid rgba(100, 80, 120, 0.25);
        }
        .panel h3 {
            color: #b8a8c8;
            font-size: 1em;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(140, 120, 160, 0.2);
        }

        .pet-card {
            background: rgba(40, 35, 55, 0.6);
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 14px;
            border-left: 3px solid rgba(160, 140, 200, 0.5);
        }
        .pet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .pet-name { font-size: 1.1em; color: #c4b5d4; }
        .pet-form {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
        }
        .form-human { background: rgba(80, 100, 140, 0.35); }
        .form-hybrid { background: rgba(140, 120, 80, 0.35); }
        .form-wolf { background: rgba(140, 60, 60, 0.35); }

        .stat-bar { margin: 6px 0; }
        .stat-label { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 2px; }
        .bar-container {
            height: 14px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 7px;
            overflow: hidden;
        }
        .bar-fill { height: 100%; transition: width 0.3s ease; border-radius: 7px; }
        .bar-hp { background: #6b8f71; }
        .bar-energy { background: #5a7a9a; }
        .bar-hunger { background: #a08060; }
        .bar-thirst { background: #5a8aaa; }
        .bar-fear { background: #8a6060; }
        .bar-bond { background: #7a8a9a; }
        .bar-shift { background: linear-gradient(90deg, #5a7a9a, #a08060, #8a6060); }

        .travel-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 10px; }
        .assignment-info { font-weight: 500; opacity: 0.9; }
        .assignment-info > div { padding: 8px 12px; background: rgba(0,0,0,0.25); border-radius: 4px; font-size: 0.9em; border: 1px solid rgba(120,100,140,0.2); }
        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        #action-buttons.action-grid {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
            min-height: 0;
        }
        #action-buttons.action-grid::-webkit-scrollbar { width: 8px; }
        #action-buttons.action-grid::-webkit-scrollbar-track { background: #2a2a2a; border-radius: 4px; }
        #action-buttons.action-grid::-webkit-scrollbar-thumb { background: #666; border-radius: 4px; }
        #action-buttons.action-grid::-webkit-scrollbar-thumb:hover { background: #888; }
        .action-grid .btn { width: 100%; min-width: 0; pointer-events: auto; position: relative; z-index: 1; min-height: 48px; touch-action: manipulation; margin-bottom: 0; }
        .action-grid.location-actions-grid { gap: 10px; margin-bottom: 12px; }
        .worker-status-container { margin-bottom: 12px; }
        .btn {
            padding: 12px 16px;
            min-height: 48px;
            border: 1px solid rgba(120, 100, 140, 0.4);
            border-radius: 4px;
            background: rgba(60, 50, 80, 0.4);
            color: #e8e0e8;
            cursor: pointer;
            font-size: 0.9em;
            font-family: inherit;
            transition: all 0.25s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:hover:not(:disabled) {
            background: rgba(80, 70, 110, 0.5);
            border-color: rgba(160, 140, 200, 0.5);
            transform: translateY(-1px);
        }
        .btn:disabled { opacity: 0.5; cursor: pointer; }
        .btn.btn-disabled-style { opacity: 0.55; cursor: pointer; }
        .btn-care { border-color: rgba(80, 120, 80, 0.5); background: rgba(40, 70, 50, 0.4); }
        .btn-train { border-color: rgba(80, 100, 140, 0.5); background: rgba(40, 50, 80, 0.4); }
        .btn-mission { border-color: rgba(140, 100, 60, 0.5); background: rgba(70, 50, 40, 0.4); }

        .center-panel { display: flex; flex-direction: column; min-height: 0; }
        .scene-display {
            flex: 1;
            min-height: 200px;
            max-height: 380px;
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .scene-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 0.8s ease;
        }
        .scene-weather {
            position: absolute;
            inset: 0;
            pointer-events: none;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.85;
            transition: opacity 0.5s ease;
        }
        .scene-title {
            position: absolute;
            top: 8px;
            left: 0;
            right: 0;
            text-align: center;
            color: #e8e0e8;
            font-size: 1em;
            text-shadow: 0 1px 3px #000;
            z-index: 2;
        }
        .pet-visual {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }
        .cage-static {
            width: 120px;
            height: 120px;
            object-fit: contain;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            animation: none !important;
        }
        .scene-display.clearing-view .cage-static { display: none !important; visibility: hidden !important; }
        .pet-sprite {
            width: 80px;
            height: 80px;
            object-fit: contain;
            transition: opacity 0.4s ease;
            position: absolute;
            left: 50%;
            bottom: 0;
        }
        .pet-sprite.out-of-cage {
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-6px); }
        }
        .scene-loot-overlay {
            position: absolute;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .scene-loot-overlay.visible { opacity: 1; }
        .scene-loot-overlay img { width: 48px; height: 48px; object-fit: contain; }
        .enemy-sprite {
            position: absolute;
            right: 12%;
            bottom: 24px;
            width: 100px;
            height: 100px;
            object-fit: contain;
            z-index: 4;
        }

        .combat-log {
            max-height: 180px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 4px;
            font-family: 'Crimson Text', serif;
            font-size: 0.85em;
        }
        .log-entry { margin: 4px 0; padding: 4px; border-left: 2px solid transparent; }
        .log-attack { border-left-color: #a06060; }
        .log-defend { border-left-color: #6080a0; }
        .log-special { border-left-color: #a08050; }
        .log-result { border-left-color: #608a60; font-weight: 600; }

        .stat-list { list-style: none; }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 0.9em;
        }
        .inventory { margin-top: 16px; }
        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9em;
        }

        .story-feed {
            grid-column: 1 / -1;
            max-height: 120px;
            overflow-y: auto;
            background: rgba(15, 12, 22, 0.9);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(100, 80, 120, 0.2);
        }
        .story-entry {
            margin: 6px 0;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            border-left: 3px solid rgba(140, 120, 160, 0.5);
            font-size: 0.9em;
        }

        .save-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.06); }
        .loot-popup-area {
            margin-top: 12px;
            min-height: 48px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .loot-popup-area.visible { opacity: 1; }
        .loot-popup-img { width: 40px; height: 40px; object-fit: contain; }
        .btn-small { padding: 6px 12px; font-size: 0.85em; }

        @media (max-width: 900px) {
            .game-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Click to start (unlocks audio), then intro runs -->
    <div class="cinema" id="click-to-start" style="z-index:20002;">
        <div class="screen black" style="opacity:1; pointer-events:auto; cursor:pointer;">
            <p style="font-size:1.2em; color:#b8a8c8;">Click anywhere to start</p>
        </div>
    </div>

    <!-- INTRO CINEMA: dev card, studio card, title sequence, howl -->
    <div class="cinema" id="cinema">
        <div class="screen" id="cinema-dev"><img src="visuals/dev.png" alt="Dev" id="img-dev" onerror="this.style.display='none'"></div>
        <div class="screen white" id="cinema-white"><img src="visuals/dev.png" alt="Logo" class="logo-marquee" id="img-marquee" onerror="this.style.display='none'"></div>
        <div class="screen" id="cinema-studio"><img src="visuals/studio.png" alt="Studio" id="img-studio" onerror="this.style.display='none'"></div>
        <div class="screen black" id="cinema-black"></div>
        <div class="screen black" id="cinema-title-dark"><img src="visuals/title_dark.png" alt="Title" id="img-title-dark" onerror="this.style.display='none'"></div>
        <div class="screen black" id="cinema-title-light"><img src="visuals/title_light.png" alt="Title" id="img-title-light" onerror="this.style.display='none'"></div>
        <div class="screen black" id="cinema-title-desolation"><img src="visuals/title_desolation.png" alt="Desolation" id="img-title-desolation" onerror="this.style.display='none'"></div>
        <div class="screen black" id="cinema-title-full"><img src="visuals/title_full.png" alt="Full Title" id="img-title-full" onerror="this.style.display='none'"></div>
        <!-- Menu overlay: centered on top of title_full (hidden until intro ends) -->
        <div class="menu-overlay hidden" id="menu-overlay">
            <div class="menu-overlay-content">
                <div class="game-title">Desolation</div>
                <div class="game-subtitle">Tears of the Moon</div>
                <div class="menu-buttons">
                    <button class="menu-btn" id="btn-new-game">New Game</button>
                    <button class="menu-btn" id="btn-exhibition">Exhibition Match vs CPU</button>
                    <button class="menu-btn coming-soon" id="btn-multiplayer">Multiplayer (Coming Soon)</button>
                    <button class="menu-btn" id="btn-load-game">Load Game</button>
                    <button class="menu-btn" id="btn-options">Options</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROLOGUE (helicopter + story scenes after New Game) -->
    <div class="cinema" id="prologue-cinema" style="display:none;">
        <div class="screen black" id="prologue-screen" style="align-items:stretch; justify-content:stretch;">
            <img id="prologue-bg" src="" alt="" style="width:100%; height:100%; object-fit:cover;">
            <img id="prologue-overlay" src="" alt="" class="overlay-img" style="display:none;">
            <div id="prologue-extra" style="position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center; flex-wrap:wrap; gap:12px; padding:24px;"></div>
            <div class="dialog-box" id="prologue-dialog" style="display:none;">
                <div id="prologue-text"></div>
                <div class="next" id="prologue-next">[ Click or press key to continue ]</div>
            </div>
        </div>
    </div>

    <!-- OPTIONS (above cinema so it can overlay the menu) -->
    <div class="options-panel" id="options-panel">
        <h2>Options</h2>
        <p style="font-size:0.9em; color:rgba(200,190,210,0.9); margin-bottom:12px;">AUDIO SETTINGS</p>
        <div class="opt-row">
            <label><input type="checkbox" id="opt-day-night-cues" checked> Day/Night Cues (crickets/rooster)</label>
        </div>
        <div class="opt-row">
            <label><input type="checkbox" id="opt-music" checked> Music</label>
        </div>
        <div class="opt-row">
            <label><input type="checkbox" id="opt-sfx" checked> Sound Effects</label>
        </div>
        <div class="opt-row">
            <label><input type="checkbox" id="opt-ambient" checked> Ambient (rain/wind)</label>
        </div>
        <div class="opt-row">
            <label>In-game music:</label>
            <select id="opt-track-mode">
                <option value="one">One track (selected below)</option>
                <option value="all" selected>All tracks (random)</option>
                <option value="exception">All except exception list</option>
            </select>
        </div>
        <div class="opt-row">
            <label>Volume:</label>
            <input type="range" id="opt-volume" min="0" max="100" value="50" style="width:120px; accent-color:#9a8aaa;" title="In-game music volume (persisted)">
            <span id="opt-volume-value">50%</span>
        </div>
        <div class="opt-row">
            <label><input type="checkbox" id="opt-loop-track"> Loop current track</label>
        </div>
        <div class="opt-row">
            <label>Track (from tracks folder):</label>
            <select id="opt-track">
                <option value="afrobeats_track.mp3">Afrobeats</option>
                <option value="basketball_track.mp3">Basketball</option>
                <option value="beat_track.mp3">Beat</option>
                <option value="celtic_track.mp3">Celtic</option>
                <option value="chillhop_track.mp3">Chillhop</option>
                <option value="drill_track.mp3">Drill</option>
                <option value="dub_track.mp3">Dub</option>
                <option value="dystopian_siren_track.mp3">Dystopian Siren</option>
                <option value="ebunny-gothic_track.mp3">Ebunny Gothic</option>
                <option value="end_track.mp3">End</option>
                <option value="everywhere_track.mp3">Everywhere</option>
                <option value="flute_track.mp3">Flute</option>
                <option value="fusion_track.mp3">Fusion</option>
                <option value="future_track.mp3">Future</option>
                <option value="guitar_track.mp3">Guitar</option>
                <option value="house_techno_track.mp3">House Techno</option>
                <option value="house_track.mp3">House</option>
                <option value="lofidreams_track.mp3">Lofi Dreams</option>
                <option value="meditation_track.mp3">Meditation</option>
                <option value="motivation_track.mp3">Motivation</option>
                <option value="outrebirth_track.mp3">Outrebirth</option>
                <option value="rasta_track.mp3">Rasta</option>
                <option value="reggae_track.mp3">Reggae</option>
                <option value="survive_track.mp3">Survive</option>
                <option value="techno_track.mp3">Techno</option>
            </select>
        </div>
        <div class="opt-row">
            <button class="btn menu-btn" id="opt-play-track">Play selected</button>
        </div>
        <div class="opt-row" id="opt-exception-row" style="display:none;">
            <label>Exception list (track filenames to exclude, comma-separated):</label>
            <input type="text" id="opt-exception-list" placeholder="e.g. beat_track.mp3, techno_track.mp3" style="padding:8px; min-width:220px; background:#1a1525; color:#e8e0e8; border:1px solid rgba(140,120,160,0.4); border-radius:4px;">
        </div>
        <div class="opt-row">
            <button class="btn menu-btn btn-danger" id="opt-delete-save">Delete saved game</button>
        </div>
        <button class="menu-btn back-btn" id="opt-back">Back to main menu</button>
    </div>

    <div class="top-bar" id="top-bar" style="display: none;">
        <div class="time-display">
            <div class="time-item"><span id="time-display">Dawn — 6:00 AM</span></div>
            <div class="time-item"><span id="day-display">Day 1</span></div>
            <div class="time-item"><span id="weather-display">Clear</span></div>
        </div>
        <div class="speed-controls">
            <span style="margin-right: 6px;">Speed:</span>
            <button class="btn btn-small" id="btn-speed-1">1×</button>
            <button class="btn btn-small" id="btn-speed-2">2×</button>
            <button class="btn btn-small" id="btn-speed-4">4×</button>
        </div>
        <button class="btn btn-small" id="btn-music-toggle">Music: On</button>
        <button class="btn btn-small" id="btn-quit">Quit</button>
        <div class="moon-display">
            <div class="moon-icon" id="moon-icon"></div>
            <div>
                <div id="moon-phase">New Moon</div>
                <div id="moon-countdown">Full moon in 15 days</div>
            </div>
        </div>
    </div>

    <div class="game-container" id="game-container" style="display: none;">
        <div class="panel">
            <h3>Companion</h3>
            <div id="pet-card-container"></div>
        </div>

        <div class="panel center-panel">
            <div class="travel-row" id="travel-row">
                <span style="font-size:0.9em; margin-right:8px;">Travel:</span>
                <button class="btn btn-small" data-location="clearing">Clearing</button>
                <button class="btn btn-small" data-location="garden">Garden</button>
                <button class="btn btn-small" data-location="rabbit_farm">Rabbit Farm</button>
                <button class="btn btn-small" data-location="kennel">Kennel</button>
                <button class="btn btn-small" data-location="crafting">Crafting</button>
                <button class="btn btn-small" data-location="command_center">Command</button>
            </div>
            <div class="scene-display" id="scene-display">
                <div class="scene-bg" id="scene-bg"></div>
                <div class="scene-weather" id="scene-weather"></div>
                <div class="scene-loot-overlay" id="scene-loot-overlay"></div>
                <h2 class="scene-title" id="scene-title">The Clearing</h2>
                <div class="pet-visual" id="pet-visual">
                    <img class="cage-static" id="cage-static" src="" alt="Cage" style="display: none;">
                    <img class="pet-sprite" id="pet-sprite" src="" alt="Companion" style="display: none;">
                </div>
                <div class="location-visual" id="location-visual" style="display:none;"></div>
                <img id="training-dummy" src="" alt="Dummy" style="position:absolute; bottom:15%; right:18%; max-height:35%; object-fit:contain; display:none;">
                <img id="compost-bin" src="" alt="Compost" style="position:absolute; bottom:12%; right:10%; max-height:22%; object-fit:contain; display:none;">
                <div class="scene-loot-popup" id="scene-loot-popup" style="display:none;"></div>
                <img class="enemy-sprite" id="enemy-sprite" src="" alt="" style="display: none;">
            </div>
            <div id="tab-timers" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; font-size:0.8em; color:rgba(200,190,210,0.9);"></div>
            <div id="worker-status" class="worker-status-container assignment-info"></div>
            <div id="location-actions" class="action-grid location-actions-grid" style="margin-bottom:10px; min-height:0;"></div>
            <div id="action-buttons" class="action-grid" role="group" aria-label="Location actions"></div>
            <div id="while-wait-panel" style="display:none; margin-top:10px; padding:10px; background:rgba(0,0,0,0.4); border-radius:6px;">
                <h4 style="margin-bottom:8px; font-size:0.9em;">While you wait</h4>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                    <button class="btn btn-small" id="btn-observe">Observe</button>
                    <button class="btn btn-small" id="btn-inspect">Quick Inspect</button>
                    <button class="btn btn-small" id="btn-map">Map</button>
                </div>
                <div id="observe-progress-container" style="display:none; margin-top:8px;">
                    <div style="font-size:0.85em; margin-bottom:4px;">Observing... <span id="observe-secs">15</span>s</div>
                    <div style="height:6px; background:rgba(255,255,255,0.2); border-radius:3px; overflow:hidden;"><div id="observe-progress-bar" style="height:100%; width:100%; background:#7a8a9a; transition:width 0.3s;"></div></div>
                    <button class="btn btn-small" id="btn-cancel-observe" style="margin-top:4px;">Cancel</button>
                </div>
            </div>
            <div id="combat-log-container" style="display: none;">
                <h3>Combat</h3>
                <div class="combat-log" id="combat-log"></div>
            </div>
        </div>

        <div class="panel">
            <h3>Stats & Inventory</h3>
            <ul class="stat-list" id="stats-list"></ul>
            <div class="action-queue-section" id="action-queue-section">
                <h4 style="margin: 8px 0 4px; font-size: 0.9em;">Action queue</h4>
                <div id="action-queue-list" style="min-height: 24px; font-size: 0.85em; margin-bottom: 6px;"></div>
                <button class="btn btn-small" id="btn-clear-queue" style="width: 100%;">Clear queue</button>
            </div>
            <div class="inventory">
                <h4 style="margin-bottom: 8px; font-size: 0.9em;">Inventory</h4>
                <div id="inventory-list"></div>
            </div>
            <div class="reports-section">
                <button class="btn btn-small" id="btn-read-reports" style="width: 100%; margin-bottom: 6px;">Read reports</button>
                <button class="btn btn-small" id="btn-talk-staff" style="width: 100%; margin-bottom: 6px;">Talk to staff</button>
                <button class="btn btn-small" id="btn-minigames" style="width: 100%; margin-bottom: 8px;">Mini-games</button>
            </div>
            <div class="save-section">
                <button class="btn btn-small" id="btn-save" style="width: 100%;">Save Game</button>
                <button class="btn btn-small" id="btn-prev-track" style="width: 100%; margin-top: 6px;">Prev track</button>
                <button class="btn btn-small" id="btn-skip-track" style="width: 100%; margin-top: 6px;">Next track</button>
            </div>
            <div class="loot-popup-area" id="loot-popup"></div>
        </div>

        <div class="story-feed">
            <h3 style="margin-bottom: 8px;">Story</h3>
            <div id="story-feed"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // DESOLATION: TEARS OF THE MOON — Single-file edition
        // You're reading the source. The wolves approve. (They're always watching.)
        // ============================================================================
        //
        // FOR MODDERS & NOVICES — How to not get lost in the woods
        // --------------------------------------------------------
        // This whole game lives in ONE file: HTML at the top, CSS in <style>, then JavaScript.
        // To change something:
        //   • Game balance (hunger speed, stamina costs, etc.) → search for "CONFIG" below.
        //   • How long actions take (hunt, feed, repair) → search for "ACTION_SPECS".
        //   • What buttons appear where (Clearing vs Kennel) → search for "locActionIds" or "ACTION_LOCATION".
        //   • Story messages, worker names, achievement text → search for the word you see in-game.
        //   • Images and sounds → "V = 'visuals/'" is the image folder; sound files sit next to index.html.
        // Tips:
        //   • Use your editor's "Find" (Ctrl+F / Cmd+F) to jump to a section by its comment header.
        //   • Comment headers look like "// ========== SECTION NAME ==========" — scan for those.
        //   • If you break something, undo or restore from a backup. The wolves will understand.
        //
        // ============================================================================
        // GAME DESCRIPTION & FEATURES
        // ============================================================================
        // DESOLATION: TEARS OF THE MOON is a single-file HTML/JS management and survival game.
        // You are flown by helicopter to an isolated lab in a dense forest to run the facility
        // and care for the last remaining werewolf after an uprising. Tone is bleak and lightly
        // horror-tinged: manage staff, resources, and the wolf while dealing with fear, breakdowns,
        // and the implications of "releasing" workers.
        //
        // CORE FEATURES:
        // • Prologue: Cinematic intro (helicopter, cockpit view, briefing, lab arrival, command room,
        //   kennel, path preview, staff breakdown). Timed story cards; helicopter audio synced to departure.
        // • Command Center: Hub with command-room background, music on/off and Music options (track mode,
        //   track list, volume slider, loop current track), worker list, helicopter ETA and inbound line.
        // • Workers: Hire (5 plants + 3 materials, choose role); release (wolf hunger/thirst → 0 + creepy
        //   message); assign to Clearing, Garden, Kennel, Rabbit Farm, Crafting, or Command Center.
        //   Fear updates daily (wolf fear, escape, full moon ↑; bond > 60 and high security ↓). High fear
        //   (≥90): 5% quit chance, 3% incident (damage, injury, escape, sabotage); first-time critical warning.
        // • Location efficiency: No worker = 50% efficiency; with worker = 50% + 50% × (effective skill/100).
        //   Clearing ↔ Security; Kennel/Garden/Rabbit Farm ↔ Caretaking; Crafting ↔ (Cook+Maintenance)/2.
        //   Applied to harvest, forage, patrol/hunt loot, combat loot, cook/craft, kennel clean, rabbit care.
        // • Security level (0–100): +2 patrol, +1 hunt/repair, −15 escape. High security reduces worker fear.
        //   Shown in Command Center.
        // • Locations: Clearing (forage, patrol, hunt, traps), Garden (water, plant, harvest, compost),
        //   Rabbit Farm (feed/water/clean/treat/breed/harvest/capture), Kennel (wolf care, clean), Crafting
        //   (cook, craft medicine, traps/net/bait), Command Center (workers, hire, music, achievements).
        // • Wolf / Pack: Up to 6 werewolves (pack). Select one as active in Kennel; each has hunger, thirst, bond, fear,
        //   form, stamina, sleep, traits, abilities. Squad: pick up to 3 for hunt/patrol; mission uses squad leader
        //   for stamina; combat uses full squad (primary + allies give +10% damage each). Feed, water, heal, ritual,
        //   bond, rest, sleep. Escape risk when fear high and bond low; recapture via net on hunt/patrol.
        // • Breeding: Two adults, standard (20 food, 10 materials) or premium (40/20, choose gender + ability).
        //   Gestation 28 days; pup joins pack. Breed button disabled when pack full or breeding in progress.
        // • Encounters: After hunt/patrol 30% wild werewolf (net to capture; 15% net breaks on use). After forage
        //   30% wild rabbits (net to capture). Recapture escaped wolf: net required; always use 1, then 15% break.
        // • Combat: Traits (Aggressive +damage, Defensive −taken, Thinker crit chance, Shy flee at low HP),
        //   abilities (element + 20% proc bonus), element vs enemy (strong 1.5×, weak 0.75×). ENEMIES have element.
        // • Story log: Priority (low/medium/high/critical). Unavailable actions show "Cannot [action]: [reason]".
        // • Save/load (localStorage), action queues, day/night, moon phase, achievements, reports, mini-games.
        //   Music: volume slider and "Loop current track" persisted in options.
        // ============================================================================

        // Where the pretty pictures live. Change this only if you moved the "visuals" folder. Seriously.
        const V = 'visuals/';
        // Sound effects (bell, howlings, etc.) live in the same folder as index.html. No subfolder.
        function loadAudioMain(src) {
            const a = new Audio();
            a.preload = 'auto';
            a.src = src;
            return a;
        }

        // ============================================================================
        // INTRO CINEMA & AUDIO — The fancy opening (dev card, studio, title, howl)
        // Tweak: PROLOGUE_STEPS later controls the story slides; timing is in milliseconds.
        // ============================================================================
        function getAudioDurationMs(audio, fallbackSec) {
            const sec = (audio && !isNaN(audio.duration) && isFinite(audio.duration)) ? audio.duration : (fallbackSec || 3);
            return Math.round(sec * 1000) + 1000; // duration + 1 second
        }
        function showScreen(id) {
            document.querySelectorAll('.cinema .screen').forEach(el => { el.classList.remove('visible'); });
            const el = document.getElementById(id);
            if (el) el.classList.add('visible');
        }
        function showMenuOverlay() {
            showScreen('cinema-title-full');
            var overlay = document.getElementById('menu-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
            }
            var cont = document.getElementById('howl-continue');
            if (cont) cont.remove();
        }
        function hideCinema() {
            document.getElementById('cinema').classList.add('hidden');
            document.getElementById('cinema').style.display = 'none';
        }

        function runIntro() {
            const cinema = document.getElementById('cinema');
            if (!cinema) { showMenuOverlay(); return; }
            cinema.classList.remove('hidden');
            cinema.style.display = 'block';

            const bell = loadAudioMain('bell.mp3');
            const studioAudio = loadAudioMain('studio.mp3');
            const titleAudio = loadAudioMain('title.mp3');
            window._introTitleAudio = titleAudio;
            const howlings = loadAudioMain('howlings.mp3');
            const musicOn = () => document.getElementById('opt-music').checked;

            function next() {
                // 1) Fade in dev card, play bell, card stays visible for bell duration + 1s
                showScreen('cinema-dev');
                bell.play().catch(() => {});
                const bellMs = getAudioDurationMs(bell, 3);
                setTimeout(() => {
                    // 2) White screen, logo marquee flies in (no second bell)
                    showScreen('cinema-white');
                    document.getElementById('img-marquee').classList.add('logo-marquee');
                    setTimeout(() => {
                        // 3) Fade in studio card, logo flashes briefly then remains, play studio.mp3, stay duration+1s
                        showScreen('cinema-studio');
                        document.getElementById('img-studio').classList.add('flash');
                        setTimeout(() => document.getElementById('img-studio').classList.remove('flash'), 400);
                        studioAudio.play().catch(() => {});
                        const studioMs = getAudioDurationMs(studioAudio, 3);
                        setTimeout(() => {
                            showScreen('cinema-black');
                            if (musicOn()) { titleAudio.volume = 0; titleAudio.play().catch(() => {}); }
                            const fade = setInterval(() => {
                                if (titleAudio.volume < 0.9) titleAudio.volume += 0.05;
                                else clearInterval(fade);
                            }, 80);
                            setTimeout(() => {
                                const flash = (screenId, nextScreenId, delay) => {
                                    showScreen(screenId);
                                    const img = document.querySelector('#' + screenId + ' img');
                                    if (img) { img.classList.add('flash'); setTimeout(() => img.classList.remove('flash'), 400); }
                                    setTimeout(() => {
                                        if (nextScreenId) showScreen(nextScreenId);
                                    }, delay || 800);
                                };
                                flash('cinema-title-dark', null, 800);
                                setTimeout(() => flash('cinema-title-light', null, 800), 900);
                                setTimeout(() => flash('cinema-title-dark', null, 800), 1800);
                                setTimeout(() => flash('cinema-title-desolation', null, 800), 2700);
                                setTimeout(() => flash('cinema-title-full', null, 800), 3600);
                                setTimeout(() => {
                                    if (musicOn()) { howlings.play().catch(() => {}); }
                                    const howlMs = Math.min(getAudioDurationMs(howlings, 4), 8000);
                                    var howlDone = false;
                                    function goToMenu() {
                                        if (howlDone) return;
                                        howlDone = true;
                                        showMenuOverlay();
                                    }
                                    var contBtn = document.createElement('button');
                                    contBtn.className = 'menu-btn howl-continue';
                                    contBtn.id = 'howl-continue';
                                    contBtn.textContent = 'Click to continue';
                                    contBtn.type = 'button';
                                    contBtn.addEventListener('click', goToMenu);
                                    document.getElementById('cinema').appendChild(contBtn);
                                    setTimeout(goToMenu, howlMs);
                                }, 4500);
                            }, 600);
                        }, studioMs);
                    }, 1500);
                }, bellMs);
            }

            bell.addEventListener('loadedmetadata', () => next(), { once: true });
            bell.addEventListener('error', () => setTimeout(next, 4000));
            if (bell.readyState >= 1) next();
            else bell.load();
        }

        // ============================================================================
        // MAIN MENU & OPTIONS
        // ============================================================================
        document.getElementById('btn-options').addEventListener('click', () => {
            document.getElementById('options-panel').classList.add('visible');
        });
        document.getElementById('opt-back').addEventListener('click', () => {
            document.getElementById('options-panel').classList.remove('visible');
        });
        document.getElementById('opt-track-mode').addEventListener('change', () => {
            document.getElementById('opt-exception-row').style.display =
                document.getElementById('opt-track-mode').value === 'exception' ? 'flex' : 'none';
        });
        document.getElementById('opt-play-track').addEventListener('click', () => {
            const src = 'tracks/' + document.getElementById('opt-track').value;
            const a = new Audio(src);
            a.play().catch(function(e) { console.warn('Play failed:', e); });
        });
        try {
            const exc = localStorage.getItem('desolation_music_exception');
            if (exc) document.getElementById('opt-exception-list').value = exc;
            var v = localStorage.getItem('desolation_volume');
            if (v != null) { var vol = Math.max(0, Math.min(100, parseInt(v, 10))); document.getElementById('opt-volume').value = vol; document.getElementById('opt-volume-value').textContent = vol + '%'; }
            var loop = localStorage.getItem('desolation_loop_track');
            if (loop != null) document.getElementById('opt-loop-track').checked = loop === '1';
        } catch (e) {}
        document.getElementById('opt-exception-list').addEventListener('change', function() {
            try { localStorage.setItem('desolation_music_exception', this.value); } catch (e) {}
        });
        document.getElementById('opt-volume').addEventListener('input', function() {
            var val = Math.max(0, Math.min(100, parseInt(this.value, 10) || 50));
            document.getElementById('opt-volume-value').textContent = val + '%';
            try { localStorage.setItem('desolation_volume', String(val)); } catch (e) {}
            if (typeof gameMusicAudio !== 'undefined' && gameMusicAudio) gameMusicAudio.volume = val / 100;
        });
        document.getElementById('opt-loop-track').addEventListener('change', function() {
            try { localStorage.setItem('desolation_loop_track', this.checked ? '1' : '0'); } catch (e) {}
        });
        document.getElementById('opt-delete-save').addEventListener('click', () => {
            if (confirm('Permanently delete the saved game?')) {
                localStorage.removeItem('desolation_save');
                alert('Save deleted.');
            }
        });

        // ============================================================================
        // PROLOGUE — The story before the story (helicopter, staff, path, kennel)
        // Each step: t = ms before auto-advance (0 = click to continue), bg = background image, dialog = text.
        // Add or remove steps here to change the intro. Images go in the "visuals" folder.
        // ============================================================================
        const PROLOGUE_STEPS = [
            { t: 6000, bg: V + 'helicopter_profile.png', overlay: null, dialog: null },
            { t: 9000, bg: V + 'helicopter_view.png', overlay: null, dialog: 'Looking out from the cockpit, all you see is a dense sea of forest stretching to the horizon. No signs of civilization. No lights. No roads. Just trees.' },
            { t: 10000, bg: V + 'cockpit.png', overlay: null, dialog: 'Pilot: "Approaching the site. The last subject is still contained. Cage is damaged—you\'ll need to repair it."' },
            { t: 6000, bg: V + 'forest.png', overlay: V + 'helicopter_top.png', dialog: null },
            { t: 9000, bg: V + 'cockpit.png', overlay: null, dialog: 'You review the briefing. One werewolf remains. The rest escaped or were lost in the uprising.' },
            { t: 5500, bg: V + 'forest.png', overlay: V + 'helicopter_top.png', dialog: null },
            { t: 5500, bg: V + 'far_clearing.png', overlay: V + 'helicopter_top.png', dialog: null },
            { t: 5000, bg: V + 'clearing_lab.PNG', overlay: V + 'helicopter_top.png', dialog: null },
            { t: 8000, bg: V + 'lab_helicopter.png', overlay: null, dialog: 'The lab comes into view. Your new post.' },
            { t: 0, bg: V + 'clearing_lab.PNG', overlay: V + 'helicopter_profile.png', ascend: true, dialog: 'The helicopter departs. You are alone with the facility.', noAutoAdvance: true },
            { t: 0, bg: V + 'command_room.png', overlay: null, dialog: 'Command room. Meet the staff and receive your orders.', noAutoAdvance: true, staffFlyIn: [V + 'cook.PNG', V + 'commander.PNG', V + 'doctor.PNG', V + 'security.PNG', V + 'repair_man.PNG'] },
            { t: 0, bg: V + 'dirty_cage.png', overlay: null, dialog: 'Kennel. The last werewolf\'s cage is damaged. Learn basic crafting and how to interact with your ward.', noAutoAdvance: true },
            { t: 0, bg: V + 'path_daytime.png', overlay: null, dialog: 'The path. Explore, fight, gather materials—then return to the lab.', pathItems: [V + 'vines.PNG', V + 'wanderer.PNG', V + 'wood_bundle.PNG', V + 'water_canteen.PNG', V + 'seeds.PNG', V + 'veggie_basket.PNG', V + 'farm_crop.PNG', V + 'ghoul.PNG', V + 'mangy_wolf.png'] },
            { t: 0, bg: V + 'clean_cage.png', overlay: null, dialog: 'Back at the kennel. Finish repairs.' },
            { t: 0, bg: V + 'farm_and_rabbits.PNG', overlay: null, dialog: 'Set up farm and rabbit house.' },
            { t: 0, bg: V + 'service_room_off.PNG', overlay: null, dialog: 'Event: The service room goes down. Power fails. Learn about events and how to resolve them—call the repair crew.', repairManFlash: true },
            { t: 0, bg: V + 'breakdown.png', overlay: null, dialog: 'A staff member has a breakdown and flees into the forest. Import another worker via helicopter drop. Workers cost food and wood.' },
        ];
        let prologueIndex = 0;
        let helicopterAudio = null;
        let prologueExtraTimers = [];

        function runPrologue(callback) {
            var advanceTimer = null;
            const prologueCinema = document.getElementById('prologue-cinema');
            const prologueScreen = document.getElementById('prologue-screen');
            const prologueBg = document.getElementById('prologue-bg');
            const prologueOverlay = document.getElementById('prologue-overlay');
            const prologueDialog = document.getElementById('prologue-dialog');
            const prologueText = document.getElementById('prologue-text');
            const prologueNext = document.getElementById('prologue-next');
            const prologueExtra = document.getElementById('prologue-extra');
            prologueCinema.style.display = 'block';
            prologueCinema.classList.remove('hidden');
            prologueScreen.classList.add('visible');

            helicopterAudio = loadAudioMain('helicopter.mp3');
            helicopterAudio.loop = true;
            helicopterAudio.volume = 0.4;
            if (window._introTitleAudio) { window._introTitleAudio.pause(); window._introTitleAudio.currentTime = 0; }
            // Option B: Audio starts first, then 0.5s later visual fades in for dramatic effect
            if (helicopterAudio) helicopterAudio.play().catch(() => {});

            function setScene(step) {
                while (prologueExtraTimers.length) clearTimeout(prologueExtraTimers.pop());
                if (prologueExtra) prologueExtra.innerHTML = '';
                prologueExtra.style.display = 'none';

                if (step.ascend) {
                    prologueOverlay.style.display = 'block';
                    prologueOverlay.src = step.overlay || '';
                    prologueOverlay.classList.add('heli-ascend');
                    if (helicopterAudio) {
                        setTimeout(function() {
                            var fadeOut = setInterval(function() {
                                helicopterAudio.volume = Math.max(0, helicopterAudio.volume - 0.05);
                                if (helicopterAudio.volume <= 0) {
                                    clearInterval(fadeOut);
                                    helicopterAudio.pause();
                                }
                            }, 80);
                        }, 4000);
                    }
                } else {
                    prologueOverlay.classList.remove('heli-ascend');
                    prologueOverlay.style.display = step.overlay ? 'block' : 'none';
                    prologueOverlay.src = step.overlay || '';
                }
                prologueBg.src = step.bg || '';
                prologueBg.style.display = step.bg ? 'block' : 'none';
                if (prologueIndex === 0 && step.bg) {
                    prologueBg.classList.add('prologue-fade-in');
                } else {
                    prologueBg.classList.remove('prologue-fade-in');
                }
                if (step.dialog) {
                    prologueDialog.style.display = 'block';
                    prologueText.textContent = step.dialog;
                } else {
                    prologueDialog.style.display = 'block';
                    prologueText.textContent = '';
                }
                prologueNext.style.visibility = 'visible';
                prologueNext.textContent = '[ Continue ]';

                if (step.repairManFlash && prologueExtra) {
                    prologueExtra.style.display = 'flex';
                    prologueExtra.style.alignItems = 'flex-end';
                    prologueExtra.style.justifyContent = 'flex-start';
                    prologueExtra.style.padding = '24px 24px 120px 24px';
                    var repairImg = document.createElement('img');
                    repairImg.src = V + 'repair_man.PNG';
                    repairImg.alt = 'Repair';
                    repairImg.style.cssText = 'width:120px; height:auto; opacity:1; transition:opacity 0.3s;';
                    prologueExtra.appendChild(repairImg);
                    var count = 0;
                    function flashRepair() {
                        repairImg.style.opacity = repairImg.style.opacity === '0' ? '1' : '0';
                        count++;
                        if (count < 8) prologueExtraTimers.push(setTimeout(flashRepair, 500));
                    }
                    prologueExtraTimers.push(setTimeout(flashRepair, 500));
                }
                if (step.pathItems && step.pathItems.length && prologueExtra) {
                    prologueExtra.style.display = 'flex';
                    prologueExtra.style.alignItems = 'center';
                    prologueExtra.style.justifyContent = 'center';
                    var idx = 0;
                    function showPathItem() {
                        prologueExtra.innerHTML = '';
                        var img = document.createElement('img');
                        img.src = step.pathItems[idx];
                        img.alt = '';
                        img.style.cssText = 'max-width:100px; max-height:100px; object-fit:contain;';
                        prologueExtra.appendChild(img);
                        idx++;
                        if (idx < step.pathItems.length) {
                            prologueExtraTimers.push(setTimeout(showPathItem, 1500));
                        } else {
                            prologueExtraTimers.push(setTimeout(function() { prologueExtra.innerHTML = ''; }, 2000));
                        }
                    }
                    showPathItem();
                }
                if (step.staffFlyIn && step.staffFlyIn.length && prologueExtra) {
                    prologueExtra.style.display = 'flex';
                    prologueExtra.style.alignItems = 'center';
                    prologueExtra.style.justifyContent = 'center';
                    prologueExtra.style.gap = '32px';
                    prologueExtra.style.paddingBottom = '0';
                    step.staffFlyIn.forEach(function(src, i) {
                        var im = document.createElement('img');
                        im.src = src;
                        im.alt = '';
                        im.style.cssText = 'width:64px; height:64px; object-fit:contain; opacity:0; transform:translateY(20px); transition:opacity 0.5s, transform 0.5s;';
                        prologueExtra.appendChild(im);
                        prologueExtraTimers.push(setTimeout(function() {
                            im.style.opacity = '1';
                            im.style.transform = 'translateY(0)';
                        }, 200 + i * 150));
                    });
                }
            }
            function advance() {
                prologueIndex++;
                if (prologueIndex >= PROLOGUE_STEPS.length) {
                    if (helicopterAudio) helicopterAudio.pause();
                    prologueCinema.style.display = 'none';
                    prologueCinema.classList.add('hidden');
                    prologueIndex = 0;
                    if (callback) callback();
                    return;
                }
                const step = PROLOGUE_STEPS[prologueIndex];
                setScene(step);
                if (advanceTimer) clearTimeout(advanceTimer);
                if (step.t > 0 && !step.noAutoAdvance) advanceTimer = setTimeout(advance, step.t);
            }
            prologueNext.onclick = () => {
                const step = PROLOGUE_STEPS[prologueIndex];
                if (step.t === 0) advance();
            };
            document.addEventListener('keydown', function keyProg(e) {
                if (e.key !== ' ' && e.key !== 'Enter') return;
                if (!prologueCinema.classList.contains('hidden') && prologueCinema.style.display !== 'none') {
                    e.preventDefault();
                    const step = PROLOGUE_STEPS[prologueIndex];
                    if (step.t === 0) advance();
                }
            });

            prologueIndex = 0;
            // Delay visual 0.5s after audio so helicopter sound leads the shot
            setTimeout(function() {
                setScene(PROLOGUE_STEPS[0]);
                if (PROLOGUE_STEPS[0].t > 0) setTimeout(advance, PROLOGUE_STEPS[0].t);
            }, 500);
        }

        var gameMusicAudio = null;
        var trackPlayedSet = {};
        var trackHistory = [];
        function pickNextTrackFromJar() {
            var list = [];
            document.querySelectorAll('#opt-track option').forEach(function(o) { list.push(o.value); });
            if (!list.length) return null;
            var available = list.filter(function(t) { return !trackPlayedSet[t]; });
            if (available.length === 0) { trackPlayedSet = {}; available = list; }
            var track = available[Math.floor(Math.random() * available.length)];
            trackPlayedSet[track] = true;
            return track;
        }
        function skipToNextTrack() {
            if (!document.getElementById('opt-music').checked) return;
            var track = pickNextTrackFromJar();
            if (!track) return;
            if (gameMusicAudio) {
                gameMusicAudio.src = 'tracks/' + track;
                gameMusicAudio.currentTime = 0;
                gameMusicAudio.play().catch(function() {});
            } else {
                startInGameMusic();
            }
            trackHistory.push(track);
        }
        function skipToPrevTrack() {
            if (!document.getElementById('opt-music').checked) return;
            if (trackHistory.length < 2) return;
            trackHistory.pop();
            var prev = trackHistory[trackHistory.length - 1];
            if (gameMusicAudio && prev) {
                gameMusicAudio.src = 'tracks/' + prev;
                gameMusicAudio.currentTime = 0;
                gameMusicAudio.play().catch(function() {});
            }
        }
        function getMusicVolume() {
            var el = document.getElementById('opt-volume');
            return el ? Math.max(0, Math.min(1, (parseInt(el.value, 10) || 50) / 100)) : 0.5;
        }
        function getLoopCurrentTrack() {
            var el = document.getElementById('opt-loop-track');
            return el ? el.checked : false;
        }
        function startInGameMusic() {
            if (!document.getElementById('opt-music') || !document.getElementById('opt-music').checked) return;
            if (gameMusicAudio) { gameMusicAudio.pause(); gameMusicAudio = null; }
            var mode = document.getElementById('opt-track-mode').value;
            var track = document.getElementById('opt-track').value;
            var list = [];
            document.querySelectorAll('#opt-track option').forEach(function(o) { list.push(o.value); });
            var vol = getMusicVolume();
            var loopCurrent = getLoopCurrentTrack();
            if (mode === 'one' && track) {
                gameMusicAudio = new Audio('tracks/' + track);
                gameMusicAudio.loop = loopCurrent;
                gameMusicAudio.volume = vol;
                gameMusicAudio.play().catch(function() {});
                trackHistory = [track];
            } else if (list.length) {
                track = pickNextTrackFromJar();
                if (track) {
                    gameMusicAudio = new Audio('tracks/' + track);
                    gameMusicAudio.volume = vol;
                    gameMusicAudio.play().catch(function() {});
                    trackHistory = [track];
                    gameMusicAudio.addEventListener('ended', function next() {
                        if (!document.getElementById('opt-music').checked) return;
                        if (getLoopCurrentTrack() && trackHistory.length) {
                            var same = trackHistory[trackHistory.length - 1];
                            gameMusicAudio.src = 'tracks/' + same;
                            gameMusicAudio.currentTime = 0;
                            gameMusicAudio.play().catch(function() {});
                        } else {
                            track = pickNextTrackFromJar();
                            if (track) {
                                gameMusicAudio.src = 'tracks/' + track;
                                gameMusicAudio.play().catch(function() {});
                                trackHistory.push(track);
                            }
                        }
                    }, { once: false });
                }
            }
        }

        // Creates a fresh game state, shows the game screen, starts the music and the main loop.
        // The tick runs every 250ms: finishes due actions, advances time, re-renders. Auto-save every 2 minutes.
        function startGame() {
            document.body.style.background = '#0c0a0f';
            hideCinema();
            document.getElementById('prologue-cinema').style.display = 'none';
            gameState = createGameState();
            storyLog.length = 0;
            addStory('In the desolate borderlands, you found one who still answers to the moon. Together you endure.');
            document.getElementById('top-bar').style.display = 'flex';
            document.getElementById('game-container').style.display = 'grid';
            startInGameMusic();
            render();
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            autoSaveInterval = setInterval(function() {
                if (gameState && document.getElementById('game-container').style.display === 'grid') {
                    try {
                        var data = JSON.stringify({ state: gameState, story: storyLog.slice(0, 15) });
                        localStorage.setItem('desolation_save', data);
                    } catch (e) {}
                }
            }, 120000);  // Auto-save every 2 minutes.
            if (gameTickInterval) clearInterval(gameTickInterval);
            var tickMs = 250;  // Main loop: every 250ms we check queues (finish actions), advance time, and render.
            gameTickInterval = setInterval(function() {
                if (!gameState || document.getElementById('game-container').style.display !== 'grid') return;
                var now = Date.now();
                ['clearing', 'garden', 'kennel', 'rabbit_farm', 'crafting'].forEach(function(locId) {
                    var queue = getQueueForLoc(gameState, locId);
                    if (queue.length && queue[0].busyUntil != null && queue[0].busyUntil <= now) {
                        var slot = queue.shift();
                        executeAction(gameState, slot.id, addStory, locId);
                        var q = getQueueForLoc(gameState, locId);
                        if (q.length && q[0].busyUntil == null) {
                            var sp = ACTION_SPECS[q[0].id];
                            var ms = sp ? (sp.realSec * 1000) / (gameSpeed || 1) : 5000;
                            q[0].busyUntil = Date.now() + ms;
                            q[0].gameMin = sp ? sp.gameMin : 30;
                            if (['cook', 'craft_medicine', 'cook_plants'].indexOf(q[0].id) >= 0) gameState.grillOn = true;
                        }
                    }
                });
                gameState._addStory = addStory;
                advanceTime(gameState, 0.25 * (gameSpeed || 1));
                if (gameState && Date.now() - (gameState._lastFlavorBlurb || 0) >= 60000) { checkFlavorBlurb(gameState); gameState._lastFlavorBlurb = Date.now(); }
                render();
            }, tickMs);
        }

        // ============================================================================
        // CONFIG — The main dials. Change these to rebalance the game without hunting through code.
        // dayLengthMinutes: one in-game day in minutes (1440 = 24h). shiftThresholds: when the wolf
        // flips form (human/hybrid/wolf). lifeStageDays: when a pup becomes adult, etc.
        // sleepDecayPerMin / staminaRegenPerMin: how fast bars drain or refill. Have fun.
        // ============================================================================
        const CONFIG = {
            dayLengthMinutes: 1440,
            realMsPerGameMinute: 1000,
            shiftThresholds: { human: 30, hybrid: 70, wolf: 100 },
            xpToNextBase: 100,
            statPointsPerLevel: 2,
            combatLogDelayMs: 2000,
            lifeStageDays: { pup: 30, adult: 180 },
            sleepDecayPerMin: 0.015,
            staminaRegenPerMin: 0.06,
            staminaRegenSleepBonus: 0.12,
            // Pack & squad (Tier 1)
            MAX_PACK_SIZE: 6,
            MAX_SQUAD_SIZE: 3,
            // Encounters (Tier 2)
            WEREWOLF_ENCOUNTER_CHANCE: 0.3,
            RABBIT_ENCOUNTER_CHANCE: 0.3,
            CAPTURE_BONUS_WITH_RABBITS: 0.1,
            // Breeding (Tier 8–9)
            GESTATION_DAYS: 28,
            BREEDING_FOOD_COST: 20,
            BREEDING_MATERIALS_COST: 10,
            PREMIUM_FOOD_COST: 40,
            PREMIUM_MATERIALS_COST: 20,
        };
        // Which location each action belongs to. Add a new action? Add it here and to ACTION_SPECS.
        const ACTION_LOCATION = { rest: 'clearing', bond: 'kennel', train: 'clearing', feed: 'kennel', feed_raw_meat: 'kennel', feed_plants: 'kennel', feed_cooked_meat: 'kennel', feed_cooked_plants: 'kennel', water: 'kennel', heal: 'kennel', ritual: 'kennel', sleep: 'kennel', forage: 'clearing', patrol: 'clearing', hunt: 'clearing', clean_kennels: 'kennel', water_garden: 'garden', plant: 'garden', harvest: 'garden', add_compost: 'garden', feed_rabbit: 'rabbit_farm', water_rabbit: 'rabbit_farm', clean_rabbit: 'rabbit_farm', treat_rabbit: 'rabbit_farm', harvest_rabbit: 'rabbit_farm', breed_rabbit: 'rabbit_farm', cook: 'crafting', craft_medicine: 'crafting', cook_plants: 'crafting', capture_rabbit: 'rabbit_farm', hike_creek: 'clearing', collect_rain: 'garden', craft_rain_catcher: 'crafting', repair_clearing: 'clearing', repair_kennel: 'kennel', repair_garden: 'garden', repair_rabbit_farm: 'rabbit_farm', repair_crafting: 'crafting', set_rabbit_traps: 'clearing', check_traps: 'clearing', craft_rabbit_trap: 'crafting', craft_net: 'crafting', craft_bait: 'crafting', craft_premium_bait: 'crafting' };
        // How much stamina each action costs. Want hunt to be exhausting? Crank it up.
        const STAMINA_COST = { hunt: 25, patrol: 20, forage: 20, train: 15, hike_creek: 15, bond: 5 };
        // realSec = how many real-world seconds the action takes. gameMin = in-game minutes that pass.
        // instant: true = no timer (runs immediately, e.g. forage/hunt/patrol start then finish after realSec).
        const ACTION_SPECS = {
            rest: { realSec: 60, gameMin: 60 },
            bond: { realSec: 30, gameMin: 30 },
            train: { realSec: 60, gameMin: 60 },
            sleep: { realSec: 90, gameMin: 90 },
            feed: { realSec: 30, gameMin: 30 },
            feed_raw_meat: { realSec: 30, gameMin: 30 },
            feed_plants: { realSec: 30, gameMin: 30 },
            feed_cooked_meat: { realSec: 30, gameMin: 30 },
            feed_cooked_plants: { realSec: 30, gameMin: 30 },
            water: { realSec: 20, gameMin: 20 },
            heal: { realSec: 60, gameMin: 60 },
            ritual: { realSec: 30, gameMin: 30 },
            forage: { realSec: 120, gameMin: 120, instant: true },
            patrol: { realSec: 120, gameMin: 120, instant: true },
            hunt: { realSec: 240, gameMin: 240, instant: true },
            clean_kennels: { realSec: 60, gameMin: 60 },
            water_garden: { realSec: 30, gameMin: 30 },
            plant: { realSec: 45, gameMin: 45 },
            harvest: { realSec: 30, gameMin: 30 },
            add_compost: { realSec: 20, gameMin: 20 },
            feed_rabbit: { realSec: 20, gameMin: 20 },
            water_rabbit: { realSec: 20, gameMin: 20 },
            clean_rabbit: { realSec: 40, gameMin: 40 },
            treat_rabbit: { realSec: 30, gameMin: 30 },
            cook: { realSec: 60, gameMin: 60 },
            craft_medicine: { realSec: 45, gameMin: 45 },
            cook_plants: { realSec: 45, gameMin: 45 },
            capture_rabbit: { realSec: 30, gameMin: 30 },
            harvest_rabbit: { realSec: 20, gameMin: 20 },
            breed_rabbit: { realSec: 60, gameMin: 120 },
            // Rabbit trap: set = instant, queues check_traps (~2 min). Craft trap/net/bait in Crafting.
            set_rabbit_traps: { instant: true },
            check_traps: { realSec: 60, gameMin: 120 },
            craft_rabbit_trap: { realSec: 30, gameMin: 30 },
            craft_net: { realSec: 45, gameMin: 45 },
            craft_bait: { realSec: 15, gameMin: 15 },
            craft_premium_bait: { realSec: 30, gameMin: 30 },
            hike_creek: { realSec: 120, gameMin: 60 },
            collect_rain: { realSec: 45, gameMin: 30 },
            craft_rain_catcher: { realSec: 90, gameMin: 60 },
            repair_clearing: { realSec: 45, gameMin: 30 },
            repair_kennel: { realSec: 45, gameMin: 30 },
            repair_garden: { realSec: 30, gameMin: 20 },
            repair_rabbit_farm: { realSec: 30, gameMin: 20 },
            repair_crafting: { realSec: 45, gameMin: 30 },
        };
        // Materials needed per location to repair. Change numbers to make repairs cheaper or pricier.
        var REPAIR_COST = { clearing: 2, kennel: 2, garden: 1, rabbit_farm: 1, crafting: 2 };
        var gameSpeed = 1;  // 1 = normal. 2 = double speed. Set by the speed buttons in the top bar.

        // Every place the player can travel to. id = internal name, title = display name, bg = default background image.
        const LOCATIONS = [
            { id: 'clearing', title: 'The Clearing', bg: 'clearing_lab.PNG', bgNight: 'clearing_lab_nightime.png', showPet: true },
            { id: 'garden', title: 'Garden', bg: 'farm_soil.PNG', bgNight: 'farm_soil.PNG', showPet: false },
            { id: 'rabbit_farm', title: 'Rabbit Farm', bg: 'empty_rabbit_cage.PNG', bgNight: 'empty_rabbit_cage.PNG', showPet: false },
            { id: 'kennel', title: 'Kennel', bg: 'dirty_cage.png', bgNight: 'dirty_cage.png', showPet: true },
            { id: 'crafting', title: 'Crafting & Grill', bg: 'grill_off.PNG', bgNight: 'grill_off.PNG', showPet: false },
            { id: 'command_center', title: 'Command Center', bg: 'command_center.PNG', bgNight: 'command_center.PNG', showPet: false },
        ];
        // The crew at Command Center. lore = what they say when you "Talk to staff". Add more entries to expand the cast.
        const STAFF = [
            { id: 'medic', name: 'Dr. Vale', role: 'Doctor', img: 'staff_medic.png', lore: 'I used to work in the city. Here, we make do. The wolves are patients, not specimens. Sometimes I wonder who\'s really in the cage.' },
            { id: 'guard', name: 'Commander Reed', role: 'Security', img: 'staff_guard.png', lore: 'Perimeter\'s holding. The things out there don\'t care about borders. We lost good people before you came. Don\'t add to the count.' },
            { id: 'caretaker', name: 'Mira', role: 'Caretaker', img: 'staff_caretaker.png', lore: 'They remember kindness. I\'ve seen it. One of them—Luna—she still looks at me like she knows. Clean the kennels, talk to them. It matters.' },
            { id: 'cook', name: 'Mike', role: 'Cook', img: 'cook.PNG', lore: 'I cook what they give me. You don\'t want to know where some of it comes from. The wolves get the good cuts. Protocol.' },
            { id: 'repair', name: 'Tom', role: 'Repair Man', img: 'repair_man.PNG', lore: 'I fix what breaks. Cages, equipment, morale. You\'d be surprised how often it\'s the last one.' },
            { id: 'janitor', name: 'Janitor', role: 'Janitor', img: 'commander.PNG', lore: ['I clean up messes. All kinds of messes.', 'The researcher stays late. Always writing notes. Never lets me clean his office.', 'I found a tunnel in the basement. Don\'t tell the commander.', 'The wolves... they watch me. All of them. At the same time.'] },
            { id: 'researcher', name: 'Researcher', role: 'Researcher', img: 'doctor.PNG', lore: ['The data suggests... wait, did you hear that?', 'The janitor keeps finding things he shouldn\'t. I\'ve seen him talking to them.', 'My notes say the full moon affects... everything. Including us.', 'Have you noticed the security guard hasn\'t blinked in three days?'] },
            { id: 'trainer', name: 'Trainer', role: 'Trainer', img: 'security.PNG', lore: 'They can learn. I\'ve seen it. They\'re smarter than we think. Sometimes I think they\'re just waiting for the right moment.' },
            { id: 'cook_assistant', name: 'Cook\'s Assistant', role: 'Cook\'s Assistant', img: 'cook.PNG', lore: 'I just chop vegetables. I don\'t want to know what happens to the meat.' },
        ];

        // Moon phases drive the wolf's form and mood. full = spooky time.
        const MOON_PHASES = ['new', 'waxing_crescent', 'first_quarter', 'waxing_gibbous', 'full', 'waning_gibbous', 'last_quarter', 'waning_crescent'];
        const MOON_NAMES = { new: 'New Moon', waxing_crescent: 'Waxing Crescent', first_quarter: 'First Quarter', waxing_gibbous: 'Waxing Gibbous', full: 'Full Moon', waning_gibbous: 'Waning Gibbous', last_quarter: 'Last Quarter', waning_crescent: 'Waning Crescent' };

        // Achievements: id = internal key, name = what the player sees, check = function(state) that returns true when unlocked.
        // Add new ones here and give them an id, name, xp, optional item, and a check function.
        var ACHIEVEMENTS = [
            { id: 'rain_man', name: 'Rain Man', xp: 50, item: { type: 'water', qty: 3 }, check: function(s) { return s.rainCatcherBuilt; } },
            { id: 'dammit_jim', name: 'Dammit Jim! I\'m a Gamer, Not a Doctor!', xp: 50, item: { type: 'herbs', qty: 1 }, check: function(s) { return (s.stats && s.stats.medsCrafted >= 1) || (s.inventory && s.inventory.meds > 0); } },
            { id: 'full_moon_party', name: 'Full Moon Party', xp: 100, item: { type: 'materials', qty: 1 }, check: function(s) { return s.flags && s.flags.survivedFullMoon; } },
            { id: 'green_thumb', name: 'Green Thumb', xp: 100, item: { type: 'seeds', qty: 2 }, check: function(s) { return (s.stats && s.stats.cropsHarvested) >= 50; } },
            { id: 'rabbit_hoarder', name: 'Rabbit Hoarder', xp: 150, item: { type: 'materials', qty: 1 }, check: function(s) { return (s.stats && s.stats.rabbitsCaptured) >= 10; } },
            { id: 'bond_villain', name: 'Bond Villain', xp: 100, item: { type: 'meds', qty: 1 }, check: function(s) { return s.pet && (s.pet.bond || 0) >= 100; } },
            { id: 'fear_itself', name: 'Fear Itself', xp: 75, item: { type: 'herbs', qty: 1 }, check: function(s) { return s.pet && (s.pet.fear || 100) <= 0; } },
            { id: 'escape_artist', name: 'Escape Artist', xp: 25, item: { type: 'materials', qty: 1 }, check: function(s) { return s.flags && s.flags.hadEscape; } },
            { id: 'meat_master', name: 'Meat Master', xp: 100, item: { type: 'rawMeat', qty: 1 }, check: function(s) { return (s.stats && s.stats.rabbitsHarvested) >= 20; } },
            { id: 'shift_manager', name: 'Shift Manager', xp: 50, item: { type: 'herbs', qty: 1 }, check: function(s) { return (s.stats && s.stats.transformationsWitnessed) >= 10; } },
            { id: 'night_owls', name: 'Night Owls', xp: 50, item: { type: 'materials', qty: 1 }, check: function(s) { return (s.stats && s.stats.nightActions) >= 10; } },
            { id: 'early_birds', name: 'Early Birds', xp: 50, item: { type: 'plants', qty: 1 }, check: function(s) { return (s.stats && s.stats.dawnActions) >= 10; } },
            { id: 'dull_boy', name: 'Dull Boy', xp: 100, item: { type: 'seeds', qty: 2 }, check: function(s) { var r = s.reportsSectionsRead || {}; return r.A && r.B && r.C && r.D && r.E; } },
            { id: 'rabid_routine', name: 'Rabid Routine', xp: 50, item: { type: 'plants', qty: 2 }, check: function(s) { return (s.consecutiveDaysRabbitFed || 0) >= 3; } },
            { id: 'calm_wolf', name: 'A Calm Wolf is Still a Wolf', xp: 100, item: { type: 'meds', qty: 1 }, check: function(s) { return (s.consecutiveDaysWolfFed || 0) >= 3; } },
            { id: 'old_mac', name: 'An Old Mac is Still a Mac', xp: 50, item: { type: 'seeds', qty: 2 }, check: function(s) { return (s.consecutiveDaysGardenTended || 0) >= 3; } },
            { id: 'you_bait', name: 'You Bait', xp: 25, item: { type: 'plants', qty: 1 }, check: function(s) { return (s.stats && s.stats.plantsCooked) >= 1; } },
        ];
        // Pop! You did a thing. Here's some XP and maybe an item. The wolves are mildly impressed.
        function checkAchievement(state, id, addStory) {
            if (!state.achievements) state.achievements = {};
            if (state.achievements[id]) return;
            var ach = ACHIEVEMENTS.filter(function(a) { return a.id === id; })[0];
            if (!ach || !ach.check(state)) return;
            state.achievements[id] = true;
            state.playerXP = (state.playerXP || 0) + ach.xp;
            var inv = state.inventory || {};
            if (ach.item) { var t = ach.item.type; var q = ach.item.qty || 1; inv[t] = (inv[t] || 0) + q; }
            if (typeof addStory === 'function') addStory('Achievement: ' + ach.name + '! +' + ach.xp + ' XP.', 'high');
        }
        function checkAllRelevantAchievements(state, addStory) {
            ['bond_villain', 'fear_itself', 'full_moon_party', 'shift_manager', 'night_owls', 'early_birds'].forEach(function(id) { checkAchievement(state, id, addStory); });
        }

        // ============================================================================
        // DATA MODELS — The wolf's report card (and how fast bars drain)
        // Add a new stat? Add it in createPet() and in the pet card HTML in render() so it shows up.
        // ============================================================================
        // How fast hunger/thirst go up per in-game minute. Bigger number = wolf gets hungry faster.
        const HUNGER_PER_GAME_MIN = 0.035;
        const THIRST_PER_GAME_MIN = 0.04;
        const CRITICAL_THRESHOLD = 80;

        // Personality types shown on the pet card. Add more strings here to expand the list; they're picked at creation.
        var PERSONALITY_TYPES = ['Loyal', 'Mischievous', 'Aloof', 'Protective', 'Curious', 'Lazy', 'Energetic', 'Anxious', 'Brave', 'Playful', 'Stoic', 'Dramatic'];
        // Tier 4: Personality traits (behavior + combat effect). id used in pet.traits[].
        var PERSONALITY_TRAITS = [
            { id: 'mischievous', name: 'Mischievous', behavior: 'Hides items, plays tricks', combat: 'Unpredictable, may confuse enemies' },
            { id: 'supporter', name: 'Supporter', behavior: 'Boosts other wolves', combat: '+5% damage to allies' },
            { id: 'thinker', name: 'Thinker', behavior: 'Strategic, calculates', combat: 'Higher critical chance' },
            { id: 'defensive', name: 'Defensive', behavior: 'Protects self and others', combat: '+10% defense, may shield allies' },
            { id: 'shy', name: 'Shy', behavior: 'Avoids conflict', combat: 'Low aggression, flees at low health' },
            { id: 'aggressive', name: 'Aggressive', behavior: 'Seeks combat', combat: '+10% damage, may ignore commands' },
            { id: 'loyal', name: 'Loyal', behavior: 'Bonds faster', combat: 'Fights harder when bond high' },
            { id: 'curious', name: 'Curious', behavior: 'Explores more', combat: 'Finds extra loot' },
            { id: 'lazy', name: 'Lazy', behavior: 'Prefers resting', combat: 'Slower training, conserves energy' },
            { id: 'energetic', name: 'Energetic', behavior: 'Always active', combat: 'Faster training, burns stamina quick' },
            { id: 'anxious', name: 'Anxious', behavior: 'Easily frightened', combat: 'High fear gain, but alert' },
            { id: 'brave', name: 'Brave', behavior: 'Low fear', combat: 'Good in combat, may protect others' },
            { id: 'stoic', name: 'Stoic', behavior: 'Rarely shows emotion', combat: 'Steady stats, hard to read' },
            { id: 'dramatic', name: 'Dramatic', behavior: 'Exaggerates needs', combat: 'Frequent flavor messages' },
        ];
        // Tier 5–6: Special abilities (physical + elemental). Max 3 per wolf. element for advantage cycle.
        var SPECIAL_ABILITIES = [
            { id: 'lacerating_slash', name: 'Lacerating Slash', element: 'physical', effect: 'Bleed damage over time' },
            { id: 'ripping_bite', name: 'Ripping Bite', element: 'physical', effect: 'High single-target damage' },
            { id: 'crushing_maw', name: 'Crushing Maw', element: 'physical', effect: 'Armor reduction' },
            { id: 'feral_charge', name: 'Feral Charge', element: 'physical', effect: 'Stun chance' },
            { id: 'pack_howl', name: 'Pack Howl', element: 'physical', effect: 'Buff allies' },
            { id: 'territorial_roar', name: 'Territorial Roar', element: 'physical', effect: 'Debuff enemies' },
            { id: 'wind_slash', name: 'Wind Slash', element: 'air', effect: 'High speed, armor pierce' },
            { id: 'fire_bite', name: 'Fire Bite', element: 'fire', effect: 'Burn damage over time' },
            { id: 'stone_hide', name: 'Stone Hide', element: 'earth', effect: 'Defense buff' },
            { id: 'tidal_wave', name: 'Tidal Wave', element: 'water', effect: 'AoE, knockback' },
            { id: 'thunder_clap', name: 'Thunder Clap', element: 'lightning', effect: 'Stun, high crit' },
            { id: 'shadow_step', name: 'Shadow Step', element: 'dark', effect: 'Evasion, backstab' },
            { id: 'moon_beam', name: 'Moon Beam', element: 'light', effect: 'Healing, buff' },
        ];
        // Element advantage: attacker element -> { strongAgainst: [], weakAgainst: [] }. 1.5x strong, 0.75x weak.
        var ELEMENT_ADVANTAGE = { fire: { strong: ['air', 'nature'], weak: ['water', 'earth'] }, air: { strong: ['earth', 'lightning'], weak: ['fire'] }, earth: { strong: ['fire', 'water'], weak: ['air', 'lightning'] }, water: { strong: ['fire', 'earth'], weak: ['earth', 'lightning'] }, lightning: { strong: ['water', 'earth'], weak: ['air', 'nature'] }, nature: { strong: ['earth', 'water'], weak: ['fire', 'physical'] }, light: { strong: ['dark', 'shadow'], weak: ['dark', 'physical'] }, dark: { strong: ['light', 'nature'], weak: ['light'] }, physical: { strong: [], weak: [] } };
        function getNextPetId(state) { var max = 0; (state.pack || []).forEach(function(p) { var n = parseInt((p.id || '').replace('pet_', ''), 10); if (!isNaN(n)) max = Math.max(max, n); }); return 'pet_' + (max + 1); }
        // Creates the default wolf object. data = overrides (e.g. from save file). New run = mostly defaults.
        function createPet(data = {}) {
            return {
                id: data.id || 'pet_1',
                name: data.name || 'Luna',
                gender: data.gender || (Math.random() < 0.5 ? 'Male' : 'Female'),
                hp: data.hp ?? 100,
                maxHp: data.maxHp ?? 100,
                energy: data.energy ?? 100,
                maxEnergy: data.maxEnergy ?? 100,
                hunger: data.hunger ?? 50,
                thirst: data.thirst ?? 50,
                morale: data.morale ?? 70,
                fear: data.fear ?? 55,
                bond: data.bond ?? 25,
                strength: data.strength ?? 10,
                speed: data.speed ?? 10,
                endurance: data.endurance ?? 10,
                form: data.form || 'human',
                shiftLevel: data.shiftLevel ?? 0,
                moonAffinity: data.moonAffinity ?? 0.5,
                transformationControl: data.transformationControl ?? 50,
                level: data.level ?? 1,
                xp: data.xp ?? 0,
                xpToNext: data.xpToNext ?? 100,
                personality: data.personality || { aggressive: 0.5, cautious: 0.3 },
                personalityType: data.personalityType || PERSONALITY_TYPES[Math.floor(Math.random() * PERSONALITY_TYPES.length)],
                sickness: data.sickness ?? 0,
                shiftRateModifier: data.shiftRateModifier ?? 0,
                sleep: data.sleep ?? 100,
                stamina: data.stamina ?? 100,
                maxStamina: data.maxStamina ?? 100,
                spiritAlignment: data.spiritAlignment ?? 0,
                birthDay: data.birthDay ?? 1,
                ageInDays: data.ageInDays ?? 0,
                lifeStage: data.lifeStage || 'pup',
                traits: Array.isArray(data.traits) ? data.traits : [],
                abilities: Array.isArray(data.abilities) ? data.abilities : [],
            };
        }
        function getCurrentPet(state) {
            var pack = state.pack || [];
            var idx = state.selectedPetIndex != null ? state.selectedPetIndex : 0;
            return pack[idx] || pack[0] || null;
        }
        function canAddWolf(state) { return (state.pack || []).length < CONFIG.MAX_PACK_SIZE; }
        function canFormSquad(state, count) { return count <= CONFIG.MAX_SQUAD_SIZE; }
        function getSquad(state) {
            var pack = state.pack || [];
            var idx = state.squadIndices && state.squadIndices.length ? state.squadIndices : [state.selectedPetIndex != null ? state.selectedPetIndex : 0];
            idx = idx.slice(0, CONFIG.MAX_SQUAD_SIZE || 3);
            var squad = idx.map(function(i) { return pack[i]; }).filter(Boolean);
            return squad.length ? squad : (pack[0] ? [pack[0]] : []);
        }
        function getLifeStage(ageInDays) {
            var d = ageInDays == null ? 0 : ageInDays;
            if (d < CONFIG.lifeStageDays.pup) return 'pup';
            if (d < CONFIG.lifeStageDays.adult) return 'adult';
            return 'elder';
        }
        function createOffspring(state, male, female, premium, selectedGender, selectedAbility) {
            var w = state.world || {};
            var currentDay = w.currentDay || 1;
            var allAbilities = [].concat(male.abilities || [], female.abilities || []);
            var pupAbility = [];
            if (premium && selectedAbility && (male.abilities || []).indexOf(selectedAbility) >= 0 || (female.abilities || []).indexOf(selectedAbility) >= 0)
                pupAbility = [selectedAbility];
            else if (allAbilities.length > 0)
                pupAbility = [allAbilities[Math.floor(Math.random() * allAbilities.length)]];
            var gender = premium && selectedGender ? selectedGender : (Math.random() < 0.5 ? 'Male' : 'Female');
            var names = ['Pup', 'Shadow', 'Ember', 'Fang', 'Luna', 'Rust', 'Ash', 'Storm', 'Breeze', 'Flame', 'Dust', 'Mist'];
            var name = names[Math.floor(Math.random() * names.length)];
            return createPet({
                id: getNextPetId(state),
                name: name,
                gender: gender,
                birthDay: currentDay,
                ageInDays: 0,
                lifeStage: 'pup',
                abilities: pupAbility,
                traits: [],
                bond: premium ? 40 : 30,
                fear: 40,
                hunger: 50,
                thirst: 50,
            });
        }
        function startBreeding(state, maleId, femaleId, premium, selectedGender, selectedAbility, addStory) {
            if (!state.pack || state.pack.length >= (CONFIG.MAX_PACK_SIZE || 6)) { addStory('Sanctuary at maximum capacity (6 wolves). Release a wolf first.'); return false; }
            var male = state.pack.find(function(p) { return p.id === maleId; });
            var female = state.pack.find(function(p) { return p.id === femaleId; });
            if (!male || !female) { addStory('Invalid breeding pair.'); return false; }
            if (getLifeStage(male.ageInDays) !== 'adult' || getLifeStage(female.ageInDays) !== 'adult') { addStory('Both wolves must be adults to breed.'); return false; }
            if (maleId === femaleId) { addStory('Select two different wolves.'); return false; }
            var foodCost = premium ? CONFIG.PREMIUM_FOOD_COST : CONFIG.BREEDING_FOOD_COST;
            var matCost = premium ? CONFIG.PREMIUM_MATERIALS_COST : CONFIG.BREEDING_MATERIALS_COST;
            var inv = state.inventory || {};
            var foodTotal = (inv.food || 0) + (inv.plants || 0) + (inv.cookedMeat || 0) + (inv.cookedVegetables || 0);
            if (foodTotal < foodCost) { addStory('Need ' + foodCost + ' food (food + plants + cooked) to breed.'); return false; }
            if ((inv.materials || 0) < matCost) { addStory('Need ' + matCost + ' materials to breed.'); return false; }
            var remain = foodCost;
            if (inv.food >= remain) { inv.food -= remain; remain = 0; } else { remain -= inv.food || 0; inv.food = 0; }
            if (remain > 0 && (inv.plants || 0) >= remain) { inv.plants = (inv.plants || 0) - remain; remain = 0; } else if (remain > 0) { remain -= (inv.plants || 0); inv.plants = 0; }
            if (remain > 0 && (inv.cookedMeat || 0) >= remain) { inv.cookedMeat = (inv.cookedMeat || 0) - remain; remain = 0; } else if (remain > 0) { remain -= (inv.cookedMeat || 0); inv.cookedMeat = 0; }
            if (remain > 0) inv.cookedVegetables = Math.max(0, (inv.cookedVegetables || 0) - remain);
            inv.materials = (inv.materials || 0) - matCost;
            state.breeding = { maleId: maleId, femaleId: femaleId, dueDay: (state.world.currentDay || 1) + CONFIG.GESTATION_DAYS, premium: !!premium, selectedGender: selectedGender || null, selectedAbility: selectedAbility || null };
            addStory('Breeding started between ' + male.name + ' and ' + female.name + '. Gestation: one lunar month (28 days).', 'high');
            return true;
        }

        function createWorld() {
            return {
                worldTime: 0,
                dayLengthMinutes: CONFIG.dayLengthMinutes,
                currentDay: 1,
                timeOfDay: 'dawn',
                lightLevel: 0.5,
                lunarDay: 0,
                moonPhase: 'new',
                moonIllumination: 0,
                daysToFullMoon: 15,
                threatLevel: 1,
                weather: 'clear',
                weatherTicks: 0,
                season: 'spring',
            };
        }

        // Rabbits: cute, fragile, and they will die if you blink. We don't make the rules.
        function createRabbit() {
            return { hunger: 30, thirst: 30, clean: 80, sick: 0, lastFedDay: 1, lastWaterDay: 1, lastCleanDay: 1 };
        }

        // Builds the initial game state: pack (max 6 wolves), world (day 1), inventory, empty queues, workers, etc.
        // state.pack = array of werewolves; state.selectedPetIndex = which wolf is shown in Kennel; state.pet = pack[selectedPetIndex] (synced for backward compat).
        function createGameState() {
            const world = createWorld();
            var firstPet = createPet();
            var pack = [firstPet];
            return {
                version: '1.0.0',
                pack: pack,
                selectedPetIndex: 0,
                squadIndices: [0],
                pet: firstPet,
                world,
                inventory: { food: 4, rawMeat: 2, cookedMeat: 0, cookedVegetables: 0, plants: 2, seeds: 2, herbs: 0, water: 5, meds: 3, materials: 2, compostUnits: 0, starPotion: 0, rabbitTrap: 0, net: 0, bait: 0, premiumBait: 0 },
                flags: {},
                stats: { missionsCompleted: 0, enemiesDefeated: 0, cropsHarvested: 0, rabbitsHarvested: 0, transformationsWitnessed: 0, plantsCooked: 0, nightActions: 0, dawnActions: 0 },
                consecutiveDaysRabbitFed: 0,
                consecutiveDaysWolfFed: 0,
                consecutiveDaysGardenTended: 0,
                lastRabbitCareDay: 0,
                lastWolfFedDay: 0,
                lastGardenTendedDay: 0,
                reportsSectionsRead: {},
                inCage: true,
                busyUntil: 0,
                currentAction: null,
                actionQueue: [],
                actionByLocation: { clearing: [], garden: [], kennel: [], rabbit_farm: [], crafting: [] },
                currentEnemy: null,
                encounterPrompt: null,
                combatInProgress: false,
                reports: [],
                currentLocation: 'clearing',
                compost: { level: 0, readyInDays: 3 },
                garden: { crops: [], compostBonus: 0, watered: false, dying: false },
                kennelClean: 100,
                kennelWaste: 0,
                rabbitCount: 1,
                rabbit: createRabbit(),
                grillOn: false,
                rainCatcherBuilt: false,
                petEscaped: false,
                observeUntil: 0,
                damaged: {},
                lastHelicopterDropDay: 0,
                securityLevel: 50,
                workers: [
                    { name: 'Sarah', role: 'Caretaker', assignment: 'Kennel', fear: 30, fearResistance: 1.2, cooking: 0, medical: 2, security: 1, maintenance: 2, caretaking: 7 },
                    { name: 'Mike', role: 'Cook', assignment: 'Crafting', fear: 20, fearResistance: 1, cooking: 8, medical: 0, security: 0, maintenance: 1, caretaking: 1 },
                    { name: 'Tom', role: 'Repair', assignment: 'Crafting', fear: 25, fearResistance: 1, cooking: 0, medical: 0, security: 1, maintenance: 8, caretaking: 1 },
                    { name: 'Emma', role: 'Caretaker', assignment: 'Garden', fear: 15, fearResistance: 1.2, cooking: 1, medical: 0, security: 0, maintenance: 2, caretaking: 6 },
                    { name: 'David', role: 'Caretaker', assignment: 'Rabbit Farm', fear: 20, fearResistance: 1.2, cooking: 0, medical: 1, security: 0, maintenance: 2, caretaking: 6 },
                    { name: 'Lisa', role: 'Security', assignment: 'Clearing', fear: 40, fearResistance: 0.6, cooking: 0, medical: 0, security: 7, maintenance: 1, caretaking: 1 },
                    { name: 'John', role: 'Caretaker', assignment: 'Command Center', fear: 10, fearResistance: 1, cooking: 0, medical: 0, security: 4, maintenance: 2, caretaking: 8 }
                ],
                inboundWorker: null,
                assetsEscaped: 7,
                assetsKilled: 4,
                achievements: {},
                playerXP: 0,
                breeding: null,
            };
        }

        // ============================================================================
        // TIME & MOON — advanceTime runs every tick. This is where the chaos lives.
        // Day roll, helicopter drops, worker panic, rabbit death, hunger/thirst, random events—all driven from here.
        // Want to add a new "every X minutes" effect? Add it in advanceTime and use state.world / state.pet / state.inventory.
        // ============================================================================
        function advanceTime(state, deltaMinutes) {
            const w = state.world;
            if (state.pack && state.pack.length) state.pet = getCurrentPet(state);
            state.pack = state.pack || [];
            state.pack.forEach(function(p) { updatePetForm(p, w); });
            var prevForm = state.pet && state.pet.form;
            if (state.pet && (state.pet.form === 'wolf' || state.pet.form === 'hybrid') && prevForm === 'human') {
                state.stats = state.stats || {};
                state.stats.transformationsWitnessed = (state.stats.transformationsWitnessed || 0) + 1;
            }
            var prevDay = w.currentDay;
            w.worldTime = (w.worldTime || 0) + deltaMinutes;
            while (w.worldTime >= w.dayLengthMinutes) {
                w.worldTime -= w.dayLengthMinutes;
                w.currentDay++;
                if (state.breeding && state.breeding.dueDay <= w.currentDay && state.pack && state.pack.length < (CONFIG.MAX_PACK_SIZE || 6)) {
                    var male = state.pack.find(function(p) { return p.id === state.breeding.maleId; });
                    var female = state.pack.find(function(p) { return p.id === state.breeding.femaleId; });
                    if (male && female) {
                        var pup = createOffspring(state, male, female, state.breeding.premium, state.breeding.selectedGender, state.breeding.selectedAbility);
                        if (pup) {
                            state.pack.push(pup);
                            if (typeof state._addStory === 'function') state._addStory('A new pup is born! Welcome ' + pup.name + ' to the pack.', 'critical');
                        }
                    }
                    state.breeding = null;
                }
            }
            var progress = w.worldTime / w.dayLengthMinutes;
            var prevTod = w.timeOfDay;
            var newTod;
            if (progress < 0.25) { newTod = 'dawn'; w.lightLevel = 0.3 + (progress / 0.25) * 0.4; }
            else if (progress < 0.5) { newTod = 'day'; w.lightLevel = 0.7 + ((progress - 0.25) / 0.25) * 0.2; }
            else if (progress < 0.75) { newTod = 'dusk'; w.lightLevel = 0.9 - ((progress - 0.5) / 0.25) * 0.4; }
            else { newTod = 'night'; w.lightLevel = 0.5 - ((progress - 0.75) / 0.25) * 0.5; }
            w.timeOfDay = newTod;
            w.lightLevel = Math.max(0.1, Math.min(1, w.lightLevel));
            var dayNightCues = document.getElementById('opt-day-night-cues');
            if (dayNightCues && dayNightCues.checked) {
                if (prevTod === 'dusk' && newTod === 'night') { try { var a = new Audio('crickets.mp3'); a.volume = 0.4; a.play().catch(function(){}); } catch(e) {} }
                if (prevTod === 'night' && newTod === 'dawn') { try { var b = new Audio('rooster.mp3'); b.volume = 0.5; b.play().catch(function(){}); } catch(e) {} }
            }

            w.lunarDay = (w.currentDay - 1) % 28;
            if (w.lunarDay < 4) { w.moonPhase = 'new'; w.moonIllumination = w.lunarDay / 4; }
            else if (w.lunarDay < 7) { w.moonPhase = 'waxing_crescent'; w.moonIllumination = 0.25 + ((w.lunarDay - 4) / 3) * 0.25; }
            else if (w.lunarDay < 10) { w.moonPhase = 'first_quarter'; w.moonIllumination = 0.5 + ((w.lunarDay - 7) / 3) * 0.15; }
            else if (w.lunarDay < 14) { w.moonPhase = 'waxing_gibbous'; w.moonIllumination = 0.65 + ((w.lunarDay - 10) / 4) * 0.35; }
            else if (w.lunarDay < 16) { w.moonPhase = 'full'; w.moonIllumination = 1; }
            else if (w.lunarDay < 19) { w.moonPhase = 'waning_gibbous'; w.moonIllumination = 0.9 - ((w.lunarDay - 16) / 3) * 0.25; }
            else if (w.lunarDay < 22) { w.moonPhase = 'last_quarter'; w.moonIllumination = 0.65 - ((w.lunarDay - 19) / 3) * 0.25; }
            else { w.moonPhase = 'waning_crescent'; w.moonIllumination = Math.max(0, 0.4 - (w.lunarDay - 22) / 6); }
            w.moonIllumination = Math.max(0, Math.min(1, w.moonIllumination));
            w.daysToFullMoon = w.lunarDay < 14 ? 14 - w.lunarDay : (w.lunarDay >= 16 ? 28 - w.lunarDay + 14 : 0);
            w.weatherTicks = (w.weatherTicks || 0) + deltaMinutes;
            var dayOfYear = (w.currentDay - 1) % 365;
            if (dayOfYear < 90) w.season = 'spring';
            else if (dayOfYear < 180) w.season = 'summer';
            else if (dayOfYear < 270) w.season = 'fall';
            else w.season = 'winter';
            if (w.weatherTicks >= 120) {
                w.weatherTicks = 0;
                var r = Math.random();
                if (w.season === 'winter' && r < 0.5) w.weather = 'snow';
                else if ((w.season === 'spring' || w.season === 'fall') && r < 0.4) w.weather = 'rain';
                else if (r < 0.2) w.weather = 'rain';
                else if (r < 0.4) w.weather = 'snow';
                else w.weather = 'clear';
            }
            if (w.currentDay > prevDay) {
                var comp = state.compost || { level: 0, readyInDays: 3 };
                if (comp.readyInDays > 0) comp.readyInDays--;
                state.compost = comp;
                var garden = state.garden || { crops: [], compostBonus: 0, watered: false, dying: false };
                if (garden.crops && garden.crops.length) {
                    if (garden.dying) { garden.crops = []; garden.dying = false; }
                    else if (!garden.watered) {
                        garden.dying = true;
                        if (typeof state._addStory === 'function') state._addStory('The garden is parched. The crops are wilting.');
                    }
                    else {
                        var bonus = (comp.readyInDays <= 0 && comp.level >= 50) ? 1 : 0;
                        garden.crops.forEach(function(c) { c.daysLeft = Math.max(0, (c.daysLeft || 0) - 1 - bonus); });
                    }
                }
                garden.watered = false;
                state.garden = garden;
                state.kennelWaste = (state.kennelWaste || 0) + 1;
                if (Math.random() < 0.1) {
                    var locs = ['clearing', 'kennel', 'garden', 'rabbit_farm', 'crafting'];
                    var broken = locs[Math.floor(Math.random() * locs.length)];
                    state.damaged = state.damaged || {};
                    state.damaged[broken] = true;
                    var names = { clearing: 'Training dummy', kennel: 'Kennel gate', garden: 'Irrigation', rabbit_farm: 'Rabbit cage', crafting: 'Grill' };
                    if (typeof state._addStory === 'function') state._addStory(names[broken] + ' broke! Repair needed.', 'high');
                }
                var lastDrop = state.lastHelicopterDropDay || 0;
                if ((w.currentDay - lastDrop) >= 28 && w.currentDay >= 28) {
                    state.lastHelicopterDropDay = w.currentDay;
                    try { var heli = new Audio('helicopter.mp3'); heli.volume = 0.3; heli.play().catch(function() {}); } catch (e) {}
                    var inv = state.inventory || {};
                    if (state.inboundWorker) {
                        state.workers = state.workers || [];
                        state.workers.push({ id: 'w' + Date.now(), name: state.inboundWorker.name || state.inboundWorker.role, role: state.inboundWorker.role || 'Worker', fear: state.inboundWorker.fear || 20, assignment: '', injured: false, effectivenessPenalty: 0, cooking: state.inboundWorker.cooking || 5, medical: state.inboundWorker.medical || 3, security: state.inboundWorker.security || 3, maintenance: state.inboundWorker.maintenance || 4, caretaking: state.inboundWorker.caretaking || 5 });
                        if (typeof state._addStory === 'function') state._addStory('Helicopter drop! New worker arrived: ' + (state.inboundWorker.name || state.inboundWorker.role) + '.', 'high');
                        state.inboundWorker = null;
                    } else {
                        var daysWaited = w.currentDay - lastDrop;
                        var longWait = daysWaited >= 20;
                        if (typeof state._addStory === 'function') state._addStory(longWait ? 'The helicopter brings a heavy supply run. They knew you were waiting.' : 'Helicopter drop! Supplies arrived.', 'high');
                        var add = Math.floor(1 + Math.random() * 3);
                        if (longWait) add += Math.floor(2 + Math.random() * 4);
                        inv.materials = (inv.materials || 0) + add;
                        if (Math.random() < 0.5) inv.rawMeat = (inv.rawMeat || 0) + 1;
                        if (longWait) inv.rawMeat = (inv.rawMeat || 0) + Math.floor(1 + Math.random() * 2);
                        if (Math.random() < 0.5) inv.water = (inv.water || 0) + 2;
                        if (longWait) { inv.water = (inv.water || 0) + 3; inv.plants = (inv.plants || 0) + Math.floor(1 + Math.random() * 2); if (Math.random() < 0.3) inv.herbs = (inv.herbs || 0) + 1; if (Math.random() < 0.2) inv.meds = (inv.meds || 0) + 1; }
                        if (longWait && !state.inboundWorker && Math.random() < 0.15) {
                            state.inboundWorker = { role: ['Cook', 'Security', 'Doctor', 'Repair', 'Caretaker'][Math.floor(Math.random() * 5)], fear: 15 + Math.floor(Math.random() * 15) };
                            if (typeof state._addStory === 'function') state._addStory('A volunteer is on the next run. They\'ll arrive with the following drop.', 'high');
                        }
                        if (longWait && Math.random() < 0.08) {
                            inv.starPotion = (inv.starPotion || 0) + 1;
                            if (typeof state._addStory === 'function') state._addStory('A single vial glints in the crate: Star Potion. One fight, no harm can touch them.', 'high');
                        }
                    }
                }
                var da = state.damagedAgainAt || {};
                for (var loc in da) { if (da[loc] && Date.now() >= da[loc]) { state.damaged = state.damaged || {}; state.damaged[loc] = true; delete state.damagedAgainAt[loc]; if (typeof state._addStory === 'function') state._addStory('Temporary repair gave out. Equipment damaged again.', 'high'); } }
                // 70% chance something happens today. This is that "something." We don't apologize.
                if (Math.random() < 0.7) {
                    var eventList = [];
                    if ((state.rabbitCount || 0) > 0) eventList.push('rabbit_sick');
                    if (state.pet) eventList.push('asset_sick');
                    var inv = state.inventory || {};
                    if ((inv.rawMeat || 0) + (inv.cookedMeat || 0) + (inv.plants || 0) >= 2) eventList.push('food_rot');
                    eventList.push('grill_breaks', 'water_contamination', 'dummy_breaks', 'kennel_jam', 'rabbit_cage_damaged', 'supply_cache');
                    var ev = eventList[Math.floor(Math.random() * eventList.length)];
                    if (ev === 'grill_breaks') { state.damaged = state.damaged || {}; state.damaged.crafting = true; if (typeof state._addStory === 'function') state._addStory('The grill broke. Repair at Crafting.', 'high'); }
                    else if (ev === 'dummy_breaks') { state.damaged = state.damaged || {}; state.damaged.clearing = true; if (typeof state._addStory === 'function') state._addStory('Training dummy shattered! Repair at Clearing.', 'high'); }
                    else if (ev === 'kennel_jam') { state.damaged = state.damaged || {}; state.damaged.kennel = true; if (typeof state._addStory === 'function') state._addStory('Kennel gate jammed. Wolf can\'t exit until repaired.', 'high'); }
                    else if (ev === 'rabbit_sick' && state.rabbit) { state.rabbit.sick = Math.min(100, (state.rabbit.sick || 0) + 40); if (typeof state._addStory === 'function') state._addStory('Rabbits got sick. Treat them or they may die.', 'high'); }
                    else if (ev === 'rabbit_cage_damaged' && (state.rabbitCount || 0) > 0) { state.damaged = state.damaged || {}; state.damaged.rabbit_farm = true; if (typeof state._addStory === 'function') state._addStory('Rabbit cage damaged. Rabbits stressed—repair soon.', 'high'); }
                    else if (ev === 'asset_sick' && state.pet) { state.pet.hp = Math.max(1, (state.pet.hp || 100) - 15); state.pet.sickness = Math.min(100, (state.pet.sickness || 0) + 20); if (typeof state._addStory === 'function') state._addStory(state.pet.name + ' fell ill. Rest and medicine needed.', 'high'); }
                    else if (ev === 'food_rot') { var lost = 0; if ((inv.rawMeat || 0) >= 1) { inv.rawMeat = (inv.rawMeat || 0) - 1; lost++; } if ((inv.plants || 0) >= 1) { inv.plants = (inv.plants || 0) - 1; lost++; } if (lost > 0 && typeof state._addStory === 'function') state._addStory('Some food rotted. Store and cook faster next time.', 'medium'); }
                    else if (ev === 'water_contamination') { inv = state.inventory || {}; var waterLost = Math.min(3, inv.water || 0); inv.water = (inv.water || 0) - waterLost; if (waterLost > 0 && typeof state._addStory === 'function') state._addStory('Water supply contaminated. ' + waterLost + ' unit(s) lost. Boil before use.', 'high'); }
                    else if (ev === 'supply_cache') { inv = state.inventory || {}; inv.materials = (inv.materials || 0) + (1 + Math.floor(Math.random() * 2)); if (Math.random() < 0.5) inv.water = (inv.water || 0) + 2; if (typeof state._addStory === 'function') state._addStory('Supply cache found. Extra materials and water.', 'medium'); }
                }
                var petForEscape = state.pet;
                if (petForEscape && !state.petEscaped && (petForEscape.fear || 0) >= 81 && (petForEscape.bond || 50) < 30 && Math.random() < 0.15) {
                    state.petEscaped = true;
                    state.flags = state.flags || {};
                    state.flags.hadEscape = true;
                    state.securityLevel = Math.max(0, (state.securityLevel != null ? state.securityLevel : 50) - 15);
                    if (typeof state._addStory === 'function') state._addStory(petForEscape.name + ' escaped! Find them on a hunt or patrol.', 'critical');
                    if (typeof state._addStory === 'function') checkAchievement(state, 'escape_artist', state._addStory);
                }
                var lunar = (prevDay - 1) % 28;
                if (lunar === 13 || lunar === 14) {
                    state.flags = state.flags || {};
                    state.flags.survivedFullMoon = true;
                    if (typeof state._addStory === 'function') checkAchievement(state, 'full_moon_party', state._addStory);
                }
                var workers = state.workers || [];
                var petForFear = state.pet;
                if (petForFear && workers.length) {
                    var wolfFear = petForFear.fear || 0;
                    var bond = petForFear.bond || 50;
                    var fullMoon = (lunar === 13 || lunar === 14);
                    workers.forEach(function(worker) {
                        var delta = (wolfFear - 50) * 0.08;
                        if (state.petEscaped) delta += 8;
                        if (fullMoon) delta += 4;
                        if (bond > 60) delta -= 3;
                        var sec = state.securityLevel != null ? state.securityLevel : 50;
                        if (sec > 50) delta -= Math.min(4, Math.floor((sec - 50) / 25));
                        delta *= (worker.fearResistance != null ? worker.fearResistance : 1);
                        worker.fear = Math.max(0, Math.min(100, (worker.fear || 20) + delta));
                    });
                }
                // When fear hits 90, workers start making "choices." None of them good.
                var HIGH_FEAR = 90;
                var QUIT_CHANCE = 0.05;   // 5% per day: "I'm out. The wolves know."
                var INCIDENT_CHANCE = 0.03;  // 3%: damage, injury, escape, or sabotage. Fun!
                var assignmentToLoc = { 'Clearing': 'clearing', 'Garden': 'garden', 'Kennel': 'kennel', 'Rabbit Farm': 'rabbit_farm', 'Crafting': 'crafting', 'Command Center': '' };
                var quitIndices = [];
                state._workerEdgeWarned = state._workerEdgeWarned || {};
                workers.forEach(function(worker, idx) {
                    var key = (worker.name || worker.role) + '_' + idx;
                    if ((worker.fear || 0) >= HIGH_FEAR && !state._workerEdgeWarned[key] && typeof state._addStory === 'function' && canShowWarning('worker_edge')) {
                        state._workerEdgeWarned[key] = true;
                        lastWarningTime['worker_edge'] = Date.now();
                        state._addStory((worker.name || worker.role) + ' is on the edge. They might quit or snap.', 'critical');
                    }
                });
                workers.forEach(function(worker, idx) {
                    if ((worker.fear || 0) < HIGH_FEAR) return;
                    if (Math.random() < QUIT_CHANCE) {
                        quitIndices.push(idx);
                        var quitMsgs = [
                            (worker.name || worker.role) + ' packed their bags last night. Left a note: "I can\'t do this anymore."',
                            (worker.name || worker.role) + ' didn\'t show up for their shift. Their quarters are empty.',
                            'You find ' + (worker.name || worker.role) + '\'s badge on the ground. They\'re gone.',
                            (worker.name || worker.role) + ' was seen walking into the forest. They didn\'t look back.',
                            (worker.name || worker.role) + ' quit. Said something about "the way they look at me".',
                            'You receive a cryptic message from ' + (worker.name || worker.role) + ': "The wolves know. I\'m sorry."',
                            (worker.name || worker.role) + ' vanished. Their quarters are undisturbed except for a single wolf hair.'
                        ];
                        if (typeof state._addStory === 'function') state._addStory(quitMsgs[Math.floor(Math.random() * quitMsgs.length)], 'high');
                    }
                });
                for (var qi = quitIndices.length - 1; qi >= 0; qi--) state.workers.splice(quitIndices[qi], 1);
                workers = state.workers || [];
                workers.forEach(function(worker) {
                    if ((worker.fear || 0) < HIGH_FEAR) return;
                    if (Math.random() >= INCIDENT_CHANCE) return;
                    var roll = Math.random();
                    var incidentType = roll < 0.4 ? 'damage' : roll < 0.7 ? 'injury' : roll < 0.9 ? 'escape' : 'sabotage';
                    var loc = assignmentToLoc[worker.assignment || ''] || 'clearing';
                    if (incidentType === 'damage' && loc) {
                        state.damaged = state.damaged || {};
                        state.damaged[loc] = true;
                        if (typeof state._addStory === 'function') state._addStory((worker.name || worker.role) + ' accidentally damaged equipment in ' + (worker.assignment || 'the facility') + '.', 'high');
                    } else if (incidentType === 'injury') {
                        worker.injured = true;
                        worker.effectivenessPenalty = (worker.effectivenessPenalty || 0) + 0.3;
                        if (typeof state._addStory === 'function') state._addStory((worker.name || worker.role) + ' had an accident. They\'re injured and less effective.', 'high');
                    } else if (incidentType === 'escape' && state.pet && !state.petEscaped) {
                        state.petEscaped = true;
                        state.flags = state.flags || {};
                        state.flags.hadEscape = true;
                        state.securityLevel = Math.max(0, (state.securityLevel != null ? state.securityLevel : 50) - 15);
                        if (typeof state._addStory === 'function') state._addStory((worker.name || worker.role) + ' left a cage open! ' + state.pet.name + ' is loose!', 'critical');
                    } else if (incidentType === 'sabotage') {
                        if (loc) { state.damaged = state.damaged || {}; state.damaged[loc] = true; }
                        workers.forEach(function(w) { if (w !== worker) w.fear = Math.min(100, (w.fear || 0) + 10); });
                        if (typeof state._addStory === 'function') state._addStory((worker.name || worker.role) + ' deliberately damaged equipment. They\'ve lost it.', 'critical');
                    }
                    worker.fear = Math.max(0, (worker.fear || 0) - 20);
                });
                state.starPotionActiveThisCombat = false;
                workers.forEach(function(worker) {
                    var loc = assignmentToLoc[worker.assignment || ''] || '';
                    if (!loc) return;
                    var eff = getEffectiveSkill(worker, loc);
                    if (eff >= 30) return;
                    if (Math.random() >= 0.12) return;
                    worker.fear = Math.min(100, (worker.fear || 0) + 5);
                    state.damaged = state.damaged || {};
                    if (loc === 'crafting') { state.damaged.crafting = true; if (typeof state._addStory === 'function') state._addStory('A small fire in Crafting. ' + (worker.name || worker.role) + ' couldn\'t keep up. Repair the grill.', 'high'); }
                    else if (loc === 'garden') { var g = state.garden || {}; g.dying = true; state.garden = g; if (typeof state._addStory === 'function') state._addStory('The irrigation failed. Crops are dying. ' + (worker.name || worker.role) + ' looks shaken.', 'high'); }
                    else if (loc === 'kennel') { state.damaged.kennel = true; if (typeof state._addStory === 'function') state._addStory('The kennel gate jammed. ' + (worker.name || worker.role) + ' couldn\'t fix it in time.', 'high'); }
                    else if (loc === 'rabbit_farm') { state.damaged.rabbit_farm = true; if (typeof state._addStory === 'function') state._addStory('Rabbit cage damaged—low effectiveness in the farm. Repair needed.', 'high'); }
                    else if (loc === 'clearing') { state.damaged.clearing = true; if (typeof state._addStory === 'function') state._addStory('Training dummy gave way. Clearing needs repair.', 'high'); }
                });
                var rabbit = state.rabbit;
                if (state.rabbitCount > 0 && rabbit) {
                    var wTime = w.worldTime || 0;
                    state._rabbitWarning = state._rabbitWarning || {};
                    var cooldownMin = 240;
                    var canWarn = function(key) { var last = state._rabbitWarning[key] || 0; if (wTime - last >= cooldownMin) { state._rabbitWarning[key] = wTime; return true; } return false; };
                    var daysNoFood = (w.currentDay || 1) - (rabbit.lastFedDay || 1);
                    var daysNoWater = (w.currentDay || 1) - (rabbit.lastWaterDay || 1);
                    var daysNoClean = (w.currentDay || 1) - (rabbit.lastCleanDay || 1);
                    if (daysNoFood >= 2) {
                        if (typeof state._addStory === 'function') state._addStory('WARNING: Rabbits will die today if not fed!', 'high');
                        state.rabbitCount = 0; state.rabbit = null;
                        if (typeof state._addStory === 'function') state._addStory('Your rabbits have died. They\'re dead, Jim.', 'critical');
                        try { var rabbitAudio = new Audio('rabbit_grunt.mp3'); rabbitAudio.volume = 0.5; rabbitAudio.play().catch(function() {}); } catch (e) {}
                    } else if (daysNoWater >= 2) {
                        if (typeof state._addStory === 'function') state._addStory('Your rabbits have died. They\'re dead, Jim.', 'critical');
                        state.rabbitCount = 0; state.rabbit = null;
                        try { var rabbitAudio = new Audio('rabbit_grunt.mp3'); rabbitAudio.volume = 0.5; rabbitAudio.play().catch(function() {}); } catch (e) {}
                    } else if (daysNoClean >= 2 && (rabbit.clean || 80) <= 20) {
                        if (typeof state._addStory === 'function') state._addStory('Your rabbits have died. They\'re dead, Jim.', 'critical');
                        state.rabbitCount = 0; state.rabbit = null;
                        try { var rabbitAudio = new Audio('rabbit_grunt.mp3'); rabbitAudio.volume = 0.5; rabbitAudio.play().catch(function() {}); } catch (e) {}
                    } else {
                        if ((rabbit.lastFedDay || 0) < w.currentDay) rabbit.hunger = Math.min(100, (rabbit.hunger || 30) + 25);
                        if ((rabbit.lastWaterDay || 0) < w.currentDay) rabbit.thirst = Math.min(100, (rabbit.thirst || 30) + 30);
                        if ((rabbit.lastCleanDay || 0) < w.currentDay) rabbit.clean = Math.max(0, (rabbit.clean || 80) - 20);
                        if (daysNoFood >= 1 && canWarn('hunger')) { if (typeof state._addStory === 'function') state._addStory('Rabbits are hungry.', 'low', 'rabbit_hunger'); }
                    if ((rabbit.hunger < 30 || daysNoFood >= 1) && canWarn('rabbit_feed_soon')) { if (typeof state._addStory === 'function') state._addStory('Rabbits are hungry! Feed them soon.', 'medium', 'rabbit_feed_soon'); }
                        if (daysNoFood >= 1 && rabbit.hunger >= 75 && canWarn('hunger2')) { if (typeof state._addStory === 'function') state._addStory('Rabbits are VERY hungry—feed soon!', 'low', 'rabbit_hunger2'); }
                        if (daysNoWater >= 1 && canWarn('thirst')) { if (typeof state._addStory === 'function') state._addStory('Rabbits need water.', 'low', 'rabbit_thirst'); }
                        if (daysNoWater >= 1 && rabbit.thirst >= 75 && canWarn('thirst2')) { if (typeof state._addStory === 'function') state._addStory('Rabbits are VERY thirsty—water soon!', 'low', 'rabbit_thirst2'); }
                        if (rabbit.hunger >= 80 || rabbit.thirst >= 80 || rabbit.clean <= 20) rabbit.sick = Math.min(100, (rabbit.sick || 0) + 40);
                        // Loneliness (1 rabbit = +sick, 2+ = small recovery) and dirty-cage penalties, once per day.
                        var curDay = (w.currentDay || 1);
                        if (curDay !== (state._lastRabbitLonelinessDay || 0)) {
                            state._lastRabbitLonelinessDay = curDay;
                            var rc = state.rabbitCount || 0;
                            if (rc === 1) {
                                rabbit.sick = Math.min(100, (rabbit.sick || 0) + 2);
                                if (Math.random() < 0.3) { if (typeof state._addStory === 'function') state._addStory('The lone rabbit seems sad. It needs a friend.', 'low'); }
                            } else if (rc >= 2) {
                                rabbit.sick = Math.max(0, (rabbit.sick || 0) - 1);
                                if (Math.random() < 0.2) { if (typeof state._addStory === 'function') state._addStory('The rabbits huddle together. They seem content.', 'low'); }
                            }
                            // Dirty cage: clean < 30 = sickness chance + daily sick; clean < 10 = heavy penalty + critical message.
                            var clean = rabbit.clean || 80;
                            if (clean < 30) {
                                var sicknessChance = (30 - clean) / 100;
                                if (Math.random() < sicknessChance) {
                                    rabbit.sick = Math.min(100, (rabbit.sick || 0) + 30);
                                    if (typeof state._addStory === 'function') state._addStory('Rabbits are sick from the dirty cage! Clean it and give medicine.', 'high');
                                }
                                rabbit.sick = Math.min(100, (rabbit.sick || 0) + 5);
                            }
                            if (clean < 10) {
                                rabbit.sick = Math.min(100, (rabbit.sick || 0) + 10);
                                if (typeof state._addStory === 'function') state._addStory('The rabbit cage is FILTHY! Clean it immediately!', 'critical');
                            }
                        }
                        if (rabbit.sick >= 80) { state.rabbitCount = 0; state.rabbit = null; if (typeof state._addStory === 'function') state._addStory('Your rabbits have died. They\'re dead, Jim.', 'critical'); try { var rabbitAudio = new Audio('rabbit_grunt.mp3'); rabbitAudio.volume = 0.5; rabbitAudio.play().catch(function() {}); } catch (e) {} }
                    }
                }
            }

            // Tick hunger/thirst/sleep for ALL pack members (max 6)
            state.pack.forEach(function(p) {
                if (!p) return;
                p.ageInDays = Math.max(0, (w.currentDay || 1) - (p.birthDay || 1));
                p.lifeStage = getLifeStage(p.ageInDays);
                var activityMult = 1;
                var ab = state.actionByLocation || {};
                for (var loc in ab) {
                    var q = Array.isArray(ab[loc]) ? ab[loc] : (ab[loc] && ab[loc].id ? [ab[loc]] : []);
                    if (q.length && q[0].busyUntil != null && ['train', 'hunt', 'forage', 'patrol'].indexOf(q[0].id) >= 0 && Date.now() < q[0].busyUntil) { activityMult = 1.5; break; }
                }
                if (state.combatInProgress) activityMult = 1.5;
                var formMult = (p.form === 'wolf') ? 1.3 : (p.form === 'hybrid') ? 1.1 : 1;
                var hungerRate = HUNGER_PER_GAME_MIN * activityMult * formMult;
                var thirstRate = THIRST_PER_GAME_MIN * activityMult * formMult;
                p.hunger = Math.min(100, (p.hunger || 0) + hungerRate * deltaMinutes);
                p.thirst = Math.min(100, (p.thirst || 50) + thirstRate * deltaMinutes);
                p.sleep = Math.max(0, (p.sleep ?? 100) - CONFIG.sleepDecayPerMin * deltaMinutes);
                if (p.sleep < 20) p.stamina = Math.min(p.maxStamina || 100, (p.stamina ?? 100) + 0);
                else p.stamina = Math.min(p.maxStamina || 100, (p.stamina ?? 100) + CONFIG.staminaRegenPerMin * deltaMinutes);
                if (p.sickness > 0) p.hp = Math.max(0, (p.hp || 100) - 0.08 * deltaMinutes * (p.sickness / 100));
                if (p.sleep < 10) p.hp = Math.max(0, (p.hp || 100) - 0.03 * deltaMinutes);
                if (p.sleep <= 0) p.hp = Math.max(0, (p.hp || 100) - 0.05 * deltaMinutes);
                if (p.hunger >= CRITICAL_THRESHOLD || p.thirst >= CRITICAL_THRESHOLD) {
                    p.bond = Math.max(0, (p.bond || 50) - 0.02 * deltaMinutes);
                    p.fear = Math.min(100, (p.fear || 0) + 0.02 * deltaMinutes);
                    p.spiritAlignment = Math.max(-100, (p.spiritAlignment || 0) - 0.01 * deltaMinutes);
                    if (p.hunger >= CRITICAL_THRESHOLD && p.thirst >= CRITICAL_THRESHOLD) p.hp = Math.max(0, (p.hp || 100) - 0.05 * deltaMinutes);
                }
                var fear = p.fear || 0;
                if (fear > 30) {
                    var bondDecay = fear * 0.0008 * deltaMinutes;
                    if (fear > 60) bondDecay *= 1.5;
                    if (fear > 80) bondDecay *= 1.5;
                    p.bond = Math.max(0, (p.bond || 50) - bondDecay);
                }
            });
            // Story messages and escape check only for current wolf (avoid spam)
            var pet = state.pet;
            if (pet) {
                if (pet.hunger >= 50 && !(state._wolfHungerWarned50 || {})[pet.id]) { state._wolfHungerWarned50 = state._wolfHungerWarned50 || {}; state._wolfHungerWarned50[pet.id] = true; if (typeof state._addStory === 'function') state._addStory(pet.name + '\'s stomach growls. They nudge the empty food bowl.', 'low'); }
                if (pet.hunger >= 75 && typeof state._addStory === 'function') state._addStory(pet.name + ' stares at the empty bowl. Feed them soon.', 'low', 'wolf_hunger75');
                if (pet.thirst >= 50 && !(state._wolfThirstWarned50 || {})[pet.id]) { state._wolfThirstWarned50 = state._wolfThirstWarned50 || {}; state._wolfThirstWarned50[pet.id] = true; if (typeof state._addStory === 'function') state._addStory(pet.name + ' looks at their empty water bowl.', 'low'); }
                if (pet.thirst >= 75 && typeof state._addStory === 'function') state._addStory(pet.name + '\'s tongue is dry. They need water.', 'low', 'wolf_thirst75');
                if ((pet.fear || 0) > 80 && typeof state._addStory === 'function' && canShowWarning('wolf_fear80')) {
                    lastWarningTime['wolf_fear80'] = Date.now();
                    state._addStory((pet.name || 'The wolf') + ' is terrified. Bond with them before they snap.', 'high');
                }
            }
        }

        function getPersonalityFlavor(pet) {
            var p = (pet.personalityType || 'Stoic');
            var name = pet.name || 'The wolf';
            var sleeping = (pet.sleep ?? 100) >= 60;
            var fear = pet.fear || 0;
            var bond = pet.bond || 50;
            var stamina = pet.stamina ?? 100;
            if (p === 'Mischievous') {
                if (sleeping) return name + ' twitches and growls softly in their sleep. Probably planning something.';
                if (fear > 70) return name + ' hides in the corner, but keeps peeking out with one eye. Suspicious.';
                return name + ' subtly moves your tools when you\'re not looking. Mischievous glint in their eye.';
            }
            if (p === 'Loyal') {
                if (bond > 80) return name + ' follows you with their eyes wherever you go. Devoted.';
                if (sleeping) return name + ' curls up facing your direction, even in sleep.';
                return name + ' gently nudges your hand. Looking for attention.';
            }
            if (p === 'Anxious') {
                if (fear > 70) return name + ' startles at every sound. Tail tucked. Trembling slightly.';
                if (sleeping) return name + ' sleeps with one eye open. Never truly relaxed.';
                return name + ' paces back and forth. Something\'s bothering them.';
            }
            if (p === 'Playful') {
                if (stamina > 70) return name + ' drops a stick at your feet. Want to play?';
                if (sleeping) return name + ' kicks their legs while sleeping. Chasing rabbits in dreams.';
                return name + ' does a play bow, tail wagging. So much energy!';
            }
            if (p === 'Lazy' && sleeping) return name + ' is sprawled out, snoring softly. No intention of moving.';
            if (p === 'Energetic' && !sleeping) return name + ' can\'t sit still. Ready for anything.';
            if (p === 'Stoic') return name + ' looks at you calmly. Unreadable.';
            if (p === 'Dramatic') return name + ' lets out a long sigh. The world is so unfair.';
            return name + ' looks at you.';
        }
        function checkFlavorBlurb(state) {
            if (!state || typeof state._addStory !== 'function') return;
            var blurbChance = 0.3;
            var pet = state.pet;
            if (pet && (pet.name || '').toLowerCase() === 'luna' && (pet.fear || 0) > 80) {
                var isSleeping = (pet.sleep ?? 100) >= 60;
                if (Math.random() < blurbChance) {
                    var msgs = isSleeping
                        ? ['Luna jerks awake from a nightmare, then slowly settles back down.', 'Luna whimpers in her sleep. Her legs twitch like she\'s running.', 'Luna suddenly sits up, looks around wildly, then collapses back to sleep.']
                        : ['Luna stares into space, lost in thought. She doesn\'t notice you watching.', 'Luna jumps at a shadow. Just a shadow. She relaxes, embarrassed.', 'Luna\'s eyes dart around the room. She can\'t focus on anything.'];
                    state._addStory(msgs[Math.floor(Math.random() * msgs.length)], 'low');
                }
            }
            if (pet && Math.random() < 0.1) {
                var personalityMsg = getPersonalityFlavor(pet);
                if (personalityMsg) state._addStory(personalityMsg, 'low');
            }
            if ((state.rabbitCount || 0) === 1 && Math.random() < blurbChance) {
                var lonely = ['The single rabbit hops in circles, restless and alone.', 'The rabbit keeps looking toward the empty cage. Waiting.', 'A sad little thump comes from the rabbit cage. Loneliness?'];
                state._addStory(lonely[Math.floor(Math.random() * lonely.length)], 'low');
            }
        }

        // ============================================================================
        // WORKERS — Assignment, skills, fear, efficiency, security
        // Workers have fear, skills (cooking, medical, security, maintenance, caretaking), and an assignment.
        // getSkillForTab / getEffectiveSkill: Clearing↔Security, Crafting↔(Cook+Maint)/2, Garden/Kennel/Rabbit↔Caretaking.
        // getLocationEfficiency(state, locId): no worker = 50%; with worker = 50% + 50%×(effective skill/100). Used for
        // harvest, forage, patrol/hunt/combat loot, cook/craft success, kennel clean, rabbit care yields.
        // Fear: daily delta from wolf fear, escape, full moon, bond>60, securityLevel>50. Fear≥90: quit chance, incidents.
        // Security level (state.securityLevel 0–100): +2 patrol, +1 hunt/repair, −15 escape; high security reduces fear.
        // ============================================================================
        var LOC_TO_ASSIGNMENT = { clearing: 'Clearing', garden: 'Garden', kennel: 'Kennel', rabbit_farm: 'Rabbit Farm', crafting: 'Crafting', command_center: 'Command Center' };
        var ASSIGNMENT_TO_LOC = { 'Clearing': 'clearing', 'Garden': 'garden', 'Kennel': 'kennel', 'Rabbit Farm': 'rabbit_farm', 'Crafting': 'crafting', 'Command Center': 'command_center' };
        function getSkillForTab(worker, tabName) {
            var t = tabName || '';
            if (t === 'kennel') return worker.caretaking || 5;
            if (t === 'crafting') return ((worker.cooking || 5) + (worker.maintenance || 5)) / 2;
            if (t === 'garden' || t === 'rabbit_farm') return worker.caretaking || 5;
            if (t === 'clearing') return worker.security || 5;
            if (t === 'command_center') return worker.security || 5;
            return 5;
        }
        function getEffectiveSkill(worker, tabName) {
            var base = getSkillForTab(worker, tabName);
            var fearPenalty = 1 - (worker.fear || 0) / 200;
            var eff = base * fearPenalty * 10;
            if (worker.injured) eff *= 0.7;
            eff *= 1 - (worker.effectivenessPenalty || 0);
            return Math.max(0, Math.min(100, Math.round(eff)));
        }
        // Who's on duty here? Returns the worker assigned to this tab, or null. Used for "Worker: Sarah (Caretaker)" and repair quality.
        function getAssignedWorker(state, locId) {
            var want = LOC_TO_ASSIGNMENT[locId];
            return (state.workers || []).filter(function(w) { return (w.assignment || '') === want; })[0] || null;
        }
        // No worker = 50% efficiency; with worker = 50% + 50% * (effective skill/100). Used for yields and effects per tab.
        function getLocationEfficiency(state, locId) {
            var aw = getAssignedWorker(state, locId);
            if (!aw) return 0.5;
            var eff = getEffectiveSkill(aw, locId);
            return 0.5 + 0.5 * (eff / 100);
        }

        function getTimeString(world) {
            var totalMins = Math.floor(world.worldTime || 0);
            var hours = Math.floor(totalMins / 60) % 24;
            var mins = totalMins % 60;
            var period = hours >= 12 ? 'PM' : 'AM';
            var h = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
            return world.timeOfDay.charAt(0).toUpperCase() + world.timeOfDay.slice(1) + ' — ' + h + ':' + String(mins).padStart(2, '0') + ' ' + period;
        }

        // ============================================================================
        // TRANSFORMATION - Fear affects shift rate and stats. Moon + needs = how wolfy they get.
        // ============================================================================
        function getFearMultipliers(fear) {
            var f = fear || 0;
            if (f <= 30) return { stats: 1, shiftRate: 0, escapeRisk: false };
            if (f <= 60) return { stats: 0.95, shiftRate: 0.1, escapeRisk: false };
            if (f <= 80) return { stats: 0.9, shiftRate: 0.2, escapeRisk: false };
            return { stats: 0.85, shiftRate: 0.3, escapeRisk: true };
        }
        function calculateShiftLevel(pet, world) {
            var shift = world.moonIllumination * 100 * pet.moonAffinity;
            shift += (100 - pet.transformationControl) * 0.08;
            var needsBonus = ((100 - (pet.hunger || 0)) * 0.2 + (100 - (pet.thirst || 50)) * 0.2 + (pet.fear || 0) * 0.1) / 100;
            shift += needsBonus * 20;
            var fearM = getFearMultipliers(pet.fear);
            shift *= (1 + fearM.shiftRate);
            shift *= (1 + (pet.shiftRateModifier || 0));
            return Math.min(100, Math.max(0, shift));
        }

        function getForm(shiftLevel) {
            if (shiftLevel <= CONFIG.shiftThresholds.human) return 'human';
            if (shiftLevel <= CONFIG.shiftThresholds.hybrid) return 'hybrid';
            return 'wolf';
        }

        function updatePetForm(pet, world) {
            var prevForm = pet.form;
            if (world.timeOfDay === 'dawn' || world.timeOfDay === 'day') {
                pet.shiftLevel = 0;
                pet.form = 'human';
            } else {
                pet.shiftLevel = calculateShiftLevel(pet, world);
                if (world.moonPhase === 'full') pet.shiftLevel = Math.max(pet.shiftLevel, 75);
                pet.form = getForm(pet.shiftLevel);
                if ((pet.form === 'wolf' || pet.form === 'hybrid') && prevForm === 'human')
                    pet.fear = Math.max(0, Math.floor((pet.fear || 0) * 0.5));
            }
        }

        // ============================================================================
        // ACTIONS — Queues and "do the thing"
        // Each tab (Clearing, Kennel, etc.) has its own queue. Max 3 items: one running + 2 waiting.
        // Want longer queues? Change MAX_QUEUE_PER_TAB. Want instant actions? Set ACTION_SPECS[id].instant = true.
        // ============================================================================
        var MAX_QUEUE_PER_TAB = 3;
        function getQueueForLoc(state, locId) {
            state.actionByLocation = state.actionByLocation || { clearing: [], garden: [], kennel: [], rabbit_farm: [], crafting: [] };
            var raw = state.actionByLocation[locId];
            if (!raw) { state.actionByLocation[locId] = []; return state.actionByLocation[locId]; }
            if (Array.isArray(raw)) {
                raw = raw.filter(function(x) { return x && x.id; }).slice(0, MAX_QUEUE_PER_TAB);
                state.actionByLocation[locId] = raw;
                return raw;
            }
            state.actionByLocation[locId] = [raw];
            return state.actionByLocation[locId];
        }
        // Player clicked a button. We queue the action (or run it right away if "instant"). Timer does the rest.
        function startAction(state, actionId, addStory) {
            var spec = ACTION_SPECS[actionId];
            if (!spec) return;
            var locId = state.currentLocation || (ACTION_LOCATION[actionId] || 'clearing');
            var queue = getQueueForLoc(state, locId);
            if (queue.length >= MAX_QUEUE_PER_TAB) {
                if (typeof addStory === 'function') addStory('The queue is full. One thing at a time.');
                if (typeof render === 'function') render();
                return;
            }
            if (spec.instant) {
                executeAction(state, actionId, addStory, locId);
                return;
            }
            var ms = (spec.realSec * 1000) / (gameSpeed || 1);
            if (queue.length === 0) {
                queue.push({ id: actionId, busyUntil: Date.now() + ms, gameMin: spec.gameMin });
            } else {
                queue.push({ id: actionId, gameMin: spec.gameMin });
            }
            if (actionId === 'cook' || actionId === 'craft_medicine' || actionId === 'cook_plants') state.grillOn = true;
            if (typeof addStory === 'function') addStory(queue.length === 1 ? actionId.replace(/_/g, ' ') + ' started.' : actionId.replace(/_/g, ' ') + ' queued.');
            if (typeof render === 'function') render();
        }

        // The actual "do the thing." Feed, heal, hunt, repair—every action eventually calls one of the do* functions below.
        // Add a new action? Add a case here and write a doMyNewAction(state, addStory) function.
        function executeAction(state, actionId, addStory, locId) {
            var timeOfDayBefore = state.world && state.world.timeOfDay;
            advanceTime(state, ACTION_SPECS[actionId] ? ACTION_SPECS[actionId].gameMin : 30);
            switch (actionId) {
                case 'rest': doRest(state, addStory); break;
                case 'train': doTrain(state, addStory); break;
                case 'feed': doFeed(state, addStory); break;
                case 'feed_raw_meat': doFeedRawMeat(state, addStory); break;
                case 'feed_plants': doFeedPlants(state, addStory); break;
                case 'feed_cooked_meat': doFeedCookedMeat(state, addStory); break;
                case 'feed_cooked_plants': doFeedCookedPlants(state, addStory); break;
                case 'water': doWater(state, addStory); break;
                case 'heal': doHeal(state, addStory); break;
                case 'ritual': doRitual(state, addStory); break;
                case 'bond': doBond(state, addStory); break;
                case 'sleep': doSleep(state, addStory); break;
                case 'forage':
                    runMission(state, 'forage', addStory, addCombatLog);
                    document.getElementById('combat-log-container').style.display = 'none';
                    break;
                case 'patrol':
                    document.getElementById('combat-log-container').style.display = 'block';
                    document.getElementById('combat-log').innerHTML = '';
                    runMission(state, 'patrol', addStory, function() {});
                    break;
                case 'hunt':
                    document.getElementById('combat-log-container').style.display = 'block';
                    document.getElementById('combat-log').innerHTML = '';
                    runMission(state, 'hunt', addStory, function() {});
                    break;
                case 'clean_kennels': doCleanKennels(state, addStory); break;
                case 'water_garden': doWaterGarden(state, addStory); break;
                case 'plant': doPlant(state, addStory); break;
                case 'harvest': doHarvest(state, addStory); break;
                case 'add_compost': doAddCompost(state, addStory); break;
                case 'feed_rabbit': doFeedRabbit(state, addStory); break;
                case 'water_rabbit': doWaterRabbit(state, addStory); break;
                case 'clean_rabbit': doCleanRabbit(state, addStory); break;
                case 'treat_rabbit': doTreatRabbit(state, addStory); break;
                case 'cook': doCook(state, addStory); break;
                case 'craft_medicine': doCraftMedicine(state, addStory); break;
                case 'cook_plants': doCookPlants(state, addStory); break;
                case 'capture_rabbit': doCaptureRabbit(state, addStory); break;
                case 'harvest_rabbit': doHarvestRabbit(state, addStory); break;
                case 'breed_rabbit': doBreedRabbit(state, addStory); break;
                case 'set_rabbit_traps': doSetRabbitTraps(state, addStory); break;
                case 'check_traps': doCheckTraps(state, addStory); break;
                case 'craft_rabbit_trap': doCraftRabbitTrap(state, addStory); break;
                case 'craft_net': doCraftNet(state, addStory); break;
                case 'craft_bait': doCraftBait(state, addStory); break;
                case 'craft_premium_bait': doCraftPremiumBait(state, addStory); break;
                case 'hike_creek': doHikeCreek(state, addStory); break;
                case 'collect_rain': doCollectRain(state, addStory); break;
                case 'craft_rain_catcher': doCraftRainCatcher(state, addStory); break;
                case 'repair_clearing': case 'repair_kennel': case 'repair_garden': case 'repair_rabbit_farm': case 'repair_crafting':
                    doRepair(state, actionId.replace('repair_', ''), addStory); break;
                default: break;
            }
            if (actionId === 'cook' || actionId === 'craft_medicine' || actionId === 'cook_plants') {
                var craftQ = getQueueForLoc(state, 'crafting');
                var anyCooking = craftQ.some(function(s) { return ['cook', 'craft_medicine', 'cook_plants'].indexOf(s.id) >= 0; });
                if (!anyCooking) state.grillOn = false;
            }
            if (timeOfDayBefore === 'night') { state.stats = state.stats || {}; state.stats.nightActions = (state.stats.nightActions || 0) + 1; }
            if (timeOfDayBefore === 'dawn') { state.stats = state.stats || {}; state.stats.dawnActions = (state.stats.dawnActions || 0) + 1; }
            checkAllRelevantAchievements(state, addStory);
            if (typeof render === 'function') render();
        }

        // --- Care & rest (kennel / clearing) ---
        function doRest(state, addStory) {
            const pet = state.pet;
            if ((pet.sleep ?? 100) <= 0) { addStory(pet.name + '\'s eyes won\'t stay open. Put them to sleep in the kennel.'); return; }
            if (pet.energy >= pet.maxEnergy && pet.hp >= pet.maxHp) { addStory(pet.name + ' is already dozing. No need to rest.'); return; }
            pet.energy = Math.min(pet.maxEnergy, pet.energy + 25);
            pet.hp = Math.min(pet.maxHp, pet.hp + 15);
            pet.fear = Math.max(0, pet.fear - 5);
            addStory(pet.name + ' rests. Energy returns; wounds knit.');
        }

        // Training: costs stamina and energy, gives +1 to a random stat (strength/speed/endurance).
        function doTrain(state, addStory) {
            const pet = state.pet;
            var staminaCost = STAMINA_COST.train || 15;
            if ((pet.stamina ?? 100) < staminaCost) { addStory('Not enough stamina.'); return; }
            if (pet.energy < 20) { addStory('Not enough energy to train.'); return; }
            pet.stamina = Math.max(0, (pet.stamina ?? 100) - staminaCost);
            pet.energy = Math.max(0, pet.energy - 20);
            const stats = ['strength', 'speed', 'endurance'];
            const pick = stats[Math.floor(Math.random() * stats.length)];
            pet[pick] = Math.min(20, pet[pick] + 1);
            pet.xp += 12;
            addStory(pet.name + ' trains. ' + pick + ' improves.');
            if (state.trainingDummyDamagedUntil == null) state.trainingDummyDamagedUntil = 0;
            state.trainingDummyDamagedUntil = Date.now() + 1000;
            tryLevelUp(state, addStory);
        }

        function doFeed(state, addStory) {
            var inv = state.inventory;
            var pet = state.pet;
            if ((inv.rawMeat || 0) >= 1) { doFeedRawMeat(state, addStory); return; }
            if ((inv.cookedMeat || 0) >= 1) { doFeedCookedMeat(state, addStory); return; }
            if ((inv.cookedVegetables || 0) >= 1) { doFeedCookedPlants(state, addStory); return; }
            if ((inv.plants || 0) >= 1) { doFeedPlants(state, addStory); return; }
            addStory('Nothing in the pack that ' + pet.name + ' can eat right now.'); }
        function updateWolfConsecutiveDays(state, addStory) {
            var d = state.world.currentDay;
            var last = state.lastWolfFedDay || 0;
            state.consecutiveDaysWolfFed = (d === last + 1) ? (state.consecutiveDaysWolfFed || 0) + 1 : 1;
            state.lastWolfFedDay = d;
            checkAchievement(state, 'calm_wolf', addStory);
        }
        function doFeedRawMeat(state, addStory) {
            var inv = state.inventory; var pet = state.pet;
            if ((inv.rawMeat || 0) < 1) { addStory('No raw meat.'); return; }
            inv.rawMeat--; state._wolfHungerWarned50 = false; pet.hunger = Math.max(0, (pet.hunger || 0) - 35);
            if (pet.form === 'human') { pet.sickness = Math.min(100, (pet.sickness || 0) + 25); pet.shiftRateModifier = (pet.shiftRateModifier || 0) + 0.5; addStory(pet.name + ' ate raw meat and got sick. Shift meter will fill faster until healed.'); }
            else if (pet.form === 'wolf') { pet.bond = Math.min(100, (pet.bond || 50) + 2); addStory('You fed ' + pet.name + ' raw meat. They seem satisfied.'); }
            else { pet.hunger = Math.max(0, pet.hunger - 5); addStory('You fed ' + pet.name + ' raw meat. Hybrid takes it well.'); }
            updateWolfConsecutiveDays(state, addStory);
        }
        function doFeedPlants(state, addStory) {
            var inv = state.inventory; var pet = state.pet;
            if ((inv.plants || 0) < 1) { addStory('No plants.'); return; }
            inv.plants--; state._wolfHungerWarned50 = false; pet.hunger = Math.max(0, (pet.hunger || 0) - 30);
            if (pet.form === 'wolf') { pet.sickness = Math.min(100, (pet.sickness || 0) + 25); addStory('Wrong diet. ' + pet.name + ' got sick from plants.'); }
            else { if (pet.sickness > 0) pet.sickness = Math.max(0, pet.sickness - 5); addStory('You fed ' + pet.name + ' plants. Hunger eases.'); }
            updateWolfConsecutiveDays(state, addStory);
        }
        function doFeedCookedMeat(state, addStory) {
            var inv = state.inventory; var pet = state.pet;
            if ((inv.cookedMeat || 0) < 1) { addStory('No cooked meat.'); return; }
            inv.cookedMeat--; state._wolfHungerWarned50 = false; pet.hunger = Math.max(0, (pet.hunger || 0) - 35);
            if (pet.form === 'wolf') { pet.sickness = Math.min(100, (pet.sickness || 0) + 25); addStory('Wrong diet. ' + pet.name + ' got sick from cooked meat.'); }
            else { pet.bond = Math.min(100, (pet.bond || 50) + 3); if (pet.sickness > 0) pet.sickness = Math.max(0, pet.sickness - 5); addStory('You fed ' + pet.name + ' cooked meat. Bond deepens.'); }
            updateWolfConsecutiveDays(state, addStory);
        }
        function doFeedCookedPlants(state, addStory) {
            var inv = state.inventory; var pet = state.pet;
            if ((inv.cookedVegetables || 0) < 1) { addStory('No cooked vegetables. Cook plants at the grill.'); return; }
            inv.cookedVegetables = (inv.cookedVegetables || 0) - 1; state._wolfHungerWarned50 = false; pet.hunger = Math.max(0, (pet.hunger || 0) - 35);
            if (pet.form === 'wolf') { pet.sickness = Math.min(100, (pet.sickness || 0) + 25); addStory('Wrong diet. ' + pet.name + ' got sick from cooked plants.'); }
            else { pet.bond = Math.min(100, (pet.bond || 50) + 3); pet.fear = Math.max(0, (pet.fear || 0) - 5); if (pet.sickness > 0) pet.sickness = Math.max(0, pet.sickness - 5); addStory('You fed ' + pet.name + ' cooked plants. Bond up, fear down.'); }
            updateWolfConsecutiveDays(state, addStory);
        }

        function doWater(state, addStory) {
            var inv = state.inventory || {};
            if ((inv.water || 0) < 1) { addStory('No water. Hike to creek or collect from rain catcher.'); return; }
            inv.water = (inv.water || 0) - 1;
            const pet = state.pet;
            state._wolfThirstWarned50 = false;
            pet.thirst = Math.max(0, (pet.thirst || 50) - 35);
            pet.bond = Math.min(100, (pet.bond || 50) + 2);
            pet.spiritAlignment = Math.min(100, (pet.spiritAlignment || 0) + 1);
            addStory(pet.name + ' drinks deeply. The empty bowl is forgotten.');
            updateWolfConsecutiveDays(state, addStory);
        }

        function doHeal(state, addStory) {
            if ((state.inventory.meds || 0) < 1) { addStory('No medicine left.'); return; }
            const pet = state.pet;
            state.inventory.meds--;
            pet.hp = Math.min(pet.maxHp, pet.hp + 40);
            pet.sickness = Math.max(0, (pet.sickness || 0) - 40);
            if (pet.sickness <= 0) pet.shiftRateModifier = 0;
            addStory('You tend to ' + pet.name + '. The wounds close; they breathe easier.');
        }

        function doRitual(state, addStory) {
            if (state.inventory.materials < 1) { addStory('No materials for the ritual.'); return; }
            const pet = state.pet;
            state.inventory.materials--;
            pet.fear = Math.max(0, pet.fear - 20);
            pet.transformationControl = Math.min(100, pet.transformationControl + 2);
            addStory('The ritual steadies ' + pet.name + '. Fear recedes.');
        }

        function doBond(state, addStory) {
            const pet = state.pet;
            var cost = STAMINA_COST.bond || 5;
            if ((pet.stamina ?? 100) < cost) { addStory('Not enough stamina.'); return; }
            pet.stamina = Math.max(0, (pet.stamina ?? 100) - cost);
            pet.bond = Math.min(100, pet.bond + (pet.lifeStage === 'pup' ? 7 : 5));
            pet.morale = Math.min(100, (pet.morale || 70) + 5);
            pet.fear = Math.max(0, pet.fear - 3);
            pet.spiritAlignment = Math.min(100, (pet.spiritAlignment || 0) + 1);
            addStory('You sit with ' + pet.name + '. For a moment, the world outside doesn\'t matter.');
        }
        function doSleep(state, addStory) {
            const pet = state.pet;
            if ((pet.sleep ?? 100) >= 95) { addStory(pet.name + '\'s eyes are bright. They\'re not tired yet.'); return; }
            pet.sleep = Math.min(100, (pet.sleep ?? 100) + 50);
            pet.stamina = Math.min(pet.maxStamina || 100, (pet.stamina ?? 100) + 30);
            pet.energy = Math.min(pet.maxEnergy, (pet.energy || 100) + 15);
            addStory(pet.name + ' curls up and sleeps. Their breathing slows.');
        }

        function doCleanKennels(state, addStory) {
            var waste = state.kennelWaste || 0;
            if (waste <= 0) { addStory('Kennel is already clean.'); return; }
            var eff = getLocationEfficiency(state, 'kennel');
            state.kennelWaste = Math.max(0, waste - 1);
            state.kennelClean = Math.min(100, (state.kennelClean || 100) + Math.round(40 * eff));
            var gotCompost = Math.random() < eff;
            state.inventory.compostUnits = (state.inventory.compostUnits || 0) + (gotCompost ? 1 : 0);
            var comp = state.compost || { level: 0, readyInDays: 3 };
            comp.level = Math.min(100, (comp.level || 0) + Math.round(25 * eff));
            if (comp.readyInDays <= 0) comp.readyInDays = 3;
            state.compost = comp;
            addStory('Kennels cleaned.' + (gotCompost ? ' +1 compost.' : ''));
        }

        function updateGardenConsecutiveDays(state, addStory) {
            var d = state.world.currentDay;
            var last = state.lastGardenTendedDay || 0;
            state.consecutiveDaysGardenTended = (d === last + 1) ? (state.consecutiveDaysGardenTended || 0) + 1 : 1;
            state.lastGardenTendedDay = d;
            checkAchievement(state, 'old_mac', addStory);
        }
        function doWaterGarden(state, addStory) {
            var garden = state.garden || { crops: [], watered: false, dying: false };
            garden.watered = true;
            if (garden.dying) { garden.dying = false; addStory('Garden watered. Crops saved from dying.'); }
            else addStory('Garden watered.');
            state.garden = garden;
            updateGardenConsecutiveDays(state, addStory);
        }

        function doPlant(state, addStory) {
            var garden = state.garden || { crops: [], watered: false, dying: false };
            if ((state.inventory.seeds || 0) < 1) { addStory('No seeds.'); return; }
            if (garden.crops && garden.crops.length > 0) { addStory('Already something growing.'); return; }
            state.inventory.seeds--;
            garden.crops = [{ name: 'Carrots', daysLeft: 3 }];
            garden.watered = false;
            state.garden = garden;
            updateGardenConsecutiveDays(state, addStory);
            addStory('Planted seeds. Water daily.');
        }

        // Add compost to growing crops to speed growth. Use inventory compostUnits (from kennel/rabbit cleaning) or bin.
        function doAddCompost(state, addStory) {
            var inv = state.inventory || {};
            var garden = state.garden || { crops: [] };
            if (!garden.crops || !garden.crops.length) { addStory('No crops to fertilize.'); return; }
            if ((inv.compostUnits || 0) >= 1) {
                inv.compostUnits = (inv.compostUnits || 0) - 1;
                var c = garden.crops[0];
                if (c.daysLeft != null && c.daysLeft > 0) c.daysLeft = Math.max(0, c.daysLeft - 1);
                state.garden = garden;
                updateGardenConsecutiveDays(state, addStory);
                addStory('Compost applied. Crops grow faster.');
                return;
            }
            var comp = state.compost || { level: 0, readyInDays: 3 };
            if (comp.readyInDays > 0 || (comp.level || 0) < 25) { addStory('No compost units. Clean kennel or rabbit cage for more.'); return; }
            comp.level = Math.max(0, (comp.level || 0) - 25);
            if (comp.readyInDays <= 0) comp.readyInDays = 3;
            state.compost = comp;
            var c = garden.crops[0];
            if (c.daysLeft != null && c.daysLeft > 0) c.daysLeft = Math.max(0, c.daysLeft - 1);
            state.garden = garden;
            updateGardenConsecutiveDays(state, addStory);
            addStory('Compost applied. Crops grow faster.');
        }
        function doHarvest(state, addStory) {
            var garden = state.garden || { crops: [] };
            if (!garden.crops || !garden.crops.length) { addStory('Nothing to harvest.'); return; }
            var c = garden.crops[0];
            if ((c.daysLeft || 0) > 0) { addStory('Not ready yet.'); return; }
            var eff = getLocationEfficiency(state, 'garden');
            var workerBonus = 0;
            var assigned = (state.workers || []).filter(function(w) { return w.assignment === 'Garden'; })[0];
            if (assigned && (assigned.caretaking || 0) >= 5) workerBonus = 1;
            var plantsGain = Math.max(0, Math.floor((2 + workerBonus) * eff));
            state.inventory.plants = (state.inventory.plants || 0) + plantsGain;
            if (Math.random() < (0.5 + (assigned && assigned.caretaking >= 7 ? 0.15 : 0)) && Math.random() < eff) state.inventory.seeds = (state.inventory.seeds || 0) + 1;
            garden.crops = [];
            state.garden = garden;
            state.stats.cropsHarvested = (state.stats.cropsHarvested || 0) + 1;
            updateGardenConsecutiveDays(state, addStory);
            checkAchievement(state, 'green_thumb', addStory);
            addStory('Harvested. Got ' + plantsGain + ' plants' + (state.inventory.seeds ? ', saved seeds.' : '.') + (workerBonus ? ' (worker bonus.)' : ''));
        }

        function doFeedRabbit(state, addStory) {
            if (state.rabbitCount < 1) { addStory('No rabbit.'); return; }
            if ((state.inventory.plants || 0) < 1 && (state.inventory.food || 0) < 1) { addStory('No food for rabbit.'); return; }
            var eff = getLocationEfficiency(state, 'rabbit_farm');
            var r = state.rabbit || { hunger: 30 };
            r.lastFedDay = state.world.currentDay;
            state._rabbitHungerWarned50 = false;
            if (state.inventory.plants >= 1) { state.inventory.plants--; r.hunger = Math.max(0, r.hunger - Math.round(40 * eff)); }
            else { state.inventory.food--; r.hunger = Math.max(0, r.hunger - Math.round(40 * eff)); }
            state.rabbit = r;
            var d = state.world.currentDay;
            var lastR = state.lastRabbitCareDay || 0;
            state.consecutiveDaysRabbitFed = (d === lastR + 1) ? (state.consecutiveDaysRabbitFed || 0) + 1 : 1;
            state.lastRabbitCareDay = d;
            checkAchievement(state, 'rabid_routine', addStory);
            addStory('Rabbit fed.');
        }

        // ============================================================================
        // RABBIT FARM - The Fuzzy Factory
        // ============================================================================
        // Loop: Craft trap → Set trap (Clearing) → Wait ~2 min → Check traps (catch/break/empty).
        // Bait/Premium Bait consumed when checking traps for higher catch chance.
        // Farm: Feed, water, clean daily. Lonely (1 rabbit) = sick creep; 2+ = small recovery.
        // Dirty cage = sickness chance + penalty; harvest = 2–4 raw meat per rabbit; breed = 2+ healthy, 2–4 babies, cap 10.
        // ============================================================================
        // Rabbits: food source (raw meat), responsibility (die if neglected), surprisingly complicated.
        // We could have made "click to get meat." Instead: feed/water/clean/treat/breed/harvest.
        // If neglected: sick -> dead -> empty cage. Tough love.
        // Capture rabbits: Set Rabbit Traps (Clearing; craft trap first) or Capture rabbit (farm when empty). Net = recapture escaped wolf; Bait/Premium Bait = better trap catch when checking.
        // ============================================================================

        function doWaterRabbit(state, addStory) {
            if (state.rabbitCount < 1) { addStory('No rabbit.'); return; }
            var eff = getLocationEfficiency(state, 'rabbit_farm');
            var r = state.rabbit || { thirst: 30 };
            r.thirst = Math.max(0, r.thirst - Math.round(40 * eff));
            r.lastWaterDay = state.world.currentDay;
            state.rabbit = r;
            var d = state.world.currentDay;
            var lastR = state.lastRabbitCareDay || 0;
            state.consecutiveDaysRabbitFed = (d === lastR + 1) ? (state.consecutiveDaysRabbitFed || 0) + 1 : 1;
            state.lastRabbitCareDay = d;
            checkAchievement(state, 'rabid_routine', addStory);
            addStory('Rabbit watered.');
        }

        function doCleanRabbit(state, addStory) {
            if (state.rabbitCount < 1) { addStory('No rabbit.'); return; }
            var eff = getLocationEfficiency(state, 'rabbit_farm');
            var r = state.rabbit || { clean: 80 };
            r.clean = Math.min(100, r.clean + Math.round(50 * eff));
            r.lastCleanDay = state.world.currentDay;
            state.rabbit = r;
            var gotCompost = Math.random() < eff;
            if (gotCompost) state.inventory.compostUnits = (state.inventory.compostUnits || 0) + 1;
            addStory('Rabbit cage cleaned.' + (gotCompost ? ' +1 compost.' : ''));
        }

        function doTreatRabbit(state, addStory) {
            if (state.rabbitCount < 1) { addStory('No rabbit.'); return; }
            if ((state.inventory.meds || 0) < 1) { addStory('No medicine.'); return; }
            var eff = getLocationEfficiency(state, 'rabbit_farm');
            var r = state.rabbit || { sick: 0 };
            state.inventory.meds--;
            r.sick = Math.max(0, r.sick - Math.round(50 * eff));
            state.rabbit = r;
            addStory('Rabbit treated with medicine.');
        }

        function doCook(state, addStory) {
            if ((state.inventory.rawMeat || 0) < 1) { addStory('No raw meat to cook.'); return; }
            state.inventory.rawMeat--;
            var eff = getLocationEfficiency(state, 'crafting');
            var success = Math.random() < eff;
            if (success) state.inventory.cookedMeat = (state.inventory.cookedMeat || 0) + 1;
            addStory(success ? 'Meat cooked. Safe for human form.' : 'Cooking didn\'t turn out—no skilled worker at the grill.');
        }
        function doCookPlants(state, addStory) {
            if ((state.inventory.plants || 0) < 1) { addStory('No plants to cook.'); return; }
            state.inventory.plants--;
            var eff = getLocationEfficiency(state, 'crafting');
            var success = Math.random() < eff;
            if (success) state.inventory.cookedVegetables = (state.inventory.cookedVegetables || 0) + 1;
            state.stats.plantsCooked = (state.stats.plantsCooked || 0) + (success ? 1 : 0);
            checkAchievement(state, 'you_bait', addStory);
            if (success && state.pet) {
                var pet = state.pet;
                pet.bond = Math.min(100, (pet.bond || 0) + 2);
                pet.fear = Math.max(0, (pet.fear || 0) - 3);
                if (pet.thirst != null) pet.thirst = Math.max(0, (pet.thirst || 0) - 10);
            }
            addStory(success ? 'Cooked plants. Bond and fear ease; cooked vegetables in inventory.' : 'Cooking didn\'t turn out—assign a worker to Crafting.');
        }

        function doCraftMedicine(state, addStory) {
            if ((state.inventory.herbs || 0) < 1 || (state.inventory.materials || 0) < 1) { addStory('Need herbs and materials.'); return; }
            state.inventory.herbs--;
            state.inventory.materials--;
            var eff = getLocationEfficiency(state, 'crafting');
            var success = Math.random() < eff;
            if (success) state.inventory.meds = (state.inventory.meds || 0) + 1;
            state.stats = state.stats || {};
            if (success) state.stats.medsCrafted = (state.stats.medsCrafted || 0) + 1;
            addStory(success ? 'Medicine crafted (herbs + water).' : 'Crafting failed—assign a worker to Crafting for better results.');
            checkAchievement(state, 'dammit_jim', addStory);
        }

        // --- Rabbit trap system (Clearing): set trap → queue "check traps" → resolve after ~2 min ---
        // Consumes 1 rabbit trap; adds check_traps to clearing queue. Timer runs in game tick; on completion doCheckTraps runs.
        function doSetRabbitTraps(state, addStory) {
            var inv = state.inventory || {};
            if ((inv.rabbitTrap || 0) < 1) { addStory('No traps. Craft one first (3 materials + 2 plants).'); return; }
            inv.rabbitTrap = (inv.rabbitTrap || 0) - 1;
            var queue = getQueueForLoc(state, 'clearing');
            if (queue.length >= MAX_QUEUE_PER_TAB) { inv.rabbitTrap++; addStory('Queue full. One thing at a time.'); return; }
            var ms = (120 * 1000) / (gameSpeed || 1);  // 2 real minutes until check
            queue.push({ id: 'check_traps', busyUntil: Date.now() + ms, gameMin: 120 });
            addStory('Traps set. Check back in a couple of hours.');
        }

        // Check traps: 45% base catch, 15% trap broken, 40% empty. Premium Bait +20% catch (consumed), Bait +15% (consumed), cap 85%.
        // On catch: add rabbit, 30% chance to get trap back. On empty: 50% chance to recover trap.
        function doCheckTraps(state, addStory) {
            var roll = Math.random();
            var baseCatch = 0.45, trapBreak = 0.15;
            var inv = state.inventory || {};
            if ((inv.premiumBait || 0) >= 1) { inv.premiumBait = (inv.premiumBait || 0) - 1; baseCatch += 0.2; }
            else if ((inv.bait || 0) >= 1) { inv.bait = (inv.bait || 0) - 1; baseCatch += 0.15; }
            baseCatch = Math.min(0.85, baseCatch);
            if (roll < baseCatch) {
                var n = state.rabbitCount || 0;
                if (n === 0) {
                    state.rabbitCount = 1;
                    state.rabbit = { hunger: 30, thirst: 30, clean: 80, sick: 0, lastFedDay: (state.world && state.world.currentDay) || 1, lastWaterDay: (state.world && state.world.currentDay) || 1, lastCleanDay: (state.world && state.world.currentDay) || 1 };
                } else {
                    state.rabbitCount = n + 1;
                    if (state.rabbit) { state.rabbit.lastFedDay = state.world.currentDay; state.rabbit.lastWaterDay = state.world.currentDay; state.rabbit.lastCleanDay = state.world.currentDay; }
                }
                state.stats = state.stats || {};
                state.stats.rabbitsCaptured = (state.stats.rabbitsCaptured || 0) + 1;
                addStory('You caught a rabbit! It\'s now in the rabbit farm.');
                if (Math.random() < 0.3) {
                    state.inventory.rabbitTrap = (state.inventory.rabbitTrap || 0) + 1;
                    addStory('The trap is still usable. Lucky you.');
                }
            } else if (roll < baseCatch + trapBreak) {
                addStory('The trap is broken. Something got away.');
            } else {
                addStory('No rabbits today. The trap is empty.');
                if (Math.random() < 0.5) {
                    state.inventory.rabbitTrap = (state.inventory.rabbitTrap || 0) + 1;
                    addStory('You recovered the intact trap.');
                }
            }
        }

        // Rabbit Trap = 3 materials + 2 plants. Craft in Crafting tab; set in Clearing.
        function doCraftRabbitTrap(state, addStory) {
            var inv = state.inventory || {};
            if ((inv.materials || 0) < 3) { addStory('Need 3 materials.'); return; }
            if ((inv.plants || 0) < 2) { addStory('Need 2 plants (vines).'); return; }
            inv.materials = (inv.materials || 0) - 3;
            inv.plants = (inv.plants || 0) - 2;
            inv.rabbitTrap = (inv.rabbitTrap || 0) + 1;
            addStory('Rabbit trap crafted. Set it in the Clearing.');
        }

        // Net = 5 materials + 3 plants. Required to "Bring back" escaped wolf on hunt/patrol; 15% chance it breaks on use.
        function doCraftNet(state, addStory) {
            var inv = state.inventory || {};
            if ((inv.materials || 0) < 5) { addStory('Need 5 materials.'); return; }
            if ((inv.plants || 0) < 3) { addStory('Need 3 plants (vines).'); return; }
            inv.materials = (inv.materials || 0) - 5;
            inv.plants = (inv.plants || 0) - 3;
            inv.net = (inv.net || 0) + 1;
            addStory('Net crafted. Use on hunt/patrol to recapture an escaped wolf.');
        }

        // Bait = 2 cooked veg OR 1 raw meat. Consumed automatically when checking traps (better catch chance).
        function doCraftBait(state, addStory) {
            var inv = state.inventory || {};
            if ((inv.cookedVegetables || 0) >= 2) {
                inv.cookedVegetables = (inv.cookedVegetables || 0) - 2;
            } else if ((inv.rawMeat || 0) >= 1) {
                inv.rawMeat = (inv.rawMeat || 0) - 1;
            } else {
                addStory('Need 2 cooked veg or 1 raw meat.');
                return;
            }
            inv.bait = (inv.bait || 0) + 1;
            addStory('Bait crafted. Use when setting traps for better catch chance.');
        }

        // Premium Bait = 1 cooked meat + 1 herbs. Consumed when checking traps for highest catch bonus.
        function doCraftPremiumBait(state, addStory) {
            var inv = state.inventory || {};
            if ((inv.cookedMeat || 0) < 1) { addStory('Need 1 cooked meat.'); return; }
            if ((inv.herbs || 0) < 1) { addStory('Need 1 herbs.'); return; }
            inv.cookedMeat = (inv.cookedMeat || 0) - 1;
            inv.herbs = (inv.herbs || 0) - 1;
            inv.premiumBait = (inv.premiumBait || 0) + 1;
            addStory('Premium bait crafted. Best chance when checking traps.');
        }

        // Manual capture (Rabbit Farm when 0 rabbits): 50% success, cap 10 rabbits.
        function doCaptureRabbit(state, addStory) {
            if (state.rabbitCount >= 10) { addStory('Too many rabbits already.'); return; }
            var roll = Math.random();
            if (roll > 0.5) {
                addStory('Rabbits escaped. Try again.');
                return;
            }
            var n = state.rabbitCount || 0;
            if (n === 0) {
                state.rabbitCount = 1;
                state.rabbit = { hunger: 30, thirst: 30, clean: 80, sick: 0, lastFedDay: state.world.currentDay, lastWaterDay: state.world.currentDay, lastCleanDay: state.world.currentDay };
            } else {
                state.rabbitCount = n + 1;
                if (state.rabbit) { state.rabbit.lastFedDay = state.world.currentDay; state.rabbit.lastWaterDay = state.world.currentDay; state.rabbit.lastCleanDay = state.world.currentDay; }
            }
            state.stats = state.stats || {};
            state.stats.rabbitsCaptured = (state.stats.rabbitsCaptured || 0) + 1;
            addStory(state.rabbitCount === 1 ? 'You captured a rabbit. Feed and water daily or it will die.' : 'You captured another rabbit.');
            checkAchievement(state, 'rabbit_hoarder', addStory);
        }

        // Harvest: convert all rabbits to raw meat. 2–4 meat per rabbit (base 2, +1 if not sick, +1 if clean & well-fed).
        function doHarvestRabbit(state, addStory) {
            if (state.rabbitCount < 1) { addStory('No rabbit.'); return; }
            try { var rabbitSnd = new Audio('rabbit_grunt.mp3'); rabbitSnd.volume = 0.5; rabbitSnd.play().catch(function() {}); } catch (e) {}
            var r = state.rabbit || {};
            var meatPerRabbit = 2;
            if ((r.sick || 0) < 30) meatPerRabbit++;
            if ((r.clean || 0) > 80 && (r.hunger || 50) < 30) meatPerRabbit++;
            var totalMeat = Math.min(4, meatPerRabbit) * state.rabbitCount;
            state.inventory.rawMeat = (state.inventory.rawMeat || 0) + totalMeat;
            state.rabbitCount = 0;
            state.rabbit = null;
            state.stats.rabbitsHarvested = (state.stats.rabbitsHarvested || 0) + 1;
            checkAchievement(state, 'meat_master', addStory);
            addStory('Harvested ' + totalMeat + ' raw meat. No rabbits remain.');
        }

        // Breed: requires 2+ rabbits, healthy (hunger/thirst ≤70, sick <30, clean ≥70), cap 10. Queued action; on completion adds 2–4 rabbits.
        function doBreedRabbit(state, addStory) {
            if (state.rabbitCount < 2) { addStory('Need at least 2 rabbits to breed.'); return; }
            if (state.rabbitCount >= 10) { addStory('Too many rabbits already.'); return; }
            var r = state.rabbit || {};
            if ((r.sick || 0) >= 30) { addStory('Rabbits too sick to breed. Care for them first.'); return; }
            if ((r.hunger || 50) > 70 || (r.thirst || 50) > 70) { addStory('Rabbits too hungry or thirsty to breed.'); return; }
            if ((r.clean || 80) < 70) { addStory('Cage too dirty. Clean it first.'); return; }
            var newRabbits = 2 + Math.floor(Math.random() * 3);  // 2–4 babies
            state.rabbitCount = Math.min(10, (state.rabbitCount || 0) + newRabbits);
            addStory('Rabbits bred! ' + newRabbits + ' new rabbits born. Feed all daily.');
        }

        function doHikeCreek(state, addStory) {
            var pet = state.pet;
            var staminaCost = STAMINA_COST.hike_creek || 15;
            if ((pet.stamina ?? 100) < staminaCost) { addStory('Not enough stamina.'); return; }
            if ((pet.energy || 100) < 15) { addStory('Not enough energy to hike.'); return; }
            pet.stamina = Math.max(0, (pet.stamina ?? 100) - staminaCost);
            pet.energy = Math.max(0, (pet.energy || 100) - 15);
            state.inventory.water = (state.inventory.water || 0) + 5;
            addStory('Hiked to creek. Collected 5 water.');
        }

        function doCollectRain(state, addStory) {
            if (!state.rainCatcherBuilt) { addStory('No rain catcher built.'); return; }
            state.inventory.water = (state.inventory.water || 0) + 3;
            addStory('Collected 3 water from rain catcher.');
        }

        function doCraftRainCatcher(state, addStory) {
            if (state.rainCatcherBuilt) { addStory('Already built.'); return; }
            var inv = state.inventory || {};
            if ((inv.materials || 0) < 3) { addStory('Need 3 materials (wood + vines).'); return; }
            inv.materials = (inv.materials || 0) - 3;
            state.rainCatcherBuilt = true;
            addStory('Rain catcher built. Collect water from Garden when ready.');
        }

        // ============================================================================
        // REPAIRS — Each tab can break (damaged.clearing, damaged.kennel, etc.). Repair costs materials.
        // getRepairQuality(worker) = Standard / Temporary / Partial / Failed. Better workers = better results.
        // Temporary = might break again soon. Add new repair locations in REPAIR_COST and doRepair's names object.
        // ============================================================================
        function getRepairQuality(worker) {
            var role = (worker && worker.role) ? worker.role : '';
            var roll = Math.random();
            if (role === 'Repair') {
                if (roll < 0.8) return 'Perfect';
                if (roll < 0.95) return 'Standard';
                return 'Temporary';
            }
            if (role === 'Cook') {
                if (roll < 0.3) return 'Standard';
                if (roll < 0.7) return 'Temporary';
                if (roll < 0.9) return 'Partial';
                return 'Failed';
            }
            if (role === 'Security') {
                if (roll < 0.5) return 'Temporary';
                return 'Failed';
            }
            if (role === 'Caretaker') {
                if (roll < 0.8) return 'Standard';
                if (roll < 0.95) return 'Temporary';
                return 'Partial';
            }
            if (role === 'Commander') {
                if (roll < 0.3) return 'Partial';
                return 'Failed';
            }
            if (roll < 0.1) return 'Standard';
            if (roll < 0.3) return 'Temporary';
            if (roll < 0.6) return 'Partial';
            return 'Failed';
        }
        function doRepair(state, locId, addStory) {
            state.damaged = state.damaged || {};
            if (!state.damaged[locId]) { addStory('Nothing to repair here.'); return; }
            var cost = REPAIR_COST[locId] || 2;
            var inv = state.inventory || {};
            if ((inv.materials || 0) < cost) { addStory('Need ' + cost + ' materials to repair.'); return; }
            var aw = getAssignedWorker(state, locId);
            var quality = getRepairQuality(aw);
            var names = { clearing: 'Training dummy', kennel: 'Kennel gate', garden: 'Irrigation', rabbit_farm: 'Rabbit cage', crafting: 'Grill' };
            if (quality === 'Failed') {
                addStory('Repair failed. ' + (aw ? (aw.role + ' wasn\'t up to it.') : 'No skilled worker assigned.') + ' Materials lost.');
                inv.materials = (inv.materials || 0) - cost;
                return;
            }
            inv.materials = (inv.materials || 0) - cost;
            state.damaged[locId] = false;
            state.securityLevel = Math.min(100, (state.securityLevel != null ? state.securityLevel : 50) + 1);
            if (quality === 'Temporary') {
                state.damagedAgainAt = state.damagedAgainAt || {};
                state.damagedAgainAt[locId] = Date.now() + 120000;
                addStory(names[locId] + ' repaired (temporary fix—may break again).');
            } else if (quality === 'Partial') {
                addStory(names[locId] + ' repaired but not perfectly. Works at reduced efficiency.');
            } else {
                addStory(names[locId] + ' repaired.');
            }
        }

        var howlingsSfx = null;
        function playHowl() {
            var sfxOn = document.getElementById('opt-sfx') && document.getElementById('opt-sfx').checked;
            if (!sfxOn) return;
            if (!howlingsSfx) howlingsSfx = loadAudioMain('howlings.mp3');
            howlingsSfx.currentTime = 0;
            howlingsSfx.play().catch(function() {});
        }

        function tryLevelUp(state, addStory) {
            const pet = state.pet;
            if (!pet || pet.xp < pet.xpToNext) return;
            pet.xp -= pet.xpToNext;
            pet.level++;
            pet.xpToNext = CONFIG.xpToNextBase + pet.level * 25;
            pet.maxHp += 5;
            pet.hp = pet.maxHp;
            pet.maxEnergy += 5;
            pet.energy = pet.maxEnergy;
            var stage = getLifeStage(pet.ageInDays);
            var maxAbilities = stage === 'pup' ? 0 : stage === 'adult' ? 2 : 3;
            pet.abilities = pet.abilities || [];
            if (pet.abilities.length < maxAbilities && typeof SPECIAL_ABILITIES !== 'undefined' && SPECIAL_ABILITIES.length && Math.random() < 0.5) {
                var have = pet.abilities.slice();
                var pool = SPECIAL_ABILITIES.filter(function(a) { return have.indexOf(a.id) < 0; });
                if (pool.length) { var pick = pool[Math.floor(Math.random() * pool.length)]; pet.abilities.push(pick.id); addStory(pet.name + ' learned ' + pick.name + '!', 'medium'); }
            }
            addStory(pet.name + ' grows stronger. Level ' + pet.level + '!');
            playHowl();
        }

        // ============================================================================
        // MISSIONS & COMBAT — Where the fur flies (and sometimes the teeth)
        // ============================================================================
        // Forage = loot, no fight. Hunt/patrol = maybe encounter, then FIGHT or RUN.
        // Auto-battle: one choice. Like a dog that mostly walks itself but sometimes needs the treat jar. Or to run.
        //
        // COMBAT FLOW: 1) Encounter -> 2) Choice (fight/run) -> 3) Auto whack until victory or retreat
        // 4) Victory = loot, XP, spirit shift. 5) Defeat = wounded, no loot. 6) Run = spared (spirit +Light).
        // ============================================================================
        // Things that go bump in the clearing. And sometimes bite. (We keep a polite list.)
        // Enemy sounds: all in project root (sounds/ and pictures/ hold only unused assets).
        const ENEMIES = [
            { name: 'Deer', hp: 25, atk: 4, xp: 15, loot: { rawMeat: 1 }, img: 'deer.PNG', sound: 'deer_grunt.mp3', element: 'nature' },
            { name: 'Rabbit', hp: 12, atk: 2, xp: 8, loot: { rawMeat: 1 }, img: 'rabbit.PNG', sound: 'rabbit_grunt.mp3', element: 'nature' },
            { name: 'Wild Boar', hp: 30, atk: 8, xp: 25, loot: { rawMeat: 1 }, img: 'boar.PNG', sound: 'boar_grunt.mp3', element: 'physical' },
            { name: 'Feral Werewolf', hp: 45, atk: 12, xp: 40, loot: { rawMeat: 1 }, img: 'mangy_wolf.png', sound: 'howling.mp3', element: 'dark' },
            { name: 'Shadow Beast', hp: 60, atk: 15, xp: 55, loot: { rawMeat: 0, materials: 1 }, img: 'dark_vampire.PNG', sound: 'growling_monster.mp3', element: 'dark' },
            { name: 'Ghoul', hp: 50, atk: 14, xp: 45, loot: { rawMeat: 0, materials: 1 }, img: 'ghoul.PNG', sound: 'ghoul.mp3', element: 'dark' },
            { name: 'Dark Vampire', hp: 70, atk: 18, xp: 65, loot: { rawMeat: 0, materials: 2 }, img: 'dark_vampire.PNG', sound: 'vampire_attack.mp3', element: 'dark' },
            { name: 'Evil Succubus', hp: 75, atk: 20, xp: 70, loot: { rawMeat: 0, materials: 2 }, img: 'evil_succubus.PNG', sound: 'giggle.mp3', element: 'dark' },
        ];
        function getPetElement(pet) {
            if (!pet || !(pet.abilities || []).length) return 'physical';
            var first = pet.abilities[0];
            var ab = (typeof SPECIAL_ABILITIES !== 'undefined' ? SPECIAL_ABILITIES : []).find(function(a) { return a.id === first; });
            return (ab && ab.element) ? ab.element : 'physical';
        }
        function getElementMultiplier(attackerElement, defenderElement) {
            if (!attackerElement || !defenderElement || attackerElement === 'physical') return 1;
            var adv = typeof ELEMENT_ADVANTAGE !== 'undefined' && ELEMENT_ADVANTAGE[attackerElement];
            if (!adv) return 1;
            if (adv.strong && adv.strong.indexOf(defenderElement) >= 0) return 1.5;
            if (adv.weak && adv.weak.indexOf(defenderElement) >= 0) return 0.75;
            return 1;
        }

        // ============================================================================
        // MISSIONS & COMBAT — Hunt, patrol, forage: go out, maybe meet an enemy, fight or run
        // runMission: uses getSquad(state)[0] for hunt/patrol (stamina/energy from squad leader). Forage uses state.pet.
        // runCombat: primary = getSquad(state)[0]; squad size bonus (+10% damage per ally); traits (Aggressive, Defensive, Thinker, Shy),
        //   element from getPetElement(pet), getElementMultiplier vs enemy; ability proc 20%. ENEMIES have .element.
        // ============================================================================
        function runMission(state, missionType, addStory, addCombatLog) {
            var squad = (missionType === 'hunt' || missionType === 'patrol') ? getSquad(state) : [];
            const pet = (missionType === 'hunt' || missionType === 'patrol') && squad.length ? squad[0] : state.pet;
            if (!pet) { addStory('No wolf selected for this mission.'); return; }
            if (pet.hp < 20) { addStory(pet.name + ' is too wounded to go.'); return; }
            if ((missionType === 'hunt' || missionType === 'patrol') && (pet.lifeStage === 'pup' || pet.lifeStage === 'elder')) {
                addStory(pet.name + ' cannot fight in this life stage. Forage only.');
                return;
            }
            var staminaCost = STAMINA_COST[missionType] || 20;
            if ((pet.stamina ?? 100) < staminaCost) { addStory('Not enough stamina.'); return; }
            pet.stamina = Math.max(0, (pet.stamina ?? 100) - staminaCost);
            pet.energy = Math.max(0, pet.energy - 15);
            pet.hunger = Math.min(100, pet.hunger + 10);

            if (missionType === 'forage') {
                var eff = getLocationEfficiency(state, 'clearing');
                var plants = Math.random() < 0.5 && Math.random() < eff ? 1 : 0;
                var seeds = Math.random() < 0.25 && Math.random() < eff ? 1 : 0;
                var herbs = Math.random() < 0.2 && Math.random() < eff ? 1 : 0;
                var mat = Math.random() < 0.35 && Math.random() < eff ? 1 : 0;
                state.inventory.plants = (state.inventory.plants || 0) + plants;
                state.inventory.seeds = (state.inventory.seeds || 0) + seeds;
                state.inventory.herbs = (state.inventory.herbs || 0) + herbs;
                state.inventory.materials = (state.inventory.materials || 0) + mat;
                state.stats.missionsCompleted++;
                maybeAddReport(state);
                pet.xp += 15;
                var parts = [];
                if (plants) parts.push('plants'); if (seeds) parts.push('seeds'); if (herbs) parts.push('herbs'); if (mat) parts.push('material');
                addStory(pet.name + ' returns from foraging.' + (parts.length ? ' Found: ' + parts.join(', ') + '.' : ' Found nothing.'));
                showLootPopup([].concat(plants ? [{ type: 'plants', img: 'farm_crop.PNG' }] : [], seeds ? [{ type: 'seeds', img: 'farm_sprouts.PNG' }] : [], herbs ? [{ type: 'herbs', img: 'health_potion.PNG' }] : [], mat ? [{ type: 'materials', img: 'wood_bundle.PNG' }] : []));
                tryLevelUp(state, addStory);
                if (Math.random() < (CONFIG.RABBIT_ENCOUNTER_CHANCE || 0.3)) {
                    var rabbitCount = 1 + Math.floor(Math.random() * 3);
                    state.encounterPrompt = { isWildRabbits: true, rabbitCount: rabbitCount };
                    addStory('You found ' + rabbitCount + ' wild rabbit(s)!', 'medium');
                    return;
                }
                return;
            }

            const encounter = missionType === 'hunt' || Math.random() < (missionType === 'patrol' ? 0.5 : 0);
            if (!encounter) {
                var eff = getLocationEfficiency(state, 'clearing');
                var raw = Math.random() < 0.6;
                var gotMeat = raw && Math.random() < eff;
                if (gotMeat) state.inventory.rawMeat = (state.inventory.rawMeat || 0) + 1;
                state.stats.missionsCompleted++;
                state.securityLevel = Math.min(100, (state.securityLevel != null ? state.securityLevel : 50) + (missionType === 'patrol' ? 2 : 1));
                maybeAddReport(state);
                pet.xp += 20;
                addStory(pet.name + ' completes the mission without conflict.' + (gotMeat ? ' Found raw meat.' : ''));
                if (gotMeat) showLootPopup([{ type: 'rawMeat', img: 'fresh_meat.PNG' }]);
                tryLevelUp(state, addStory);
                if (Math.random() < (CONFIG.WEREWOLF_ENCOUNTER_CHANCE || 0.3) && (state.pack || []).length < (CONFIG.MAX_PACK_SIZE || 6)) {
                    state.encounterPrompt = { isWildWerewolf: true, captureBonus: (state.rabbitCount || 0) > 0 ? (CONFIG.CAPTURE_BONUS_WITH_RABBITS || 0.1) : 0 };
                    addStory('Your ' + missionType + ' party encountered a wild werewolf!', 'high');
                    if ((state.rabbitCount || 0) > 0) addStory('The wolf was stalking your rabbit hutch. It knows where food is.', 'medium');
                    return;
                }
                return;
            }

            if (state.petEscaped && Math.random() < 0.3) {
                state.currentEnemy = { name: pet.name, img: (pet.form === 'wolf' || pet.form === 'hybrid') ? 'female_wolf_cage.PNG' : 'womans_cage.PNG' };
                state.encounterPrompt = { enemyData: { name: pet.name, hp: 1, atk: 0, xp: 0, loot: {} }, enemy: { name: pet.name, hp: 1 }, isRecapture: true };
                addStory('You found ' + pet.name + '! Try to bring them back.');
                return;
            }
            const threat = state.world.threatLevel + (state.world.moonPhase === 'full' ? 1 : 0);
            const pool = threat >= 3 ? ENEMIES : ENEMIES.slice(0, Math.max(1, threat + 1));
            const enemyData = pool[Math.floor(Math.random() * pool.length)];
            const enemy = { ...enemyData, hp: enemyData.hp };
            state.currentEnemy = { name: enemy.name, img: enemyData.img };
            state.encounterPrompt = { enemyData, enemy };
            addStory(pet.name + ' encounters a ' + enemy.name + '!');
            if (enemyData.sound && document.getElementById('opt-sfx') && document.getElementById('opt-sfx').checked) {
                try { loadAudioMain(enemyData.sound).play().catch(function() {}); } catch (e) {}
            }
            return;
        }

        // Werewolf recapture: 30% encounter on hunt/patrol when escaped. Net: always deduct 1 on use; then 15% chance deduct one more (net broke).

        // Resolves combat round by round. Victory = loot, spirit goes Dark; retreat = spirit Light. Star Potion = one free no-damage fight.
        function runCombat(state, addStory) {
            var enc = state.encounterPrompt;
            if (!enc) return;
            state.encounterPrompt = null;
            if (enc.isRecapture) {
                var inv = state.inventory || {};
                if ((inv.net || 0) < 1) {
                    addStory('You need a net to bring them back. Craft one (5 materials + 3 plants).');
                    return;
                }
                state.encounterPrompt = null;
                inv.net = Math.max(0, (inv.net || 0) - 1);
                var netBroke = Math.random() < 0.15;
                if (netBroke) inv.net = Math.max(0, (inv.net || 0) - 1);
                state.petEscaped = false;
                state.pet.bond = Math.max(0, (state.pet.bond || 50) - 10);
                state.pet.fear = Math.min(100, (state.pet.fear || 0) + 10);
                state.currentEnemy = null;
                addStory(state.pet.name + ' is recaptured. Bond and trust damaged.' + (netBroke ? ' Your net broke.' : ''));
                if (typeof render === 'function') render();
                return;
            }
            state.combatInProgress = true;
            var squad = getSquad(state);
            var pet = squad.length ? squad[0] : state.pet;
            if (!pet) { state.combatInProgress = false; state.encounterPrompt = null; return; }
            var enemy = enc.enemy;
            var enemyData = enc.enemyData;
            var inv = state.inventory || {};
            var usedStarPotion = (inv.starPotion || 0) >= 1;
            if (usedStarPotion) {
                inv.starPotion = (inv.starPotion || 0) - 1;
                state.starPotionActiveThisCombat = true;
            } else state.starPotionActiveThisCombat = false;
            var combatLines = [];
            combatLines.push('Combat: ' + pet.name + (squad.length > 1 ? ' (+ ' + (squad.length - 1) + ' ally)' : '') + ' vs ' + enemy.name);
            if (state.starPotionActiveThisCombat) combatLines.push('You give ' + pet.name + ' the Star Potion. They glow—no harm can touch them this fight.');
            var squadBonus = 1 + (squad.length - 1) * 0.1;
            var petElement = getPetElement(pet);
            var enemyElement = enemyData.element || 'physical';
            var round = 0;
            var fearMult = getFearMultipliers(pet.fear).stats;
            var traits = pet.traits || [];
            var hasAggressive = traits.indexOf('aggressive') >= 0;
            var hasDefensive = traits.indexOf('defensive') >= 0;
            var hasThinker = traits.indexOf('thinker') >= 0;
            var hasShy = traits.indexOf('shy') >= 0;
            while (pet.hp > 0 && enemy.hp > 0 && round < 30) {
                round++;
                var baseAtk = (pet.strength + (pet.form === 'wolf' ? 10 : pet.form === 'hybrid' ? 5 : 0)) * (0.8 + Math.random() * 0.4) * fearMult * squadBonus;
                if (hasAggressive) baseAtk *= 1.1;
                var crit = hasThinker && Math.random() < 0.15 ? 1.5 : 1;
                var elemMult = getElementMultiplier(petElement, enemyElement);
                var petAtk = baseAtk * crit * elemMult;
                if ((pet.abilities || []).length && Math.random() < 0.2) petAtk *= 1.25;
                var enemyAtk = enemy.atk * (0.8 + Math.random() * 0.4);
                if (hasDefensive) enemyAtk *= 0.9;
                enemy.hp -= Math.max(1, Math.floor(petAtk));
                combatLines.push(pet.name + ' hits for ' + Math.floor(petAtk) + (crit > 1 ? ' (crit!)' : '') + '. Enemy HP: ' + Math.max(0, enemy.hp));
                if (enemy.hp <= 0) break;
                if (hasShy && pet.hp < 20) { combatLines.push(pet.name + ' panics and retreats!'); break; }
                if (state.starPotionActiveThisCombat) combatLines.push(enemy.name + ' strikes but the glow holds. No damage.');
                else { pet.hp -= Math.max(1, Math.floor(enemyAtk)); combatLines.push(enemy.name + ' hits for ' + Math.floor(enemyAtk) + '. ' + pet.name + ' HP: ' + pet.hp); }
            }
            var outcomeStory = '';
            var outcomeLoot = [];
            var outcomeLevelUp = false;
            if (enemy.hp <= 0) {
                state.stats.enemiesDefeated++;
                state.stats.missionsCompleted++;
                state.securityLevel = Math.min(100, (state.securityLevel != null ? state.securityLevel : 50) + 1);
                maybeAddReport(state);
                pet.xp += enemyData.xp;
                pet.spiritAlignment = Math.max(-100, (pet.spiritAlignment || 0) - 8);
                var eff = getLocationEfficiency(state, 'clearing');
                var meatGain = Math.random() < eff ? (enemyData.loot.rawMeat || 0) : 0;
                var matGain = Math.random() < eff ? (enemyData.loot.materials || 0) : 0;
                if (meatGain) state.inventory.rawMeat = (state.inventory.rawMeat || 0) + meatGain;
                if (matGain) state.inventory.materials = (state.inventory.materials || 0) + matGain;
                combatLines.push(pet.name + ' wins!');
                outcomeStory = pet.name + ' defeats the ' + enemy.name + ' and returns with spoils.';
                outcomeLoot = [].concat(meatGain ? Array(meatGain).fill({ type: 'rawMeat', img: 'fresh_meat.PNG' }) : [], matGain ? [{ type: 'materials', img: 'wood_bundle.PNG' }] : []);
                outcomeLevelUp = true;
            } else {
                pet.hp = Math.max(1, pet.hp);
                combatLines.push(pet.name + ' retreats, wounded.');
                outcomeStory = pet.name + ' retreats from the ' + enemy.name + ', injured.';
            }
            animateCombatLog(combatLines, function() {
                addStory(outcomeStory);
                if (outcomeLoot.length) showLootPopup(outcomeLoot);
                if (outcomeLevelUp) tryLevelUp(state, addStory);
                state.currentEnemy = null;
                state.combatInProgress = false;
                state.starPotionActiveThisCombat = false;
                if (typeof render === 'function') render();
            });
        }

        function doRetreat(state, addStory) {
            var enc = state.encounterPrompt;
            if (!enc) return;
            state.encounterPrompt = null;
            state.currentEnemy = null;
            if (!enc.isRecapture) state.pet.spiritAlignment = Math.min(100, (state.pet.spiritAlignment || 0) + 5);
            if (enc.isRecapture) {
                addStory('You leave ' + state.pet.name + ' out there. Find them again later.');
            } else {
                var pet = state.pet;
                pet.hp = Math.max(1, pet.hp - 8);
                addStory(pet.name + ' runs from the ' + enc.enemy.name + '. Wounded in the escape.');
            }
            if (typeof render === 'function') render();
        }

        // Combat log: play-by-play. Lines appear one at a time (CONFIG.combatLogDelayMs); onDone when finished.
        function animateCombatLog(lines, onDone) {
            var container = document.getElementById('combat-log');
            if (!container) return;
            container.innerHTML = '';
            var i = 0;
            function addNext() {
                if (i >= lines.length) { if (typeof onDone === 'function') onDone(); else if (typeof render === 'function') render(); return; }
                var entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = lines[i];
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
                i++;
                setTimeout(addNext, CONFIG.combatLogDelayMs);
            }
            addNext();
        }

        var LOOT_IMAGES = { food: 'fresh_meat.PNG', materials: 'wood_bundle.PNG', meds: 'health_potion.PNG' };
        var lootPopupTimer = null;
        function showLootPopup(items) {
            var el = document.getElementById('loot-popup');
            var sceneEl = document.getElementById('scene-loot-overlay');
            if (el) { el.innerHTML = ''; }
            if (sceneEl) sceneEl.innerHTML = '';
            items.forEach(function(item) {
                var src = V + (item.img || LOOT_IMAGES[item.type] || 'full_food_bowl.PNG');
                if (el) {
                    var img = document.createElement('img');
                    img.src = src;
                    img.alt = item.type || 'item';
                    img.className = 'loot-popup-img';
                    el.appendChild(img);
                }
                if (sceneEl) {
                    var simg = document.createElement('img');
                    simg.src = src;
                    simg.alt = item.type || 'item';
                    sceneEl.appendChild(simg);
                }
            });
            if (el) el.classList.add('visible');
            if (sceneEl) sceneEl.classList.add('visible');
            clearTimeout(lootPopupTimer);
            lootPopupTimer = setTimeout(function() {
                if (el) { el.classList.remove('visible'); el.innerHTML = ''; }
                if (sceneEl) { sceneEl.classList.remove('visible'); sceneEl.innerHTML = ''; }
            }, 3500);
        }

        // ============================================================================
        // UI — The face of the game (and the globals that hold it together)
        // ============================================================================
        // gameState = the whole save: pet, world, inventory, workers, queues, etc. Don't null it unless you mean it.
        // storyLog = last N story messages (newest first). currentActionsById = map of action id → { fn, label, dis } for click handling.
        // To add a new tab or change which buttons show where: find "locActionIds" in render() and edit the arrays (clearing, kennel, ...).
        // ============================================================================
        let gameState = null;
        const storyLog = [];
        const combatLog = [];
        const STORY_MAX = 20;
        var currentActionsById = {};
        let weatherAudio = null;
        let lastWeather = '';
        let gameTickInterval = null;
        var autoSaveInterval = null;
        var lastHowledFullMoonDay = -1;

        var STORY_PRIORITY = { critical: 0, high: 1, medium: 2, low: 3 };
        // Cooldown so we don't spam "Luna is thirsty" every tick. One warning per type per 60 seconds.
        var lastWarningTime = {};
        var WARNING_COOLDOWN_MS = 60000;
        function canShowWarning(type) {
            var now = Date.now();
            if (!lastWarningTime[type]) return true;
            return (now - lastWarningTime[type]) >= WARNING_COOLDOWN_MS;
        }
        // Pushes a story message. Newest at top. priority = critical/high/medium/low (for future filtering). warningType = optional, uses cooldown.
        function addStory(text, priority, warningType) {
            if (warningType && !canShowWarning(warningType)) return;
            if (warningType) lastWarningTime[warningType] = Date.now();
            priority = priority || 'medium';
            var entry = { text: text, ts: Date.now(), priority: priority };
            storyLog.unshift(entry);
            while (storyLog.length > STORY_MAX) storyLog.pop();
        }

        function addCombatLog(text) {
            combatLog.push(text);
        }

        // Redraws the whole UI: time, location, pet card, action buttons, timers, story feed.
        // Called every game tick and after every button click. When a timer is RUNNING we do NOT rebuild the
        // action button grid (so buttons don't merge)—we only update the timer text. When idle, we rebuild buttons.
        function render() {
            if (!gameState) return;
            if (gameState.pack && gameState.pack.length) gameState.pet = getCurrentPet(gameState);
            const pet = gameState.pet;
            const world = gameState.world;
            if (pet) updatePetForm(pet, world);

            if (world.moonPhase === 'full' && world.currentDay !== lastHowledFullMoonDay) {
                lastHowledFullMoonDay = world.currentDay;
                playHowl();
                if (typeof gameState._addStory === 'function') gameState._addStory('A long, haunting howl echoes through the facility. The full moon rises.', 'critical');
            }

            document.getElementById('time-display').textContent = getTimeString(world);
            document.getElementById('day-display').textContent = 'Day ' + world.currentDay;
            var musicBtn = document.getElementById('btn-music-toggle');
            if (musicBtn && document.getElementById('opt-music')) musicBtn.textContent = document.getElementById('opt-music').checked ? 'Music: On' : 'Music: Off';
            document.getElementById('moon-phase').textContent = MOON_NAMES[world.moonPhase] || world.moonPhase;
            document.getElementById('moon-countdown').textContent = world.daysToFullMoon === 0 ? 'Full moon tonight' : 'Full moon in ' + world.daysToFullMoon + ' days';
            document.getElementById('weather-display').textContent = world.weather === 'rain' ? 'Rain' : world.weather === 'snow' ? 'Snow' : 'Clear';

            var locId = gameState.currentLocation || 'clearing';
            var loc = LOCATIONS.find(function(l) { return l.id === locId; }) || LOCATIONS[0];
            var ab = gameState.actionByLocation || {};
            var clearingQueue = getQueueForLoc(gameState, 'clearing');
            var clearingAction = clearingQueue.length && clearingQueue[0].busyUntil != null && Date.now() < clearingQueue[0].busyUntil && ['hunt', 'forage', 'patrol', 'train'].indexOf(clearingQueue[0].id) >= 0 ? clearingQueue[0] : null;
            var clearingActive = !!clearingAction;
            var bgFile = loc.bg || 'clearing_lab.PNG';
            if (locId === 'clearing' && clearingActive) {
                var w = gameState.world || {};
                if (w.timeOfDay === 'night' && w.moonPhase === 'full') bgFile = 'path_nightime_moon.png';
                else if (w.timeOfDay === 'night' || w.timeOfDay === 'dusk') bgFile = 'path_nightime.png';
                else bgFile = 'path_daytime.png';
            }
            if (locId === 'kennel') {
                var waste = gameState.kennelWaste || 0;
                var kc = gameState.kennelClean || 100;
                if (waste > 0 || kc < 50) bgFile = 'dirty_cage.png';
                else bgFile = 'clean_cage.png';
            }
            if (locId === 'garden') {
                var garden = gameState.garden || { crops: [], watered: false, dying: false };
                if (garden.dying) bgFile = 'farm_dying.PNG';
                else if (garden.crops && garden.crops.length) {
                    var crop = garden.crops[0];
                    var d = crop.daysLeft != null ? crop.daysLeft : 2;
                    if (d <= 0) bgFile = 'farm_crop.PNG';
                    else bgFile = 'farm_sprouts.PNG';
                } else bgFile = 'farm_soil.PNG';
            }
            if (locId === 'rabbit_farm') {
                var rabbits = gameState.rabbitCount != null ? gameState.rabbitCount : 0;
                bgFile = rabbits > 0 ? 'rabbit_in_cage.PNG' : 'empty_rabbit_cage.PNG';
            }
            if (locId === 'crafting') bgFile = gameState.grillOn ? 'grill_on.PNG' : 'grill_off.PNG';
            if (locId === 'command_center') bgFile = 'command_room.png';
            if ((world.timeOfDay === 'night' || world.timeOfDay === 'dusk') && loc.bgNight && locId !== 'kennel' && locId !== 'crafting' && locId !== 'command_center') bgFile = loc.bgNight;
            var compostBinEl = document.getElementById('compost-bin');
            if (compostBinEl) {
                if (locId === 'garden') {
                    var compLevel = (gameState.compost && gameState.compost.level) ? gameState.compost.level : 0;
                    compostBinEl.src = V + (compLevel > 0 ? 'compost_bin_full.PNG' : 'compost_bin_empty.PNG');
                    compostBinEl.style.display = 'block';
                } else {
                    compostBinEl.style.display = 'none';
                    compostBinEl.src = '';
                }
            }
            var bgImg = V + bgFile;
            var sceneBg = document.getElementById('scene-bg');
            var sceneTitle = document.getElementById('scene-title');
            var sceneDisplay = document.getElementById('scene-display');
            if (sceneDisplay) { sceneDisplay.classList.toggle('clearing-view', locId === 'clearing'); }
            sceneBg.style.backgroundImage = 'url(' + bgImg + ')';
            sceneBg.style.backgroundColor = '#1a1520';
            if (sceneTitle) sceneTitle.textContent = loc.title;
            var petVisual = document.getElementById('pet-visual');
            if (petVisual) petVisual.style.display = (locId === 'clearing' || locId === 'kennel') ? 'block' : 'none';

            var sceneWeather = document.getElementById('scene-weather');
            if (world.weather === 'rain') {
                sceneWeather.style.backgroundImage = 'url(' + V + 'rain.png)';
                sceneWeather.style.display = 'block';
            } else if (world.weather === 'snow') {
                sceneWeather.style.backgroundImage = 'url(' + V + 'snow.png)';
                sceneWeather.style.display = 'block';
            } else {
                sceneWeather.style.backgroundImage = '';
                sceneWeather.style.display = 'none';
            }

            if (world.weather !== lastWeather) {
                if (weatherAudio) { weatherAudio.pause(); weatherAudio = null; }
                lastWeather = world.weather;
                var ambientOn = document.getElementById('opt-ambient') && document.getElementById('opt-ambient').checked;
                if (ambientOn && world.weather === 'rain') {
                    weatherAudio = loadAudioMain('thundering_rain.mp3');
                    weatherAudio.loop = true;
                    weatherAudio.volume = 0.35;
                    weatherAudio.play().catch(() => {});
                } else if (ambientOn && world.weather === 'snow') {
                    weatherAudio = loadAudioMain('winter_wind.mp3');
                    weatherAudio.loop = true;
                    weatherAudio.volume = 0.3;
                    weatherAudio.play().catch(() => {});
                }
            }
            if (weatherAudio && document.getElementById('opt-ambient') && !document.getElementById('opt-ambient').checked) { weatherAudio.pause(); weatherAudio = null; }

            var inCage = !gameState.currentEnemy && !gameState.encounterPrompt && !clearingActive;
            if (inCage) gameState.inCage = true;
            var currentTabQueue = getQueueForLoc(gameState, locId);
            var currentTabBusy = currentTabQueue.length >= MAX_QUEUE_PER_TAB;
            var currentTabHasBusy = currentTabQueue.some(function(s) { return Date.now() < s.busyUntil; });
            var cageImg = document.getElementById('cage-static');
            var petImg = document.getElementById('pet-sprite');
            var enemyImg = document.getElementById('enemy-sprite');
            var cageSrc = (pet.form === 'wolf' || pet.form === 'hybrid') ? V + 'female_wolf_cage.PNG' : V + 'womans_cage.PNG';
            var petSrc = (pet.form === 'wolf') ? V + 'female_werewolf.PNG' : (pet.form === 'hybrid') ? V + 'female_turning.PNG' : V + 'human_female.PNG';
            var kennelPetSrc = (pet.form === 'wolf' || pet.form === 'hybrid') ? V + 'female_wolf_cage.PNG' : V + 'womans_cage.PNG';
            var inCombatOrEncounter = gameState.encounterPrompt || gameState.combatInProgress;
            if (inCombatOrEncounter && petImg) { petImg.src = (locId === 'clearing') ? petSrc : kennelPetSrc; petImg.alt = pet.name + ' (' + pet.form + ')'; petImg.style.display = 'block'; petImg.classList.add('out-of-cage'); }
            if (cageImg) {
                if (locId === 'clearing') {
                    cageImg.style.display = 'none';
                    cageImg.src = '';
                    if (petImg && !inCombatOrEncounter) {
                        if (inCage) { petImg.style.display = 'none'; petImg.classList.remove('out-of-cage'); }
                        else { petImg.src = petSrc; petImg.alt = pet.name; petImg.style.display = 'block'; petImg.classList.add('out-of-cage'); }
                    }
                } else if (locId === 'kennel') {
                    if (inCage && !inCombatOrEncounter) {
                        cageImg.src = cageSrc;
                        cageImg.alt = pet.name + ' in cage';
                        cageImg.style.display = 'block';
                        if (petImg) { petImg.style.display = 'none'; petImg.classList.remove('out-of-cage'); }
                    } else {
                        cageImg.style.display = 'none';
                        if (petImg) { petImg.src = kennelPetSrc; petImg.alt = pet.name; petImg.style.display = 'block'; petImg.classList.add('out-of-cage'); }
                    }
                } else {
                    cageImg.style.display = 'none';
                    if (petImg && !inCombatOrEncounter) petImg.style.display = 'none';
                }
            } else if (petImg) {
                if ((locId === 'clearing' || locId === 'kennel') && (!inCage || inCombatOrEncounter)) { petImg.src = (locId === 'clearing') ? petSrc : kennelPetSrc; petImg.alt = pet.name; petImg.style.display = 'block'; petImg.classList.add('out-of-cage'); }
                else if (locId !== 'clearing' && locId !== 'kennel' && !inCombatOrEncounter) petImg.style.display = 'none';
            }
            var trainDummyEl = document.getElementById('training-dummy');
            if (trainDummyEl) {
                if (locId === 'clearing' && clearingActive && clearingAction.id === 'train') {
                    trainDummyEl.style.display = 'block';
                    var flash = Math.floor(Date.now() / 500) % 2 === 0;
                    trainDummyEl.src = flash ? (V + 'training_dummy.PNG') : (V + 'training_dummy_damaged.PNG');
                } else {
                    trainDummyEl.style.display = 'none';
                }
            }
            if (gameState.currentEnemy && enemyImg) {
                enemyImg.src = V + gameState.currentEnemy.img;
                enemyImg.alt = gameState.currentEnemy.name;
                enemyImg.style.display = 'block';
            } else if (enemyImg) {
                enemyImg.style.display = 'none';
            }

            var pack = gameState.pack || [];
            var packCount = pack.length;
            var maxPack = typeof CONFIG !== 'undefined' && CONFIG.MAX_PACK_SIZE != null ? CONFIG.MAX_PACK_SIZE : 6;
            var selectedIdx = gameState.selectedPetIndex != null ? gameState.selectedPetIndex : 0;
            var squadIndices = gameState.squadIndices != null ? gameState.squadIndices.slice() : [selectedIdx];
            var maxSquad = typeof CONFIG !== 'undefined' && CONFIG.MAX_SQUAD_SIZE != null ? CONFIG.MAX_SQUAD_SIZE : 3;
            var packHtml = '<div style="margin-bottom:6px;font-size:0.9em;"><strong>Pack (' + packCount + '/' + maxPack + ')</strong>';
            pack.forEach(function(p, i) {
                var sel = i === selectedIdx ? ' [active]' : '';
                packHtml += ' <button type="button" class="btn btn-small" data-select-wolf="' + i + '" style="margin:2px;' + (i === selectedIdx ? 'background:rgba(120,80,160,0.5);' : '') + '">' + (p.name || 'Wolf') + sel + '</button>';
            });
            packHtml += '</div><div style="margin-bottom:8px;font-size:0.85em;"><strong>Squad (max ' + maxSquad + ')</strong> <span style="color:#a0a0c0;">Hunt/patrol use this squad.</span>';
            pack.forEach(function(p, i) {
                var inSquad = squadIndices.indexOf(i) >= 0;
                var canAdd = inSquad || squadIndices.length < maxSquad;
                packHtml += ' <label style="margin-right:8px;"><input type="checkbox" data-squad-wolf="' + i + '" ' + (inSquad ? 'checked' : '') + (canAdd ? '' : ' disabled') + ' /> ' + (p.name || 'Wolf') + '</label>';
            });
            packHtml += '</div>';
            if (!pet) {
                document.getElementById('pet-card-container').innerHTML = packHtml + '<div class="pet-card"><div class="pet-header">No wolf in pack</div></div>';
                document.querySelectorAll('[data-select-wolf]').forEach(function(btn) {
                    btn.addEventListener('click', function() { var i = parseInt(btn.getAttribute('data-select-wolf'), 10); if (!isNaN(i) && gameState.pack && gameState.pack[i]) { gameState.selectedPetIndex = i; gameState.pet = gameState.pack[i]; render(); } });
                });
            } else {
            var lifeStage = pet.lifeStage || getLifeStage(pet.ageInDays);
            var spirit = pet.spiritAlignment != null ? pet.spiritAlignment : 0;
            var spiritPct = Math.min(100, Math.max(0, (spirit + 100) / 2));
            var personalityLabel = (pet.personalityType || 'Stoic');
            let petCard = packHtml + '<div class="pet-card"><div class="pet-header"><span class="pet-name">' + pet.name + '</span><span class="pet-form form-' + pet.form + '">' + pet.form + '</span><span class="pet-life-stage" style="margin-left:6px;font-size:0.85em;color:#a0a0c0;">' + (lifeStage === 'pup' ? 'Pup' : lifeStage === 'elder' ? 'Elder' : 'Adult') + '</span><span style="font-size:0.8em;color:#888;margin-left:4px;">' + (pet.gender || '') + '</span></div><div style="font-size:0.8em;color:#a0a0c0;margin-bottom:4px;">Personality: ' + personalityLabel + '</div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>HP</span><span>' + pet.hp + '/' + pet.maxHp + '</span></div><div class="bar-container"><div class="bar-fill bar-hp" style="width:' + (pet.hp / pet.maxHp * 100) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Energy</span><span>' + pet.energy + '/' + pet.maxEnergy + '</span></div><div class="bar-container"><div class="bar-fill bar-energy" style="width:' + (pet.energy / pet.maxEnergy * 100) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Stamina</span><span>' + Math.round(pet.stamina ?? 100) + '/' + (pet.maxStamina || 100) + '</span></div><div class="bar-container"><div class="bar-fill bar-energy" style="width:' + (Math.min(100, (pet.stamina ?? 100) / (pet.maxStamina || 100) * 100)) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Sleep</span><span>' + Math.round(pet.sleep ?? 100) + '</span></div><div class="bar-container"><div class="bar-fill bar-hunger" style="width:' + (pet.sleep ?? 100) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Hunger</span><span>' + (pet.hunger || 0) + '</span></div><div class="bar-container"><div class="bar-fill bar-hunger" style="width:' + (pet.hunger || 0) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Thirst</span><span>' + (pet.thirst != null ? pet.thirst : 50) + '</span></div><div class="bar-container"><div class="bar-fill bar-thirst" style="width:' + (pet.thirst != null ? pet.thirst : 50) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Sickness</span><span>' + (pet.sickness || 0) + '</span></div><div class="bar-container"><div class="bar-fill bar-fear" style="width:' + (pet.sickness || 0) + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Fear</span><span>' + pet.fear + '</span></div><div class="bar-container"><div class="bar-fill bar-fear" style="width:' + pet.fear + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Bond</span><span>' + pet.bond + '</span></div><div class="bar-container"><div class="bar-fill bar-bond" style="width:' + pet.bond + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Spirit</span><span>' + (spirit >= 0 ? 'Light ' : 'Dark ') + Math.abs(Math.round(spirit)) + '</span></div><div class="bar-container"><div class="bar-fill bar-bond" style="width:' + spiritPct + '%"></div></div></div>';
            petCard += '<div class="stat-bar"><div class="stat-label"><span>Shift</span><span>' + Math.round(pet.shiftLevel) + '%</span></div><div class="bar-container"><div class="bar-fill bar-shift" style="width:' + pet.shiftLevel + '%"></div></div></div>';
            if ((pet.traits || []).length) petCard += '<div style="font-size:0.8em;margin-top:4px;">Traits: ' + (pet.traits || []).map(function(tid) { var T = (typeof PERSONALITY_TRAITS !== 'undefined' ? PERSONALITY_TRAITS : []).find(function(x) { return x.id === tid; }); return T ? T.name : tid; }).join(', ') + '</div>';
            if ((pet.abilities || []).length) petCard += '<div style="font-size:0.8em;margin-top:2px;">Abilities: ' + (pet.abilities || []).map(function(aid) { var A = (typeof SPECIAL_ABILITIES !== 'undefined' ? SPECIAL_ABILITIES : []).find(function(x) { return x.id === aid; }); return A ? A.name : aid; }).join(', ') + '</div>';
            petCard += '</div>';
            document.getElementById('pet-card-container').innerHTML = petCard;
            document.querySelectorAll('[data-select-wolf]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var i = parseInt(btn.getAttribute('data-select-wolf'), 10);
                    if (!isNaN(i) && gameState.pack && gameState.pack[i]) {
                        gameState.selectedPetIndex = i;
                        gameState.pet = gameState.pack[i];
                        render();
                    }
                });
            });
            if (!gameState.squadIndices) gameState.squadIndices = [selectedIdx >= 0 ? selectedIdx : 0];
            document.querySelectorAll('[data-squad-wolf]').forEach(function(cb) {
                cb.addEventListener('change', function() {
                    var i = parseInt(cb.getAttribute('data-squad-wolf'), 10);
                    var idx = gameState.squadIndices || [];
                    if (cb.checked) {
                        if (idx.indexOf(i) < 0 && idx.length < (CONFIG && CONFIG.MAX_SQUAD_SIZE != null ? CONFIG.MAX_SQUAD_SIZE : 3)) idx.push(i);
                    } else {
                        idx = idx.filter(function(j) { return j !== i; });
                    }
                    gameState.squadIndices = idx.length ? idx : [gameState.selectedPetIndex >= 0 ? gameState.selectedPetIndex : 0];
                    render();
                });
            });
            }

            const statsList = document.getElementById('stats-list');
            const gameStats = gameState.stats || { missionsCompleted: 0, enemiesDefeated: 0 };
            if (pet) {
                var ageDays = pet.ageInDays != null ? pet.ageInDays : Math.max(0, (gameState.world && gameState.world.currentDay) - (pet.birthDay || 1));
                statsList.innerHTML = '<li class="stat-item"><span>Age</span><span>' + ageDays + ' days</span></li><li class="stat-item"><span>STR</span><span>' + pet.strength + '</span></li><li class="stat-item"><span>SPD</span><span>' + pet.speed + '</span></li><li class="stat-item"><span>END</span><span>' + pet.endurance + '</span></li><li class="stat-item"><span>Level</span><span>' + pet.level + '</span></li><li class="stat-item"><span>XP</span><span>' + pet.xp + ' / ' + pet.xpToNext + '</span></li><li class="stat-item"><span>Missions</span><span>' + gameStats.missionsCompleted + '</span></li><li class="stat-item"><span>Enemies defeated</span><span>' + gameStats.enemiesDefeated + '</span></li>';
            } else {
                statsList.innerHTML = '<li class="stat-item"><span>—</span><span>No wolf</span></li>';
            }

            const inv = gameState.inventory || {};
            document.getElementById('inventory-list').innerHTML = '<div class="inventory-item"><span>Water</span><span>' + (inv.water || 0) + '</span></div><div class="inventory-item"><span>Raw meat</span><span>' + (inv.rawMeat || 0) + '</span></div><div class="inventory-item"><span>Cooked meat</span><span>' + (inv.cookedMeat || 0) + '</span></div><div class="inventory-item"><span>Cooked veg</span><span>' + (inv.cookedVegetables || 0) + '</span></div><div class="inventory-item"><span>Plants</span><span>' + (inv.plants || 0) + '</span></div><div class="inventory-item"><span>Seeds</span><span>' + (inv.seeds || 0) + '</span></div><div class="inventory-item"><span>Herbs</span><span>' + (inv.herbs || 0) + '</span></div><div class="inventory-item"><span>Meds</span><span>' + (inv.meds || 0) + '</span></div><div class="inventory-item"><span>Materials</span><span>' + (inv.materials || 0) + '</span></div><div class="inventory-item"><span>Compost</span><span>' + (inv.compostUnits || 0) + '</span></div><div class="inventory-item"><span>Rabbit trap</span><span>' + (inv.rabbitTrap || 0) + '</span></div><div class="inventory-item"><span>Net</span><span>' + (inv.net || 0) + '</span></div><div class="inventory-item"><span>Bait</span><span>' + (inv.bait || 0) + '</span></div><div class="inventory-item"><span>Premium Bait</span><span>' + (inv.premiumBait || 0) + '</span></div><div class="inventory-item"><span>Star Potion</span><span>' + (inv.starPotion || 0) + '</span></div>';

            var combatBlock = gameState.combatInProgress;
            var enc = gameState.encounterPrompt;
            var timerActive = false;

            var actions;
            if (enc) {
                document.getElementById('combat-log-container').style.display = 'block';
                var clog = document.getElementById('combat-log');
                var hasNet = (gameState.inventory && (gameState.inventory.net || 0) >= 1);
                if (enc.isWildRabbits) {
                    var rcount = enc.rabbitCount || 1;
                    if (clog) clog.innerHTML = '<div class="log-entry">You found ' + rcount + ' wild rabbit(s)! Net required to capture.</div>';
                    actions = [
                        { id: 'capture_rabbits', label: 'Capture (need net)', cls: 'btn-mission', fn: function() {
                            if ((gameState.inventory.net || 0) < 1) { addStory('You need a net to capture. Craft one (5 materials + 3 plants).'); render(); return; }
                            gameState.inventory.net = (gameState.inventory.net || 0) - 1;
                            var current = gameState.rabbitCount || 0;
                            var add = Math.min(rcount, 10 - current);
                            gameState.rabbitCount = current + add;
                            if (current === 0 && add > 0) gameState.rabbit = { hunger: 30, thirst: 30, clean: 80, sick: 0, lastFedDay: gameState.world.currentDay, lastWaterDay: gameState.world.currentDay, lastCleanDay: gameState.world.currentDay };
                            gameState.encounterPrompt = null;
                            addStory('Captured ' + add + ' rabbit(s). Total rabbits: ' + gameState.rabbitCount + '.');
                            document.getElementById('combat-log-container').style.display = 'none';
                            render();
                        }, dis: (gameState.inventory.net || 0) < 1 },
                        { id: 'leave_rabbits', label: 'Leave', cls: 'btn-care', fn: function() { gameState.encounterPrompt = null; document.getElementById('combat-log-container').style.display = 'none'; addStory('You leave the rabbits be.'); render(); } },
                    ];
                } else if (enc.isWildWerewolf) {
                    if (clog) clog.innerHTML = '<div class="log-entry">You found a wild werewolf! Net required to capture.</div>';
                    actions = [
                        { id: 'capture_wild', label: 'Capture (need net)', cls: 'btn-mission', fn: function() {
                            if (!hasNet) { addStory('You need a net to capture. Craft one (5 materials + 3 plants).'); render(); return; }
                            if (!canAddWolf(gameState)) { addStory('Sanctuary at maximum capacity (6 wolves). Release a wolf first.'); render(); return; }
                            gameState.inventory.net = Math.max(0, (gameState.inventory.net || 0) - 1);
                            var netBroke = Math.random() < 0.15;
                            if (netBroke) gameState.inventory.net = Math.max(0, (gameState.inventory.net || 0) - 1);
                            var wild = createPet({ id: getNextPetId(gameState), name: ['Shadow', 'Ember', 'Fang', 'Rust', 'Ash', 'Storm'][Math.floor(Math.random() * 6)], gender: Math.random() < 0.5 ? 'Male' : 'Female', birthDay: gameState.world.currentDay, ageInDays: 30, lifeStage: 'adult', abilities: (typeof SPECIAL_ABILITIES !== 'undefined' && SPECIAL_ABILITIES.length) ? [SPECIAL_ABILITIES[Math.floor(Math.random() * SPECIAL_ABILITIES.length)].id] : [], traits: [], bond: 20, fear: 60 });
                            gameState.pack.push(wild);
                            gameState.encounterPrompt = null;
                            gameState.currentEnemy = null;
                            addStory('You captured the wild werewolf. ' + wild.name + ' joins the pack.' + (netBroke ? ' Your net broke.' : ''));
                            document.getElementById('combat-log-container').style.display = 'none';
                            render();
                        }, dis: !hasNet },
                        { id: 'leave_wild', label: 'Leave', cls: 'btn-care', fn: function() { gameState.encounterPrompt = null; gameState.currentEnemy = null; document.getElementById('combat-log-container').style.display = 'none'; addStory('You leave the wild werewolf behind.'); render(); } },
                    ];
                } else {
                    if (clog) clog.innerHTML = '<div class="log-entry">' + (enc.isRecapture ? ('You found ' + enc.enemy.name + '! Bring back (need net) or leave?') : ('You encountered a ' + enc.enemy.name + '. Fight or run?')) + '</div>';
                    actions = [
                        { id: 'fight', label: enc.isRecapture ? 'Bring back' : 'Fight', cls: 'btn-mission', fn: () => { runCombat(gameState, addStory); render(); }, dis: enc.isRecapture && !hasNet },
                        { id: 'run', label: 'Run', cls: 'btn-care', fn: () => { doRetreat(gameState, addStory); document.getElementById('combat-log-container').style.display = 'none'; render(); } },
                    ];
                }
            } else if (combatBlock) {
                actions = [
                    { id: 'rest', label: 'Rest', cls: 'btn-care', fn: function() {}, dis: true },
                    { id: 'bond', label: 'Spend time', cls: 'btn-care', fn: function() {}, dis: true },
                    { id: 'train', label: 'Train', cls: 'btn-train', fn: function() {}, dis: true },
                    { id: 'feed', label: 'Feed', cls: 'btn-care', fn: function() {}, dis: true },
                    { id: 'heal', label: 'Heal', cls: 'btn-care', fn: function() {}, dis: true },
                    { id: 'ritual', label: 'Ritual', cls: 'btn-train', fn: function() {}, dis: true },
                    { id: 'forage', label: 'Forage', cls: 'btn-mission', fn: function() {}, dis: true },
                    { id: 'patrol', label: 'Patrol', cls: 'btn-mission', fn: function() {}, dis: true },
                    { id: 'hunt', label: 'Hunt', cls: 'btn-mission', fn: function() {}, dis: true },
                ];
            } else {
                if (!gameState.combatInProgress) document.getElementById('combat-log-container').style.display = 'none';
                var locId = gameState.currentLocation || 'clearing';
                var locActionsHtml = '';
                if (locId === 'kennel') {
                    var breedingLine = '';
                    if (gameState.breeding) {
                        var due = gameState.breeding.dueDay || 0;
                        var cur = (gameState.world && gameState.world.currentDay) || 1;
                        var left = Math.max(0, due - cur);
                        breedingLine = '<p style="margin-bottom:8px;font-size:0.9em;color:#b8a8c8;">Breeding in progress: ' + left + '/' + (CONFIG.GESTATION_DAYS || 28) + ' days left.</p>';
                    }
                    var breedDis = gameState.breeding || (gameState.pack || []).length >= (typeof CONFIG !== 'undefined' && CONFIG.MAX_PACK_SIZE != null ? CONFIG.MAX_PACK_SIZE : 6);
                    locActionsHtml = breedingLine + '<button class="btn btn-care" id="btn-clean-kennels">Clean kennels</button><button class="btn btn-care" id="btn-rename-wolf">Rename wolf</button><button class="btn btn-care" id="btn-breed-wolf" ' + (breedDis ? 'disabled title="Pack full or breeding in progress."' : 'title="Need two adult wolves. Standard: 20 food, 10 materials. Premium: 40 food, 20 materials."') + '>Breed</button>';
                }
                if (locId === 'command_center') {
                    var cmdStats = gameState.stats || {};
                    var escaped = gameState.assetsEscaped != null ? gameState.assetsEscaped : 7;
                    var killed = gameState.assetsKilled != null ? gameState.assetsKilled : 4;
                    var achCount = 0; var achTotal = ACHIEVEMENTS.length; if (gameState.achievements) { for (var ak in gameState.achievements) if (gameState.achievements[ak]) achCount++; }
                    var w = gameState.world || {};
                    var lastDrop = gameState.lastHelicopterDropDay || 0;
                    var nextDropDay = lastDrop + 28;
                    var daysLeft = Math.max(0, nextDropDay - (w.currentDay || 1));
                    var dayLen = w.dayLengthMinutes || 1440;
                    var minsIntoDay = w.worldTime || 0;
                    var minsLeft = daysLeft * dayLen + (dayLen - minsIntoDay);
                    var d = Math.floor(minsLeft / 1440);
                    var h = Math.floor((minsLeft % 1440) / 60);
                    var m = Math.floor(minsLeft % 60);
                    var heliEta = d + 'd ' + h + 'h ' + m + 'm';
                    var heliColor = minsLeft < 60 ? '#c88' : minsLeft < 360 ? '#c96' : '#6cc';
                    var heliEtaHtml = '<span style="color:' + heliColor + ';font-weight:bold;">' + heliEta + '</span>';
                    var inboundLine = (gameState.inboundWorker ? '<p>Inbound: Worker (' + (gameState.inboundWorker.role || '') + ')</p>' : '<p>Inbound: Supplies (next drop)</p>');
                    var tabLabels = { clearing: 'Clearing', garden: 'Garden', kennel: 'Kennel', rabbit_farm: 'Rabbit Farm', crafting: 'Crafting', command_center: 'Command Center' };
                    var facilityStatusRows = ['clearing', 'garden', 'kennel', 'rabbit_farm', 'crafting', 'command_center'].map(function(tid) {
                        var aw = getAssignedWorker(gameState, tid);
                        var status = '—';
                        var issues = '—';
                        if (aw) {
                            var eff = getEffectiveSkill(aw, tid);
                            status = eff < 30 ? 'Critical' : eff < 60 ? 'Warning' : 'Active';
                            issues = (aw.fear || 0) > 90 ? 'High fear' : (aw.fear || 0) > 60 ? 'Elevated fear' : (gameState.damaged && gameState.damaged[tid]) ? 'Damaged' : '—';
                        } else {
                            status = 'Active';
                            issues = (gameState.damaged && gameState.damaged[tid]) ? 'Damaged' : '—';
                        }
                        return '<tr><td>' + (tabLabels[tid] || tid) + '</td><td>' + (aw ? (aw.name || aw.role) + ' (' + (aw.fear || 0) + '%)' : '—') + '</td><td>' + status + '</td><td>' + issues + '</td></tr>';
                    }).join('');
                    var facilityStatusTable = '<table style="width:100%;font-size:0.85em;margin:8px 0;border-collapse:collapse;"><thead><tr><th style="text-align:left;padding:4px;">Tab</th><th style="text-align:left;padding:4px;">Worker</th><th style="text-align:left;padding:4px;">Status</th><th style="text-align:left;padding:4px;">Issues</th></tr></thead><tbody>' + facilityStatusRows + '</tbody></table>';
                    var roleToPortrait = { Cook: 'cook.PNG', Security: 'security.PNG', Doctor: 'doctor.PNG', Repair: 'repair_man.PNG', Caretaker: 'commander.PNG' };
                    var workersList = gameState.workers && gameState.workers.length ? gameState.workers.map(function(w, i) {
                        var tabForEff = ASSIGNMENT_TO_LOC[w.assignment || ''] || 'clearing';
                        var eff = getEffectiveSkill(w, tabForEff);
                        var portrait = roleToPortrait[w.role] || 'commander.PNG';
                        var skills = 'Cook ' + (w.cooking || 0) + ' Med ' + (w.medical || 0) + ' Sec ' + (w.security || 0) + ' Maint ' + (w.maintenance || 0) + ' Care ' + (w.caretaking || 0);
                        var inj = (w.injured ? ' <span style="color:#c88;">(Injured)</span>' : '');
                        var sel = '<select data-assign-worker="' + i + '" style="margin-left:6px;padding:2px 6px;background:#1a1525;color:#e8e0e8;border:1px solid rgba(140,120,160,0.4);border-radius:4px;font-size:0.85em;"><option value="">Assign</option><option value="Clearing"' + (w.assignment === 'Clearing' ? ' selected' : '') + '>Clearing</option><option value="Garden"' + (w.assignment === 'Garden' ? ' selected' : '') + '>Garden</option><option value="Kennel"' + (w.assignment === 'Kennel' ? ' selected' : '') + '>Kennel</option><option value="Rabbit Farm"' + (w.assignment === 'Rabbit Farm' ? ' selected' : '') + '>Rabbit Farm</option><option value="Crafting"' + (w.assignment === 'Crafting' ? ' selected' : '') + '>Crafting</option><option value="Command Center"' + (w.assignment === 'Command Center' ? ' selected' : '') + '>Command Center</option></select>';
                        return '<div style="margin:8px 0;padding:8px;background:rgba(0,0,0,0.3);border-radius:4px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;"><img src="' + V + portrait + '" alt="" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" onerror="this.style.display=\'none\'"><div><strong>' + (w.name || w.role) + '</strong> (' + (w.role || 'Worker') + ')' + inj + ' · Fear: ' + (w.fear || 0) + '% · Eff: ' + eff + '%<br><span style="font-size:0.85em;color:#a0a0a0;">' + skills + '</span>' + (w.assignment ? ' · ' + w.assignment : '') + sel + ' <button type="button" class="btn btn-small btn-danger" data-release-worker="' + i + '" title="Release worker">Release</button></div></div>';
                    }).join('') : '<p style="color:#888;">No workers. Hire one to arrive on next helicopter drop.</p>';
                    var hireCost = '5 plants, 3 materials';
                    var canHire = (inv.plants || 0) >= 5 && (inv.materials || 0) >= 3 && !gameState.inboundWorker;
                    var hireTitle = canHire ? 'Hire worker (arrives next helicopter drop)' : (!gameState.inboundWorker ? 'Need ' + hireCost : 'Worker already inbound');
                    var hireRoleSelect = '<label style="margin-right:8px;">Hire as:</label><select id="cmd-hire-role" style="padding:4px 8px;background:#1a1525;color:#e8e0e8;border:1px solid rgba(140,120,160,0.4);border-radius:4px;"><option value="Cook">Cook</option><option value="Security">Security</option><option value="Doctor">Doctor</option><option value="Repair">Repair</option><option value="Caretaker">Caretaker</option></select>';
                    var secLevel = gameState.securityLevel != null ? gameState.securityLevel : 50;
                    locActionsHtml = '<div style="padding:12px;background:rgba(0,0,0,0.4);border-radius:8px;margin-bottom:8px;"><h4 style="margin-bottom:8px;">Command Center</h4><p>Security level: ' + secLevel + '%</p><p>Assets obtained: ' + (cmdStats.missionsCompleted || 0) + '</p><p>Assets escaped: ' + escaped + '</p><p>Assets lost: ' + killed + '</p><p>Player XP: ' + (gameState.playerXP || 0) + '</p><p>Achievements: ' + achCount + ' / ' + achTotal + '</p><p><strong>Helicopter ETA:</strong> ' + heliEtaHtml + '</p>' + inboundLine + '<hr style="border-color:rgba(255,255,255,0.1);margin:10px 0;"><h5 style="margin-bottom:4px;">Facility Status</h5>' + facilityStatusTable + '<hr style="border-color:rgba(255,255,255,0.1);margin:10px 0;"><h5 style="margin-bottom:6px;">Workers</h5>' + workersList + '<p style="margin-top:8px;">' + hireRoleSelect + ' <button type="button" class="btn btn-small" id="btn-cmd-hire" title="' + hireTitle.replace(/"/g, '&quot;') + '">Hire worker (' + hireCost + ')</button></p><p style="margin-top:10px;"><button class="btn btn-small" id="btn-cmd-music">' + (document.getElementById("opt-music") && document.getElementById("opt-music").checked ? 'Music: On' : 'Music: Off') + '</button> <button class="btn btn-small" id="btn-cmd-music-options">Music options</button> <button class="btn btn-small" id="btn-cmd-achievements">Achievements</button></p></div>';
                }
                var workerStatusHtml = '';
                if (locId !== 'command_center') {
                    var aw = getAssignedWorker(gameState, locId);
                    if (aw) {
                        var effPct = getEffectiveSkill(aw, locId);
                        var effColor = effPct < 30 ? '#c88' : effPct < 60 ? '#ca8' : '#8c8';
                        var effMood = effPct >= 60 ? 'calm' : effPct >= 30 ? 'stressed' : 'critical';
                        workerStatusHtml = '<div style="padding:6px 10px;background:rgba(0,0,0,0.25);border-radius:4px;font-size:0.9em;">Worker: ' + (aw.name || aw.role) + ' (' + (aw.role || 'Worker') + ')<br><span style="color:' + effColor + '">Effectiveness: ' + effPct + '% (' + effMood + ')</span></div>';
                    } else {
                        workerStatusHtml = '<div style="padding:6px 10px;background:rgba(0,0,0,0.2);border-radius:4px;font-size:0.9em;color:#888;">No worker assigned · Effectiveness: 50% (baseline)</div>';
                    }
                }
                var locActionsEl = document.getElementById('location-actions');
                if (locActionsEl) { locActionsEl.innerHTML = locActionsHtml; locActionsEl.style.display = locActionsHtml ? 'grid' : 'none'; }
                var workerStatusEl = document.getElementById('worker-status');
                if (workerStatusEl) { workerStatusEl.innerHTML = workerStatusHtml; workerStatusEl.style.display = workerStatusHtml ? 'block' : 'none'; }
                var rpLoc = gameState.currentLocation || 'clearing';
                var rpReports = document.getElementById('btn-read-reports');
                var rpStaff = document.getElementById('btn-talk-staff');
                var rpMinigames = document.getElementById('btn-minigames');
                if (rpReports) rpReports.style.display = rpLoc === 'command_center' ? 'block' : 'none';
                if (rpStaff) rpStaff.style.display = rpLoc === 'command_center' ? 'block' : 'none';
                if (rpMinigames) rpMinigames.style.display = rpLoc === 'kennel' ? 'block' : 'none';
                var cleanBtn = document.getElementById('btn-clean-kennels');
                if (cleanBtn) cleanBtn.addEventListener('click', function() { startAction(gameState, 'clean_kennels', addStory); render(); });
                var renameBtn = document.getElementById('btn-rename-wolf');
                if (renameBtn) renameBtn.addEventListener('click', function() {
                    var newName = prompt('Rename ' + gameState.pet.name + ' to:', gameState.pet.name);
                    if (newName != null && newName.trim()) {
                        newName = newName.trim().slice(0, 20);
                        var old = gameState.pet.name;
                        gameState.pet.name = newName;
                        addStory(old + ' is now known as ' + newName);
                        render();
                    }
                });
                var breedBtn = document.getElementById('btn-breed-wolf');
                if (breedBtn) breedBtn.addEventListener('click', function() {
                    var pack = gameState.pack || [];
                    var adults = pack.filter(function(p) { return getLifeStage(p.ageInDays) === 'adult'; });
                    if (adults.length < 2) { addStory('Need at least two adult wolves to breed.'); return; }
                    if (pack.length >= (CONFIG.MAX_PACK_SIZE || 6)) { addStory('Sanctuary at maximum capacity (6 wolves). Release a wolf first.'); return; }
                    if (gameState.breeding) { addStory('Breeding already in progress. Gestation: ' + (gameState.breeding.dueDay - (gameState.world.currentDay || 1)) + ' days left.'); return; }
                    showBreedingModal();
                });
                var cmdMusicBtn = document.getElementById('btn-cmd-music');
                if (cmdMusicBtn) cmdMusicBtn.addEventListener('click', function() {
                    var opt = document.getElementById('opt-music');
                    if (opt) { opt.checked = !opt.checked; cmdMusicBtn.textContent = opt.checked ? 'Music: On' : 'Music: Off'; }
                    if (gameMusicAudio) { if (opt.checked) gameMusicAudio.play().catch(function() {}); else gameMusicAudio.pause(); }
                });
                var cmdAchBtn = document.getElementById('btn-cmd-achievements');
                if (cmdAchBtn) cmdAchBtn.addEventListener('click', showAchievementsModal);
                if (locId === 'command_center') {
                    locActionsEl.querySelectorAll('[data-release-worker]').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            var i = parseInt(btn.getAttribute('data-release-worker'), 10);
                            var w = gameState.workers[i];
                            if (!w) return;
                            gameState.workers.splice(i, 1);
                            if (gameState.pet) { gameState.pet.hunger = 0; gameState.pet.thirst = 0; }
                            addStory('Worker ' + (w.name || w.role) + ' was released. The wolves seem... satisfied.', 'high');
                            if (Math.random() < 0.3) {
                                var creep = ['Note: ' + (w.name || w.role) + ' was seen talking to someone outside the facility last week.', 'Interesting: ' + (w.name || w.role) + ' had been acting strangely lately. Now the wolves are calm.', 'Report: The wolves haven\'t eaten in days, yet they\'re not hungry. Curious.', 'Observation: Since ' + (w.name || w.role) + ' left, the pack seems... content.'];
                                addStory(creep[Math.floor(Math.random() * creep.length)], 'medium');
                            }
                            render();
                        });
                    });
                    var hireBtn = document.getElementById('btn-cmd-hire');
                    if (hireBtn) hireBtn.addEventListener('click', function() {
                        var inv = gameState.inventory || {};
                        if (gameState.inboundWorker) { addStory('Cannot hire: Worker already inbound.'); render(); return; }
                        if ((inv.plants || 0) < 5 || (inv.materials || 0) < 3) { addStory('Cannot hire: Need 5 plants and 3 materials.'); render(); return; }
                        var roleEl = document.getElementById('cmd-hire-role');
                        var role = (roleEl && roleEl.value) ? roleEl.value : 'Cook';
                        showHirePreviewModal(role);
                    });
                    locActionsEl.querySelectorAll('[data-assign-worker]').forEach(function(sel) {
                        sel.addEventListener('change', function() {
                            var i = parseInt(sel.getAttribute('data-assign-worker'), 10);
                            var w = gameState.workers[i];
                            if (w) { w.assignment = sel.value || ''; render(); }
                        });
                    });
                    var musicOptsBtn = document.getElementById('btn-cmd-music-options');
                    if (musicOptsBtn) musicOptsBtn.addEventListener('click', function() { document.getElementById('options-panel').classList.add('visible'); });
                }
                var unconscious = !pet || (pet.sleep ?? 100) <= 0;
                var pupOrElder = !pet || (pet.lifeStage === 'pup' || pet.lifeStage === 'elder');
                var allActions = {
                    rest: { id: 'rest', label: 'Rest', cls: 'btn-care', fn: () => { startAction(gameState, 'rest', addStory); render(); }, dis: unconscious || false },
                    bond: { id: 'bond', label: 'Spend time', cls: 'btn-care', fn: () => { startAction(gameState, 'bond', addStory); render(); }, dis: unconscious || !!gameState.petEscaped || (pet ? (pet.stamina ?? 100) < (STAMINA_COST.bond || 5) : true) },
                    train: { id: 'train', label: 'Train', cls: 'btn-train', fn: () => { startAction(gameState, 'train', addStory); render(); }, dis: unconscious || !!gameState.petEscaped || (pet ? (pet.stamina ?? 100) < (STAMINA_COST.train || 15) : true) },
                    feed_raw_meat: { id: 'feed_raw_meat', label: 'Feed raw meat', cls: 'btn-care', fn: () => { startAction(gameState, 'feed_raw_meat', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.rawMeat || 0) < 1 },
                    feed_plants: { id: 'feed_plants', label: 'Feed plants', cls: 'btn-care', fn: () => { startAction(gameState, 'feed_plants', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.plants || 0) < 1 },
                    feed_cooked_meat: { id: 'feed_cooked_meat', label: 'Feed cooked meat', cls: 'btn-care', fn: () => { startAction(gameState, 'feed_cooked_meat', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.cookedMeat || 0) < 1 },
                    feed_cooked_plants: { id: 'feed_cooked_plants', label: 'Feed cooked plants', cls: 'btn-care', fn: () => { startAction(gameState, 'feed_cooked_plants', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.cookedVegetables || 0) < 1 },
                    water: { id: 'water', label: 'Water', cls: 'btn-care', fn: () => { startAction(gameState, 'water', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.water || 0) < 1 },
                    heal: { id: 'heal', label: 'Heal', cls: 'btn-care', fn: () => { startAction(gameState, 'heal', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.meds || 0) < 1 },
                    ritual: { id: 'ritual', label: 'Ritual', cls: 'btn-train', fn: () => { startAction(gameState, 'ritual', addStory); render(); }, dis: unconscious || gameState.petEscaped || (inv.materials || 0) < 1 },
                    sleep: { id: 'sleep', label: 'Sleep', cls: 'btn-care', fn: () => { startAction(gameState, 'sleep', addStory); render(); }, dis: !!gameState.petEscaped || (pet ? (pet.sleep ?? 100) >= 95 : true) },
                    forage: { id: 'forage', label: 'Forage', cls: 'btn-mission', fn: () => { startAction(gameState, 'forage', addStory); render(); }, dis: unconscious || (pet ? (pet.stamina ?? 100) < (STAMINA_COST.forage || 20) : true) },
                    patrol: { id: 'patrol', label: 'Patrol', cls: 'btn-mission', fn: () => { startAction(gameState, 'patrol', addStory); render(); }, dis: unconscious || pupOrElder || (pet ? (pet.stamina ?? 100) < (STAMINA_COST.patrol || 20) : true) },
                    hunt: { id: 'hunt', label: 'Hunt', cls: 'btn-mission', fn: () => { startAction(gameState, 'hunt', addStory); render(); }, dis: unconscious || pupOrElder || (pet ? (pet.stamina ?? 100) < (STAMINA_COST.hunt || 25) : true) },
                    water_garden: { id: 'water_garden', label: 'Water garden', cls: 'btn-care', fn: () => { startAction(gameState, 'water_garden', addStory); render(); }, dis: false },
                    plant: { id: 'plant', label: 'Plant', cls: 'btn-care', fn: () => { startAction(gameState, 'plant', addStory); render(); }, dis: (inv.seeds || 0) < 1 || ((gameState.garden || {}).crops || []).length > 0 },
                    add_compost: { id: 'add_compost', label: 'Add Compost', cls: 'btn-care', fn: () => { startAction(gameState, 'add_compost', addStory); render(); }, dis: !((gameState.garden || {}).crops || []).length || ((inv.compostUnits || 0) < 1 && ((gameState.compost && gameState.compost.readyInDays > 0) || ((gameState.compost && gameState.compost.level) || 0) < 25)) },
                    harvest: { id: 'harvest', label: 'Harvest', cls: 'btn-care', fn: () => { startAction(gameState, 'harvest', addStory); render(); }, dis: !((gameState.garden || {}).crops || []).length || ((gameState.garden || {}).crops || [])[0].daysLeft > 0 },
                    feed_rabbit: { id: 'feed_rabbit', label: 'Feed rabbit', cls: 'btn-care', fn: () => { startAction(gameState, 'feed_rabbit', addStory); render(); }, dis: gameState.rabbitCount < 1 || ((inv.plants || 0) + (inv.food || 0) < 1) },
                    water_rabbit: { id: 'water_rabbit', label: 'Water rabbit', cls: 'btn-care', fn: () => { startAction(gameState, 'water_rabbit', addStory); render(); }, dis: gameState.rabbitCount < 1 },
                    clean_rabbit: { id: 'clean_rabbit', label: 'Clean cage', cls: 'btn-care', fn: () => { startAction(gameState, 'clean_rabbit', addStory); render(); }, dis: gameState.rabbitCount < 1 },
                    treat_rabbit: { id: 'treat_rabbit', label: 'Treat rabbit', cls: 'btn-care', fn: () => { startAction(gameState, 'treat_rabbit', addStory); render(); }, dis: gameState.rabbitCount < 1 || (inv.meds || 0) < 1 },
                    cook: { id: 'cook', label: 'Cook meat', cls: 'btn-care', fn: () => { startAction(gameState, 'cook', addStory); render(); }, dis: (inv.rawMeat || 0) < 1 },
                    craft_medicine: { id: 'craft_medicine', label: 'Craft medicine', cls: 'btn-care', fn: () => { startAction(gameState, 'craft_medicine', addStory); render(); }, dis: (inv.herbs || 0) < 1 || (inv.materials || 0) < 1 },
                    capture_rabbit: { id: 'capture_rabbit', label: 'Capture rabbit', cls: 'btn-mission', fn: () => { startAction(gameState, 'capture_rabbit', addStory); render(); }, dis: false },
                    harvest_rabbit: { id: 'harvest_rabbit', label: 'Harvest', cls: 'btn-care', fn: () => { startAction(gameState, 'harvest_rabbit', addStory); render(); }, dis: gameState.rabbitCount < 1 },
                    breed_rabbit: { id: 'breed_rabbit', label: 'Breed', cls: 'btn-care', fn: () => { startAction(gameState, 'breed_rabbit', addStory); render(); }, dis: (gameState.rabbitCount || 0) < 2 || (gameState.rabbitCount || 0) >= 10 || (gameState.rabbit && ((gameState.rabbit.sick || 0) >= 30 || (gameState.rabbit.hunger || 50) > 70 || (gameState.rabbit.thirst || 50) > 70 || (gameState.rabbit.clean || 80) < 70)) },
                    set_rabbit_traps: { id: 'set_rabbit_traps', label: 'Set Rabbit Traps', cls: 'btn-mission', fn: () => { startAction(gameState, 'set_rabbit_traps', addStory); render(); }, dis: (inv.rabbitTrap || 0) < 1 },
                    craft_rabbit_trap: { id: 'craft_rabbit_trap', label: 'Craft Rabbit Trap', cls: 'btn-care', fn: () => { startAction(gameState, 'craft_rabbit_trap', addStory); render(); }, dis: (inv.materials || 0) < 3 || (inv.plants || 0) < 2 },
                    craft_net: { id: 'craft_net', label: 'Craft Net', cls: 'btn-care', fn: () => { startAction(gameState, 'craft_net', addStory); render(); }, dis: (inv.materials || 0) < 5 || (inv.plants || 0) < 3 },
                    craft_bait: { id: 'craft_bait', label: 'Craft Bait', cls: 'btn-care', fn: () => { startAction(gameState, 'craft_bait', addStory); render(); }, dis: (inv.cookedVegetables || 0) < 2 && (inv.rawMeat || 0) < 1 },
                    craft_premium_bait: { id: 'craft_premium_bait', label: 'Craft Premium Bait', cls: 'btn-care', fn: () => { startAction(gameState, 'craft_premium_bait', addStory); render(); }, dis: (inv.cookedMeat || 0) < 1 || (inv.herbs || 0) < 1 },
                    hike_creek: { id: 'hike_creek', label: 'Hike to Creek', cls: 'btn-care', fn: () => { startAction(gameState, 'hike_creek', addStory); render(); }, dis: unconscious || !gameState.pet || (gameState.pet.energy || 100) < 15 || (gameState.pet.stamina ?? 100) < (STAMINA_COST.hike_creek || 15) },
                    collect_rain: { id: 'collect_rain', label: 'Collect water', cls: 'btn-care', fn: () => { startAction(gameState, 'collect_rain', addStory); render(); }, dis: !gameState.rainCatcherBuilt },
                    craft_rain_catcher: { id: 'craft_rain_catcher', label: 'Build Rain Catcher', cls: 'btn-care', fn: () => { startAction(gameState, 'craft_rain_catcher', addStory); render(); }, dis: gameState.rainCatcherBuilt || (inv.materials || 0) < 3 },
                    cook_plants: { id: 'cook_plants', label: 'Cook Plants', cls: 'btn-care', fn: () => { startAction(gameState, 'cook_plants', addStory); render(); }, dis: (inv.plants || 0) < 1 },
                    repair_clearing: { id: 'repair_clearing', label: 'Repair dummy', cls: 'btn-care', fn: () => { startAction(gameState, 'repair_clearing', addStory); render(); }, dis: !(gameState.damaged && gameState.damaged.clearing) || (inv.materials || 0) < 2 },
                    repair_kennel: { id: 'repair_kennel', label: 'Repair gate', cls: 'btn-care', fn: () => { startAction(gameState, 'repair_kennel', addStory); render(); }, dis: !(gameState.damaged && gameState.damaged.kennel) || (inv.materials || 0) < 2 },
                    repair_garden: { id: 'repair_garden', label: 'Repair irrigation', cls: 'btn-care', fn: () => { startAction(gameState, 'repair_garden', addStory); render(); }, dis: !(gameState.damaged && gameState.damaged.garden) || (inv.materials || 0) < 1 },
                    repair_rabbit_farm: { id: 'repair_rabbit_farm', label: 'Repair cage', cls: 'btn-care', fn: () => { startAction(gameState, 'repair_rabbit_farm', addStory); render(); }, dis: !(gameState.damaged && gameState.damaged.rabbit_farm) || (inv.materials || 0) < 1 },
                    repair_crafting: { id: 'repair_crafting', label: 'Repair grill', cls: 'btn-care', fn: () => { startAction(gameState, 'repair_crafting', addStory); render(); }, dis: !(gameState.damaged && gameState.damaged.crafting) || (inv.materials || 0) < 2 },
                };
                var rabbitIds = (gameState.rabbitCount || 0) > 0 ? ['feed_rabbit', 'water_rabbit', 'clean_rabbit', 'treat_rabbit', 'harvest_rabbit', 'breed_rabbit'] : ['capture_rabbit'];
                var gardenIds = ['plant', 'water_garden', 'add_compost', 'harvest'];
                if (gameState.rainCatcherBuilt) gardenIds.unshift('collect_rain');
                var craftingIds = ['cook', 'craft_medicine', 'cook_plants', 'craft_rain_catcher', 'craft_rabbit_trap', 'craft_net', 'craft_bait', 'craft_premium_bait'];
                var dam = gameState.damaged || {};
                // Which action IDs show on each tab. Add/remove IDs to change buttons. Repair buttons appear when that location is damaged.
                var locActionIds = {
                    clearing: ['hunt', 'train', 'forage', 'patrol', 'hike_creek', 'set_rabbit_traps'].concat(dam.clearing ? ['repair_clearing'] : []),
                    kennel: ['feed_raw_meat', 'feed_plants', 'feed_cooked_meat', 'feed_cooked_plants', 'water', 'bond', 'heal', 'ritual', 'sleep', 'rest'].concat(dam.kennel ? ['repair_kennel'] : []),
                    rabbit_farm: rabbitIds.concat(dam.rabbit_farm ? ['repair_rabbit_farm'] : []),
                    garden: gardenIds.concat(dam.garden ? ['repair_garden'] : []),
                    crafting: craftingIds.concat(dam.crafting ? ['repair_crafting'] : []),
                    command_center: [],
                };
                var ids = locActionIds[locId] != null ? locActionIds[locId] : locActionIds.clearing;
                actions = ids.map(function(key) { var a = allActions[key]; if (!a) return null; return { id: a.id, label: a.label, cls: a.cls, fn: a.fn, dis: a.dis || currentTabBusy }; }).filter(Boolean);
                var queueHere = getQueueForLoc(gameState, locId);
                // When a timer is running we DON'T rebuild the button grid—only update the timer text. Stops buttons from merging.
                var timerActive = queueHere.length > 0 && queueHere[0].busyUntil != null && Date.now() < queueHere[0].busyUntil;
            }
            // Used for disabled-button tooltips and story messages. Add a new "if (id === 'my_action') return 'reason';" for new actions.
            function getActionUnavailableReason(id) {
                if (currentTabBusy) return 'Queue full. Wait or clear queue.';
                if (!pet && ['bond','train','feed_raw_meat','feed_plants','feed_cooked_meat','feed_cooked_plants','water','heal','ritual','sleep','rest','forage','patrol','hunt','hike_creek'].indexOf(id) >= 0) return 'No wolf in pack.';
                if (gameState.petEscaped && ['bond','train','feed_raw_meat','feed_plants','feed_cooked_meat','feed_cooked_plants','water','heal','ritual','sleep'].indexOf(id) >= 0) return 'Wolf has escaped. Find them on hunt or patrol.';
                if (unconscious && ['hunt','train','forage','patrol','bond','feed','water','heal','ritual','sleep','hike_creek'].indexOf(id) >= 0) return 'Wolf is unconscious. Put them to sleep in kennel first.';
                if (id === 'hunt' || id === 'patrol') {
                    if (pupOrElder) return 'Pups and elders cannot hunt or patrol.';
                    if (pet && (pet.hunger || 0) > 50) return 'Wolf is hungry (' + Math.round(pet.hunger) + '%). Fill needs first.';
                    if (pet && (pet.thirst != null ? pet.thirst : 50) > 50) return 'Wolf is thirsty (' + Math.round(pet.thirst != null ? pet.thirst : 50) + '%). Fill needs first.';
                    if (pet && (pet.stamina ?? 100) < (STAMINA_COST.hunt || 25)) return 'Not enough stamina.';
                }
                if (id === 'forage' && pet && (pet.stamina ?? 100) < (STAMINA_COST.forage || 20)) return 'Not enough stamina.';
                if (id === 'train' && pet && (pet.stamina ?? 100) < (STAMINA_COST.train || 15)) return 'Not enough stamina.';
                if (id === 'feed_raw_meat' && (inv.rawMeat || 0) < 1) return 'No raw meat.';
                if (id === 'feed_plants' && (inv.plants || 0) < 1) return 'No plants.';
                if (id === 'feed_cooked_meat' && (inv.cookedMeat || 0) < 1) return 'No cooked meat.';
                if (id === 'feed_cooked_plants' && (inv.cookedVegetables || 0) < 1) return 'No cooked vegetables. Cook plants first.';
                if (id === 'water' && (inv.water || 0) < 1) return 'No water. Hike to creek or build rain catcher.';
                if (id === 'heal' && (inv.meds || 0) < 1) return 'No medicine.';
                if (id === 'ritual' && (inv.materials || 0) < 1) return 'No materials.';
                if (id === 'sleep') return (pet.sleep ?? 100) >= 95 ? 'Wolf is already well rested.' : '';
                if (id === 'cook' && (inv.rawMeat || 0) < 1) return 'No raw meat.';
                if (id === 'cook_plants' && (inv.plants || 0) < 1) return 'No plants.';
                if (id === 'craft_medicine' && ((inv.herbs || 0) < 1 || (inv.materials || 0) < 1)) return 'Need herbs and materials.';
                if (id === 'plant' && (inv.seeds || 0) < 1) return 'No seeds.';
                if (id === 'plant' && ((gameState.garden || {}).crops || []).length > 0) return 'Already something growing.';
                if (id === 'bond' && (pet.stamina ?? 100) < (STAMINA_COST.bond || 5)) return 'Not enough stamina.';
                if (id === 'hike_creek' && (pet.energy || 100) < 15) return 'Not enough energy.';
                if (id === 'hike_creek' && (pet.stamina ?? 100) < (STAMINA_COST.hike_creek || 15)) return 'Not enough stamina.';
                if (id === 'collect_rain') return !gameState.rainCatcherBuilt ? 'Build rain catcher first.' : '';
                if (id === 'craft_rain_catcher') return gameState.rainCatcherBuilt ? 'Already built.' : (inv.materials || 0) < 3 ? 'Need 3 materials.' : '';
                if (id === 'harvest' && (!((gameState.garden || {}).crops || []).length || ((gameState.garden || {}).crops || [])[0].daysLeft > 0)) return !((gameState.garden || {}).crops || []).length ? 'Nothing to harvest.' : 'Crops not ready yet.';
                if (id === 'add_compost') { var g = gameState.garden || {}; if (!(g.crops || []).length) return 'No crops to fertilize.'; if ((inv.compostUnits || 0) < 1 && (gameState.compost && gameState.compost.readyInDays > 0)) return 'No compost units. Clean kennel or rabbit cage.'; if ((inv.compostUnits || 0) < 1 && ((gameState.compost && gameState.compost.level) || 0) < 25) return 'No compost units.'; }
                if (id.indexOf('repair_') === 0) { var loc = id.replace('repair_', ''); if (!(gameState.damaged && gameState.damaged[loc])) return 'Nothing to repair here.'; if ((inv.materials || 0) < (loc === 'clearing' || loc === 'kennel' || loc === 'crafting' ? 2 : 1)) return 'Need more materials.'; }
                if (id === 'feed_rabbit' && gameState.rabbitCount < 1) return 'No rabbit.';
                if (id === 'feed_rabbit' && (inv.plants || 0) + (inv.food || 0) < 1) return 'No food for rabbit.';
                if (id === 'water_rabbit' && gameState.rabbitCount < 1) return 'No rabbit.';
                if (id === 'treat_rabbit' && (inv.meds || 0) < 1) return 'No medicine.';
                if (id === 'breed_rabbit' && (gameState.rabbitCount || 0) < 2) return 'Need at least 2 rabbits to breed.';
                if (id === 'breed_rabbit' && (gameState.rabbitCount || 0) >= 10) return 'Too many rabbits already.';
                if (id === 'breed_rabbit' && gameState.rabbit && ((gameState.rabbit.sick || 0) >= 30 || (gameState.rabbit.clean || 80) < 70)) return 'Rabbits too sick or cage too dirty. Care for them first.';
                if (id === 'breed_rabbit' && gameState.rabbit && ((gameState.rabbit.hunger || 50) > 70 || (gameState.rabbit.thirst || 50) > 70)) return 'Rabbits too hungry or thirsty.';
                if (id === 'set_rabbit_traps' && (inv.rabbitTrap || 0) < 1) return 'No traps. Craft one first (3 materials + 2 plants).';
                if (id === 'craft_rabbit_trap' && ((inv.materials || 0) < 3 || (inv.plants || 0) < 2)) return 'Need 3 materials and 2 plants (vines).';
                if (id === 'craft_net' && ((inv.materials || 0) < 5 || (inv.plants || 0) < 3)) return 'Need 5 materials and 3 plants (vines).';
                if (id === 'craft_bait' && (inv.cookedVegetables || 0) < 2 && (inv.rawMeat || 0) < 1) return 'Need 2 cooked veg or 1 raw meat.';
                if (id === 'craft_premium_bait' && ((inv.cookedMeat || 0) < 1 || (inv.herbs || 0) < 1)) return 'Need 1 cooked meat and 1 herbs.';
                return 'Something\'s not right. Check Reports > Troubleshooting.';
            }
            currentActionsById = {};  // So the single click handler (below) can look up the action by id. Updated every render.
            actions.forEach(function(a) { currentActionsById[a.id] = a; });
            if (!timerActive) {
                // Build button HTML and put it in #action-buttons. One listener on the container (delegation) handles all clicks—no re-binding per button.
                const actionHtml = actions.map(function(a) {
                    var reason = getActionUnavailableReason(a.id);
                    var tipText = a.dis ? ('Cannot ' + (a.label || a.id).toLowerCase() + ': ' + reason) : a.label;
                    var tip = ' title="' + tipText.replace(/"/g, '&quot;') + '"';
                    var extraClass = a.dis ? ' btn-disabled-style' : '';
                    return '<button type="button" class="btn ' + a.cls + extraClass + '"' + tip + ' id="btn-' + a.id + '" data-action-id="' + a.id + '" data-disabled="' + (a.dis ? '1' : '0') + '">' + a.label + '</button>';
                }).join('');
                document.getElementById('action-buttons').innerHTML = actionHtml;
                // One click listener on the container (event delegation). Clicks on buttons are handled here; we look up the action by data-action-id. No "3 clicks" bug.
                (function ensureActionButtonsDelegation() {
                    var container = document.getElementById('action-buttons');
                    if (!container || container._delegationBound) return;
                    container._delegationBound = true;
                    container.addEventListener('click', function(e) {
                        var btn = e.target && e.target.closest ? e.target.closest('[data-action-id]') : null;
                        if (!btn) return;
                        var id = btn.getAttribute('data-action-id');
                        var a = currentActionsById[id];
                        if (!a) return;
                        if (btn.getAttribute('data-disabled') === '1') {
                            var reason = (typeof getActionUnavailableReason === 'function' ? getActionUnavailableReason(id) : 'Unavailable');
                            if (typeof addStory === 'function') addStory('Cannot ' + (a.label || id).toLowerCase() + ': ' + reason);
                            if (typeof render === 'function') render();
                            return;
                        }
                        a.fn();
                    });
                })();
            }

            var tabTimersEl = document.getElementById('tab-timers');
            if (tabTimersEl) {
                var now = Date.now();
                var labels = { clearing: 'Clearing', garden: 'Garden', kennel: 'Kennel', rabbit_farm: 'Rabbit', crafting: 'Crafting' };
                var maxQueue = typeof MAX_QUEUE_PER_TAB !== 'undefined' ? MAX_QUEUE_PER_TAB : 3;
                tabTimersEl.innerHTML = ['clearing', 'garden', 'kennel', 'rabbit_farm', 'crafting'].map(function(locId) {
                    var queue = getQueueForLoc(gameState, locId);
                    var head = (labels[locId] || locId).toUpperCase() + ' [' + queue.length + '/' + maxQueue + ']';
                    var parts = [];
                    if (queue.length && queue[0].busyUntil != null && now < queue[0].busyUntil) {
                        var sec = Math.max(0, Math.ceil((queue[0].busyUntil - now) / 1000));
                        parts.push('► ' + queue[0].id.replace(/_/g, ' ') + ' (' + Math.floor(sec / 60) + ':' + String(sec % 60).padStart(2, '0') + ')');
                    } else if (queue.length) parts.push('► ' + queue[0].id.replace(/_/g, ' '));
                    for (var i = 1; i < queue.length; i++) parts.push('| ' + queue[i].id.replace(/_/g, ' ') + ' (queued)');
                    return '<span style="white-space:nowrap;">' + head + (parts.length ? ' ' + parts.join(' ') : ' —') + '</span>';
                }).join(' ');
            }
            var queueListEl = document.getElementById('action-queue-list');
            if (queueListEl) {
                var q = getQueueForLoc(gameState, locId);
                var lab = { clearing: 'Clearing', garden: 'Garden', kennel: 'Kennel', rabbit_farm: 'Rabbit', crafting: 'Crafting' }[locId] || locId;
                if (q.length === 0) queueListEl.textContent = lab + ': —';
                else {
                    var now = Date.now();
                    var lines = [];
                    if (q[0].busyUntil != null && now < q[0].busyUntil) {
                        var sec = Math.ceil((q[0].busyUntil - now) / 1000);
                        lines.push('Now: ' + q[0].id + ' (' + Math.floor(sec / 60) + ':' + String(sec % 60).padStart(2, '0') + ')');
                    } else lines.push('Now: ' + q[0].id);
                    for (var j = 1; j < q.length; j++) lines.push('Next: ' + q[j].id);
                    queueListEl.textContent = lab + ' — ' + lines.join(' | ');
                }
            }
            var waitPanel = document.getElementById('while-wait-panel');
            if (waitPanel) {
                waitPanel.style.display = (currentTabHasBusy && !gameState.encounterPrompt) ? 'block' : 'none';
                var obsActive = gameState.observeUntil && Date.now() < gameState.observeUntil;
                var obsContainer = document.getElementById('observe-progress-container');
                if (obsContainer) obsContainer.style.display = obsActive ? 'block' : 'none';
                if (obsActive) {
                    var secs = Math.ceil((gameState.observeUntil - Date.now()) / 1000);
                    var pct = Math.max(0, ((gameState.observeUntil - Date.now()) / 15000) * 100);
                    var secEl = document.getElementById('observe-secs');
                    var barEl = document.getElementById('observe-progress-bar');
                    if (secEl) secEl.textContent = secs;
                    if (barEl) barEl.style.width = pct + '%';
                }
            }
            if (gameState.observeUntil && Date.now() >= gameState.observeUntil) {
                gameState.observeUntil = 0;
                var locId = gameState.currentLocation || 'clearing';
                var msg = '';
                if (locId === 'kennel') {
                    var need = (pet.hunger || 0) > 70 ? 'Hunger critical' : (pet.thirst || 50) > 70 ? 'Thirst critical' : (pet.fear || 0) > 60 ? 'Fear high' : 'Bond ' + pet.bond + '%';
                    msg = 'Werewolf: ' + need + '. Hunger ' + (pet.hunger || 0) + '%, Thirst ' + (pet.thirst != null ? pet.thirst : 50) + '%, Fear ' + pet.fear + '%, Bond ' + pet.bond + '%.';
                    gameState.pet.bond = Math.min(100, (gameState.pet.bond || 50) + 1);
                } else if (locId === 'garden') {
                    var garden = gameState.garden || {};
                    var crops = garden.crops || [];
                    var comp = gameState.compost || {};
                    if (crops.length) {
                        var c = crops[0];
                        var pct = c.daysLeft != null ? Math.max(0, 100 - (c.daysLeft / 3) * 33) : 50;
                        msg = 'Farm plot: ' + (garden.watered ? 'Watered.' : 'Needs water!') + ' Harvest progress: ' + Math.round(pct) + '%.';
                    } else msg = 'Farm plot: Empty.';
                    msg += ' Compost: ' + (comp.level || 0) + '% full' + (comp.readyInDays > 0 ? ', ready in ' + comp.readyInDays + ' days.' : ', ready.');
                } else if (locId === 'rabbit_farm') {
                    if (gameState.rabbitCount > 0) {
                        var r = gameState.rabbit || {};
                        msg = 'Rabbits: Fed ' + (r.lastFedDay === gameState.world.currentDay ? 'today' : 'not today') + '. Hunger ' + (r.hunger || 0) + '%, Thirst ' + (r.thirst || 0) + '%, Clean ' + (r.clean || 0) + '%.';
                    } else msg = 'Rabbit farm: Empty.';
                } else if (locId === 'crafting') {
                    msg = 'Grill: ' + (gameState.grillOn ? 'On (cooking).' : 'Off.');
                } else {
                    msg = 'Clearing. Path is quiet.';
                }
                addStory('Observe: ' + msg);
            }
            // Newest first. The story feed: where "Luna is thirsty" and "Your rabbits have died" live in harmony.
            document.getElementById('story-feed').innerHTML = storyLog.map(function(e) { return '<div class="story-entry">' + (e.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</div>'; }).join('');
        }

        function startNewGame() {
            gameState = createGameState();
            storyLog.length = 0;
            combatLog.length = 0;
            addStory('In the desolate borderlands, you found one who still answers to the moon. Together you endure.');
            document.getElementById('top-bar').style.display = 'flex';
            document.getElementById('game-container').style.display = 'grid';
            render();
        }

        // Saves to browser localStorage under key 'desolation_save'. One slot. Want multiple slots? Duplicate and add a slot index to the key.
        function saveGame() {
            try {
                const data = JSON.stringify({ state: gameState, story: storyLog.slice(0, 15) });
                localStorage.setItem('desolation_save', data);
                addStory('You note everything down. The facility log is updated.');
                render();
            } catch (e) {
                addStory('The log won\'t take the ink. Save failed.');
            }
        }

        // Loads from localStorage. Patches missing fields so old save files still work after you add new features (migration).
        // Added a new stat or flag? Add a line here: if (gameState.myNewThing == null) gameState.myNewThing = defaultValue;
        function loadGame() {
            try {
                const raw = localStorage.getItem('desolation_save');
                if (!raw) { addStory('No previous log found. Start a new assignment.'); return false; }
                const data = JSON.parse(raw);
                gameState = data.state;
                if (gameState.inCage == null) gameState.inCage = true;
                gameState.currentEnemy = null;
                if (gameState.pet && !gameState.pet.personalityType) gameState.pet.personalityType = (typeof PERSONALITY_TYPES !== 'undefined' && PERSONALITY_TYPES.length) ? PERSONALITY_TYPES[Math.floor(Math.random() * PERSONALITY_TYPES.length)] : 'Stoic';
                if (gameState.inventory && gameState.inventory.starPotion == null) gameState.inventory.starPotion = 0;
                if (gameState.inventory && gameState.inventory.rabbitTrap == null) gameState.inventory.rabbitTrap = 0;
                if (gameState.inventory && gameState.inventory.net == null) gameState.inventory.net = 0;
                if (gameState.inventory && gameState.inventory.bait == null) gameState.inventory.bait = 0;
                if (gameState.inventory && gameState.inventory.premiumBait == null) gameState.inventory.premiumBait = 0;
                gameState.encounterPrompt = null;
                gameState.combatInProgress = false;
                if (gameState.busyUntil == null) gameState.busyUntil = 0;
                if (gameState.currentAction == null) gameState.currentAction = null;
                if (gameState.actionQueue == null) gameState.actionQueue = [];
                if (gameState.actionByLocation == null) gameState.actionByLocation = { clearing: [], garden: [], kennel: [], rabbit_farm: [], crafting: [] };
                ['clearing', 'garden', 'kennel', 'rabbit_farm', 'crafting'].forEach(function(locId) { getQueueForLoc(gameState, locId); });
                if (gameState.reports == null) gameState.reports = [];
                if (gameState.currentLocation == null) gameState.currentLocation = 'clearing';
                if (gameState.compost == null) gameState.compost = { level: 0, readyInDays: 3 };
                var inv = gameState.inventory || {};
                if (inv.rawMeat == null) inv.rawMeat = 0;
                if (inv.cookedVegetables == null) inv.cookedVegetables = 0;
                if (inv.compostUnits == null) inv.compostUnits = 0;
                if (inv.cookedMeat == null) inv.cookedMeat = 0;
                if (inv.plants == null) inv.plants = 0;
                if (inv.seeds == null) inv.seeds = inv.food != null ? 2 : 2;
                if (inv.herbs == null) inv.herbs = 0;
                if (gameState.garden == null) gameState.garden = { crops: [], compostBonus: 0, watered: false, dying: false };
                if (gameState.garden.watered == null) gameState.garden.watered = false;
                if (gameState.garden.dying == null) gameState.garden.dying = false;
                if (gameState.kennelClean == null) gameState.kennelClean = 100;
                if (gameState.kennelWaste == null) gameState.kennelWaste = 0;
                if (gameState.rabbitCount == null) gameState.rabbitCount = 0;
                if (gameState.rabbit == null && gameState.rabbitCount > 0) gameState.rabbit = { hunger: 30, thirst: 30, clean: 80, sick: 0 };
                if (gameState.pet && gameState.pet.thirst == null) gameState.pet.thirst = 50;
                if (gameState.pet && gameState.pet.sickness == null) gameState.pet.sickness = 0;
                if (gameState.pet && gameState.pet.sleep == null) gameState.pet.sleep = 100;
                if (gameState.pet && gameState.pet.stamina == null) gameState.pet.stamina = 100;
                if (gameState.pet && gameState.pet.maxStamina == null) gameState.pet.maxStamina = 100;
                if (gameState.pet && gameState.pet.spiritAlignment == null) gameState.pet.spiritAlignment = 0;
                if (gameState.pet && gameState.pet.birthDay == null) gameState.pet.birthDay = 1;
                if (gameState.pet && gameState.pet.ageInDays == null) gameState.pet.ageInDays = Math.max(0, (gameState.world && gameState.world.currentDay) - (gameState.pet.birthDay || 1));
                if (gameState.pet && gameState.pet.lifeStage == null) gameState.pet.lifeStage = getLifeStage(gameState.pet.ageInDays);
                if (gameState.grillOn == null) gameState.grillOn = false;
                if (gameState.rainCatcherBuilt == null) gameState.rainCatcherBuilt = false;
                if (gameState.petEscaped == null) gameState.petEscaped = false;
                if (!Array.isArray(gameState.workers)) gameState.workers = [];
                gameState.workers.forEach(function(w) { if (w.injured == null) w.injured = false; if (w.effectivenessPenalty == null) w.effectivenessPenalty = 0; });
                if (gameState.securityLevel == null) gameState.securityLevel = 50;
                if (!Array.isArray(gameState.pack) || gameState.pack.length === 0) {
                    gameState.pack = [gameState.pet || createPet()];
                    gameState.selectedPetIndex = 0;
                    gameState.pet = gameState.pack[0];
                }
                gameState.pack.forEach(function(p) {
                    if (p.gender == null) p.gender = Math.random() < 0.5 ? 'Male' : 'Female';
                    if (!Array.isArray(p.traits)) p.traits = [];
                    if (!Array.isArray(p.abilities)) p.abilities = [];
                });
                gameState.pet = typeof getCurrentPet === 'function' ? getCurrentPet(gameState) : gameState.pack[gameState.selectedPetIndex != null ? gameState.selectedPetIndex : 0];
                if (!Array.isArray(gameState.squadIndices) || gameState.squadIndices.length === 0) gameState.squadIndices = [gameState.selectedPetIndex != null ? gameState.selectedPetIndex : 0];
                var maxSq = typeof CONFIG !== 'undefined' && CONFIG.MAX_SQUAD_SIZE != null ? CONFIG.MAX_SQUAD_SIZE : 3;
                if (gameState.squadIndices.length > maxSq) gameState.squadIndices = gameState.squadIndices.slice(0, maxSq);
                if (gameState.breeding && !gameState.breeding.dueDay) gameState.breeding = null;
                if (gameState.world && gameState.world.season == null) gameState.world.season = 'spring';
                if (gameState.observeUntil == null) gameState.observeUntil = 0;
                storyLog.length = 0;
                (data.story || []).forEach(s => storyLog.push(typeof s === 'string' ? { text: s } : s));
                hideCinema();
                document.getElementById('top-bar').style.display = 'flex';
                document.getElementById('game-container').style.display = 'grid';
                startInGameMusic();
                addStory('Desolation awaits. You return.');
                render();
                if (autoSaveInterval) clearInterval(autoSaveInterval);
                autoSaveInterval = setInterval(function() {
                    if (gameState && document.getElementById('game-container').style.display === 'grid') {
                        try {
                            var data = JSON.stringify({ state: gameState, story: storyLog.slice(0, 15) });
                            localStorage.setItem('desolation_save', data);
                        } catch (e) {}
                    }
                }, 120000);
                if (gameTickInterval) clearInterval(gameTickInterval);
                var tickMs = 250;
                gameTickInterval = setInterval(function() {
                    if (!gameState || document.getElementById('game-container').style.display !== 'grid') return;
                    var now = Date.now();
                    ['clearing', 'garden', 'kennel', 'rabbit_farm', 'crafting'].forEach(function(locId) {
                        var queue = getQueueForLoc(gameState, locId);
                        if (queue.length && queue[0].busyUntil != null && queue[0].busyUntil <= now) {
                            var slot = queue.shift();
                            executeAction(gameState, slot.id, addStory, locId);
                            var q = getQueueForLoc(gameState, locId);
                            if (q.length && q[0].busyUntil == null) {
                                var sp = ACTION_SPECS[q[0].id];
                                var ms = sp ? (sp.realSec * 1000) / (gameSpeed || 1) : 5000;
                                q[0].busyUntil = Date.now() + ms;
                                q[0].gameMin = sp ? sp.gameMin : 30;
                                if (['cook', 'craft_medicine', 'cook_plants'].indexOf(q[0].id) >= 0) gameState.grillOn = true;
                            }
                        }
                    });
                    gameState._addStory = addStory;
                    advanceTime(gameState, 0.25 * (gameSpeed || 1));
                    if (Date.now() - (gameState._lastFlavorBlurb || 0) >= 60000) { checkFlavorBlurb(gameState); gameState._lastFlavorBlurb = Date.now(); }
                    render();
                }, tickMs);
                return true;
            } catch (e) {
                return false;
            }
        }

        document.getElementById('btn-save').addEventListener('click', saveGame);
        document.getElementById('btn-quit').addEventListener('click', function() {
            if (!confirm('Return to main menu? Game will stay saved.')) return;
            document.getElementById('top-bar').style.display = 'none';
            document.getElementById('game-container').style.display = 'none';
            var cinema = document.getElementById('cinema');
            if (cinema) {
                cinema.classList.remove('hidden');
                cinema.style.display = 'block';
                showScreen('cinema-title-full');
                showMenuOverlay();
            }
        });
        // Music toggle affects ONLY background score. SFX and ambient (rain, wind, crickets, rooster) are independent.
        document.getElementById('btn-music-toggle').addEventListener('click', function() {
            var opt = document.getElementById('opt-music');
            if (!opt) return;
            opt.checked = !opt.checked;
            var btn = document.getElementById('btn-music-toggle');
            if (btn) btn.textContent = opt.checked ? 'Music: On' : 'Music: Off';
            if (gameMusicAudio) {
                if (opt.checked) gameMusicAudio.play().catch(function() {});
                else gameMusicAudio.pause();
            }
        });
        document.getElementById('btn-skip-track').addEventListener('click', skipToNextTrack);
        document.getElementById('btn-prev-track').addEventListener('click', skipToPrevTrack);
        document.getElementById('btn-clear-queue').addEventListener('click', function() {
            if (gameState) {
                var locId = gameState.currentLocation || 'clearing';
                gameState.actionByLocation = gameState.actionByLocation || {};
                gameState.actionByLocation[locId] = [];
                var craftQ = (gameState.actionByLocation.crafting || []).length;
                if (craftQ === 0) gameState.grillOn = false;
                render();
            }
        });
        document.getElementById('btn-read-reports').addEventListener('click', showReportsModal);
        // Travel buttons: click sets gameState.currentLocation and re-renders. Add a new tab? Add a button with data-location="your_loc_id" and add your_loc to LOCATIONS.
        document.getElementById('travel-row').addEventListener('click', function(e) {
            var loc = e.target && e.target.getAttribute('data-location');
            if (loc && gameState) { gameState.currentLocation = loc; render(); }
        });
        function getInspectStatus(state) {
            var w = state.world || {};
            var comp = state.compost || { level: 0, readyInDays: 3 };
            var garden = state.garden || { crops: [] };
            var kc = state.kennelClean != null ? state.kennelClean : 100;
            var foodPct = state.inventory && state.inventory.food != null ? Math.min(100, state.inventory.food * 25) : 50;
            return [
                { name: 'Food bowl', text: foodPct + '% full. Spoils in 4 hours.' },
                { name: 'Kennel', text: kc >= 80 ? 'Clean. Wolf seems comfortable.' : (kc >= 50 ? 'Needs cleaning soon.' : 'Dirty. Clean soon.') },
                { name: 'Garden', text: garden.crops && garden.crops.length ? garden.crops.map(function(c) { return c.name + ': ' + (c.daysLeft || 0) + ' days to harvest.'; }).join(' ') : 'No crops.' },
                { name: 'Compost', text: comp.level + '% full. ' + (comp.readyInDays > 0 ? comp.readyInDays + ' days until fertilizer ready.' : 'Ready to use on garden.') },
                { name: 'Staff', text: 'Medic is tired. Efficiency -10%.' },
            ];
        }
        function showInspectModal() {
            if (!gameState) return;
            var list = getInspectStatus(gameState);
            var msg = list.map(function(x) { return x.name + ': ' + x.text; }).join('\n\n');
            alert('Quick Inspect\n\n' + msg);
        }
        function showMapModal() {
            if (!gameState) return;
            var w = gameState.world || {};
            var msg = 'Exploration map\n\nClearing (current)\nGarden — unlocked\nRabbit Farm — unlocked\nKennel — unlocked\nCrafting — unlocked\n\nResource density: Medium near clearing.\nWeather: ' + (w.weather || 'Clear') + '.\nSeason: ' + (w.season || 'spring') + '.\nMovement detected: None.';
            alert(msg);
        }
        // Talk to the crew. They have things to say. Some of it is unsettling. We're not sorry.
        function showStaffModal() {
            if (!gameState) return;
            var overlay = document.createElement('div');
            overlay.className = 'staff-overlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:20000;display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.style.cssText = 'background:#1a1525;border:1px solid rgba(140,120,160,0.4);border-radius:8px;padding:24px;max-width:420px;';
            box.innerHTML = '<h3 style="margin-bottom:16px;">Talk to staff</h3><div id="staff-list"></div><button class="btn menu-btn" id="staff-close" style="margin-top:16px;">Close</button>';
            overlay.appendChild(box);
            STAFF.forEach(function(s) {
                var div = document.createElement('div');
                div.style.cssText = 'margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:12px;';
                div.innerHTML = '<img src="' + V + s.img + '" alt="" style="width:48px;height:48px;object-fit:cover;border-radius:4px;" onerror="this.style.display=\'none\'"><div><strong>' + s.name + '</strong> — ' + s.role + '</div>';
                div.addEventListener('click', function() {
                    var loreText = Array.isArray(s.lore) ? s.lore[Math.floor(Math.random() * s.lore.length)] : s.lore;
                    var loreBox = document.createElement('div');
                    loreBox.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:20001;display:flex;align-items:center;justify-content:center;padding:24px;';
                    loreBox.innerHTML = '<div style="background:#1a1525;padding:24px;max-width:480px;border-radius:8px;"><img src="' + V + s.img + '" alt="" style="width:120px;height:120px;object-fit:cover;border-radius:8px;margin-bottom:16px;" onerror="this.style.display=\'none\'"><p style="margin-bottom:16px;line-height:1.6;">' + loreText.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p><button class="btn menu-btn" id="lore-close">Close</button></div>';
                    loreBox.querySelector('#lore-close').onclick = function() { loreBox.remove(); };
                    document.body.appendChild(loreBox);
                });
                box.querySelector('#staff-list').appendChild(div);
            });
            overlay.querySelector('#staff-close').onclick = function() { overlay.remove(); };
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
            document.body.appendChild(overlay);
        }
        // ============================================================================
        // MINI-GAMES — Whittle: tap 5 times, get a toy and +bond. Therapeutic. (For you. The wolf is judging.)
        // ============================================================================
        function showMinigamesModal() {
            if (!gameState) return;
            var inv = gameState.inventory || {};
            var hasWood = (inv.materials || 0) >= 1;
            var overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:20000;display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.style.cssText = 'background:#1a1525;padding:24px;border-radius:8px;max-width:360px;';
            box.innerHTML = '<h3 style="margin-bottom:16px;">Mini-games</h3><button class="btn menu-btn" id="mg-whittle" ' + (hasWood ? '' : 'disabled') + ' style="display:block;width:100%;margin-bottom:8px;">Whittle (needs 1 wood)</button><button class="btn menu-btn" id="mg-close" style="margin-top:12px;">Close</button>';
            overlay.appendChild(box);
            // WHITTLING MINI-GAME: You tap, the wood shapes. Each tap = progression image + flavor text.
                // Images: visuals/whittling/1.PNG through 5.PNG (whittling progress). Change requiredTaps to alter difficulty.
                box.querySelector('#mg-whittle').onclick = function() {
                if (!hasWood) return;
                overlay.remove();
                var taps = 0, need = 5;
                var whittleFlavor = ['It\'s still just a stick', 'Okay, it\'s a stick with a shape?', 'I see where this is going...', 'Almost there!', 'Ta-da! You made a thing!'];
                var tapDiv = document.createElement('div');
                tapDiv.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:20002;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;';
                tapDiv.innerHTML = '<img id="whittle-image" src="" alt="Whittling" style="max-width:280px;max-height:200px;object-fit:contain;margin-bottom:12px;display:none;" onerror="this.style.display=\'none\'"><p id="whittle-flavor" style="margin-bottom:8px;color:#c4b5d4;font-style:italic;">Tap to begin.</p><p id="whittle-count" style="margin-bottom:12px;">0 / ' + need + '</p><button class="btn menu-btn" id="whittle-tap" style="margin-top:8px;padding:24px;">TAP</button><button class="btn menu-btn" id="whittle-ok" style="margin-top:8px;display:none;">OK</button>';
                document.body.appendChild(tapDiv);
                var tapBtn = tapDiv.querySelector('#whittle-tap');
                var okBtn = tapDiv.querySelector('#whittle-ok');
                tapBtn.onclick = function() {
                    if (taps >= need) return;
                    taps++;
                    var imgEl = tapDiv.querySelector('#whittle-image');
                    var flavorEl = tapDiv.querySelector('#whittle-flavor');
                    var countEl = tapDiv.querySelector('#whittle-count');
                    if (imgEl) { imgEl.src = V + 'whittling/' + Math.min(taps, need) + '.PNG'; imgEl.style.display = 'block'; }
                    if (flavorEl) flavorEl.textContent = whittleFlavor[Math.min(taps, need) - 1] || whittleFlavor[need - 1];
                    if (countEl) countEl.textContent = taps + ' / ' + need;
                    if (taps >= need) {
                        tapBtn.style.display = 'none';
                        if (okBtn) okBtn.style.display = 'block';
                        if (typeof addStory === 'function') addStory('You finished whittling. It\'s... something.', 'low');
                    }
                };
                if (okBtn) okBtn.onclick = function() {
                    gameState.inventory.materials = (gameState.inventory.materials || 0) - 1;
                    if (gameState.pet) gameState.pet.bond = Math.min(100, (gameState.pet.bond || 50) + 3);
                    if (typeof addStory === 'function') addStory('You whittled a small toy. ' + (gameState.pet ? gameState.pet.name : 'The wolf') + ' appreciates it. +3 Bond.');
                    tapDiv.remove();
                    if (typeof render === 'function') render();
                };
            };
            box.querySelector('#mg-close').onclick = function() { overlay.remove(); };
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
            document.body.appendChild(overlay);
        }
        document.getElementById('btn-talk-staff').addEventListener('click', showStaffModal);
        document.getElementById('btn-minigames').addEventListener('click', showMinigamesModal);
        document.getElementById('btn-inspect').addEventListener('click', showInspectModal);
        document.getElementById('btn-map').addEventListener('click', showMapModal);
        document.getElementById('btn-observe').addEventListener('click', function() {
            if (!gameState) return;
            gameState.observeUntil = Date.now() + 15000;
            render();
        });
        document.getElementById('btn-cancel-observe').addEventListener('click', function() {
            if (gameState) gameState.observeUntil = 0;
            render();
        });
        [1, 2, 4].forEach(function(s) {
            var el = document.getElementById('btn-speed-' + s);
            if (el) el.addEventListener('click', function() {
                gameSpeed = s;
                if (gameState && gameTickInterval) {
                    clearInterval(gameTickInterval);
                    var tickMs = 250;
                    gameTickInterval = setInterval(function() {
                        if (!gameState || document.getElementById('game-container').style.display !== 'grid') return;
                        var now = Date.now();
                        ['clearing', 'garden', 'kennel', 'rabbit_farm', 'crafting'].forEach(function(locId) {
                            var queue = getQueueForLoc(gameState, locId);
                            if (queue.length && queue[0].busyUntil != null && queue[0].busyUntil <= now) {
                                var slot = queue.shift();
                                executeAction(gameState, slot.id, addStory, locId);
                                var q = getQueueForLoc(gameState, locId);
                                if (q.length && q[0].busyUntil == null) {
                                    var sp = ACTION_SPECS[q[0].id];
                                    var ms = sp ? (sp.realSec * 1000) / (gameSpeed || 1) : 5000;
                                    q[0].busyUntil = Date.now() + ms;
                                    q[0].gameMin = sp ? sp.gameMin : 30;
                                    if (['cook', 'craft_medicine', 'cook_plants'].indexOf(q[0].id) >= 0) gameState.grillOn = true;
                                }
                            }
                        });
                        gameState._addStory = addStory;
                        advanceTime(gameState, 0.25 * (gameSpeed || 1));
                        render();
                    }, tickMs);
                }
                render();
            });
        });

        // ============================================================================
        // REPORTS - Read Reports modal. Sections A–D: Job Description, NDA, Briefing, Incidents. Add items to expand.
        // ============================================================================
        var REPORT_SECTIONS = {
            A: { title: 'Job Description (Tutorials)', items: [
                { title: 'How to care for assets', body: 'Assets require daily feeding (species-appropriate diet), water, and clean enclosures. Bond and Fear management is critical. Neglect leads to escape risk and incident.' },
                { title: 'Clearing: Hunting', body: 'Send werewolf to find food and resources. Success depends on form and moon phase. High stamina cost.' },
                { title: 'Clearing: Patrol', body: 'Send werewolf to guard territory. Reduces escape chance, increases security. May encounter hostiles.' },
                { title: 'Clearing: Explore', body: 'Send werewolf to discover new locations and resources. Forage for plants, seeds, herbs, materials.' },
                { title: 'Farming basics', body: 'Plant seeds in soil. Water daily. Add compost to speed growth. Harvest when ready. Repeat. Compost from kennel waste.' },
                { title: 'Feeding protocols', body: 'Human-form assets: cooked meat, plants. Wolf-form: raw meat only. Wrong diet causes sickness. Track hunger and thirst; provide water from creek or rain catcher.' },
                { title: 'Bond and Fear management', body: 'Bonding (time spent, feeding, ritual) reduces Fear. Fear increases from neglect, violence, full moon, isolation. High Fear accelerates shift and escape risk. Keep Bond above 30 when Fear is high.' },
                { title: 'Training basics', body: 'Training improves strength, speed, endurance. Use the path and dummy. Wolf form has combat bonuses but higher escape risk if Bond is low.' },
                { title: 'Facility maintenance', body: 'Kennel waste goes to compost. Garden needs watering daily. Rain catcher provides water. Craft medicine from herbs and materials. Grill cooks meat for human consumption.' },
            ]},
            B: { title: 'NDA & Asset Classification', items: [
                { title: 'Classification levels', body: 'CONFIDENTIAL. Asset designations: Alpha (high control), Beta (moderate), Omega (feral risk). Current subject: Beta, designation Luna. Previous handler KIA during uprising.' },
                { title: 'Asset designations', body: 'Alpha: Full compliance, low escape risk. Beta: Manageable with routine care; bond-dependent. Omega: Containment priority; do not approach without reinforcement.' },
                { title: 'Healing sickness', body: 'Basic medicine: Water + Herbs, cook to make tea. Add to food or water. Wrong food type: medicine + rest. Contaminated food: medicine + clean water. Neglect: medicine + bonding + proper care. Untreated: HP drains, death possible.' },
                { title: 'Hybrid diet', body: 'Hybrids can eat anything without getting sick. Most versatile, hardest to predict. If a werewolf eats wrong food: craft medicine (water + herbs), administer via food or water, rest until recovered.' },
                { title: 'Breeding protocol', body: 'Adults only. Moon phase at conception affects offspring traits. Goal: breed werewolves for specific combat roles. Your job: create the perfect pack. Dominant traits guaranteed if unlocked; random traits from parents; rare mutation chance.' },
                { title: 'Legal disclaimers', body: 'By signing you acknowledge the risks. The facility is not liable for injury or death resulting from asset contact. All communications are property of the project.' },
                { title: 'Sign here', body: 'I understand that werewolves are classified assets, not persons. I will refer to them as assets in all logs. _________________________' },
            ]},
            C: { title: 'Briefing (Your Purpose)', items: [
                { title: 'Why the sanctuary exists', body: 'The sanctuary preserves the last surviving specimens after the uprising. Your role is containment, care, and data collection. The outside world has written this place off.' },
                { title: 'What happened during the uprising', body: 'Assets breached containment. Most escaped or were put down. One remained—Luna. The previous worker was killed during the event. You are the replacement.' },
                { title: 'Current objectives', body: 'Maintain the asset. Repair the kennel. Establish farm and rabbit production for sustainable food. Do not let the asset escape. Report any anomalies.' },
                { title: 'Long-term goals', body: 'Stabilize the subject. Document behavior and shift patterns. If the compound ever re-establishes contact, your logs may be the only record left.' },
            ]},
            D: { title: 'Gruesome Incident Reports', items: [
                { title: 'Asset 7 consumed handler during full moon', body: 'Handler entered enclosure despite protocol. Asset 7 had not been fed. Remains unrecovered. Asset terminated.' },
                { title: 'Containment breach - three staff lost', body: 'Breach occurred at dusk. Three staff killed before reinforcement. Asset escaped into forest. Search abandoned after 72 hours.' },
                { title: 'Feeding error resulted in...', body: 'Wrong diet administered to Asset 3. Subject became violently ill and attacked attendant. Both deceased. Do not deviate from feeding protocols.' },
                { title: 'I told them the cage wasn\'t secured!', body: 'Employee statement (excerpt): "I told them the cage wasn\'t secured! They said we were behind schedule. Now Jenkins is dead. It looked at me. It knew what it was doing."' },
                { title: 'The moon isn\'t full for another week', body: 'Incident log: Asset shifted without full moon. This shouldn\'t be possible. Subject displayed awareness before attack. Request immediate review of all shift-threshold data.' },
            ]},
            E: { title: 'Troubleshooting: Common Issues and Solutions', items: [
                { title: 'Why can\'t I hunt?', body: 'WHY CAN\'T I HUNT? — Wolf is a pup (pups cannot hunt—they\'re too young). Wolf is hungry/thirsty/tired (fill needs first). Wolf is injured (heal first). Wolf fear too high (bond with them). Action queue full (wait or clear).' },
                { title: 'Why can\'t I train?', body: 'Same as hunting, plus: Wolf may need stamina. Training dummy may be damaged (repair if available).' },
                { title: 'Why can\'t I feed plants to my wolf?', body: 'Check wolf\'s form: Human can eat plants. Wolf gets sick from plants. Hybrid can eat anything.' },
                { title: 'Why are my rabbits dying?', body: 'Rabbits need daily: Food, water, clean cage. If sick: medicine. Lonely (1 rabbit) gets sick over time; 2+ helps. Dirty cage causes sickness. Warnings at 24h and 48h—act before "Rabbits will die today."' },
                { title: 'How do I get more rabbits?', body: 'Craft a Rabbit Trap (3 materials + 2 plants) in Crafting. Go to Clearing and use "Set Rabbit Traps." Wait ~2 min (real time), then the trap is checked automatically—catch, break, or empty. Or use "Capture rabbit" on Rabbit Farm when you have 0 rabbits (50% success). Bait/Premium Bait improve trap catch when you have them.' },
                { title: 'Why can\'t I bring the wolf back?', body: 'You need a Net to recapture an escaped wolf. Craft one in Crafting (5 materials + 3 plants). On hunt or patrol, when you find them, choose "Bring back"—the net is used and has a 15% chance to break.' },
                { title: 'Why is the button still gray?', body: 'Save and reload. Check for active events. Verify required items in inventory. Check queue (one action at a time per tab; clear queue if stuck).' },
            ]}
        };
        var reportsModal = null;
        var achievementsModal = null;
        var hirePreviewModal = null;
        var breedingModal = null;
        function showBreedingModal() {
            if (!gameState || breedingModal) return;
            var pack = gameState.pack || [];
            var adults = pack.filter(function(p) { return getLifeStage(p.ageInDays) === 'adult'; });
            if (adults.length < 2) return;
            if (breedingModal) breedingModal.remove();
            var overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:20000;display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.style.cssText = 'background:#1a1525;border:1px solid rgba(140,120,160,0.4);border-radius:8px;padding:24px;max-width:420px;';
            var maleOpts = adults.map(function(p) { return '<option value="' + p.id + '">' + (p.name || 'Wolf') + ' (' + (p.gender || '') + ')</option>'; }).join('');
            var femaleOpts = adults.map(function(p) { return '<option value="' + p.id + '">' + (p.name || 'Wolf') + ' (' + (p.gender || '') + ')</option>'; }).join('');
            box.innerHTML = '<h3 style="margin-bottom:12px;">Breeding</h3><p style="font-size:0.9em;margin-bottom:12px;">Standard: ' + (CONFIG.BREEDING_FOOD_COST || 20) + ' food, ' + (CONFIG.BREEDING_MATERIALS_COST || 10) + ' materials. Premium: ' + (CONFIG.PREMIUM_FOOD_COST || 40) + ' food, ' + (CONFIG.PREMIUM_MATERIALS_COST || 20) + ' materials (choose gender + 1 ability).</p><label style="display:block;margin-bottom:8px;">Male</label><select id="breed-male" style="margin-bottom:12px;padding:6px;background:#1a1525;color:#e8e0e8;border:1px solid rgba(140,120,160,0.4);border-radius:4px;width:100%;">' + maleOpts + '</select><label style="display:block;margin-bottom:8px;">Female</label><select id="breed-female" style="margin-bottom:12px;padding:6px;background:#1a1525;color:#e8e0e8;border:1px solid rgba(140,120,160,0.4);border-radius:4px;width:100%;">' + femaleOpts + '</select><label style="display:block;margin-bottom:4px;"><input type="checkbox" id="breed-premium"> Premium (choose gender + ability)</label><div id="breed-premium-options" style="display:none;margin-top:8px;"><label>Gender</label><select id="breed-gender" style="margin:4px 0 8px 0;padding:4px;background:#1a1525;color:#e8e0e8;border:1px solid rgba(140,120,160,0.4);width:100%;"><option value="Male">Male</option><option value="Female">Female</option></select><label>Ability (from parents)</label><select id="breed-ability" style="margin:4px 0 8px 0;padding:4px;background:#1a1525;color:#e8e0e8;border:1px solid rgba(140,120,160,0.4);width:100%;"></select></div><button class="btn btn-care" id="breed-confirm" style="margin-right:8px;margin-top:12px;">Confirm</button><button class="btn menu-btn" id="breed-cancel" style="margin-top:12px;">Cancel</button>';
            overlay.appendChild(box);
            document.body.appendChild(overlay);
            breedingModal = overlay;
            box.querySelector('#breed-premium').addEventListener('change', function() {
                box.querySelector('#breed-premium-options').style.display = this.checked ? 'block' : 'none';
                if (this.checked) updateBreedAbilityOptions();
            });
            function updateBreedAbilityOptions() {
                var maleId = box.querySelector('#breed-male').value;
                var femaleId = box.querySelector('#breed-female').value;
                var male = pack.find(function(p) { return p.id === maleId; });
                var female = pack.find(function(p) { return p.id === femaleId; });
                var all = [].concat(male.abilities || [], female.abilities || []);
                var uniq = all.filter(function(a, i) { return all.indexOf(a) === i; });
                var sel = box.querySelector('#breed-ability');
                sel.innerHTML = '<option value="">Random</option>' + (uniq.map(function(aid) { var A = (typeof SPECIAL_ABILITIES !== 'undefined' ? SPECIAL_ABILITIES : []).find(function(x) { return x.id === aid; }); return '<option value="' + aid + '">' + (A ? A.name : aid) + '</option>'; }).join(''));
            }
            box.querySelector('#breed-male').addEventListener('change', function() { if (box.querySelector('#breed-premium').checked) updateBreedAbilityOptions(); });
            box.querySelector('#breed-female').addEventListener('change', function() { if (box.querySelector('#breed-premium').checked) updateBreedAbilityOptions(); });
            box.querySelector('#breed-confirm').addEventListener('click', function() {
                var maleId = box.querySelector('#breed-male').value;
                var femaleId = box.querySelector('#breed-female').value;
                var premium = box.querySelector('#breed-premium').checked;
                var selectedGender = premium ? box.querySelector('#breed-gender').value : null;
                var selectedAbility = premium ? (box.querySelector('#breed-ability').value || null) : null;
                if (startBreeding(gameState, maleId, femaleId, premium, selectedGender, selectedAbility, addStory)) {
                    overlay.remove();
                    breedingModal = null;
                    if (typeof render === 'function') render();
                }
            });
            box.querySelector('#breed-cancel').addEventListener('click', function() { overlay.remove(); breedingModal = null; if (typeof render === 'function') render(); });
            overlay.addEventListener('click', function(e) { if (e.target === overlay) { overlay.remove(); breedingModal = null; if (typeof render === 'function') render(); } });
        }
        function showHirePreviewModal(role) {
            if (!gameState || gameState.inboundWorker) return;
            var inv = gameState.inventory || {};
            if ((inv.plants || 0) < 5 || (inv.materials || 0) < 3) return;
            if (hirePreviewModal) { hirePreviewModal.remove(); hirePreviewModal = null; }
            var preview = { role: role, name: role, fear: 20, cooking: 3 + Math.floor(Math.random() * 6), medical: 2 + Math.floor(Math.random() * 5), security: 2 + Math.floor(Math.random() * 6), maintenance: 2 + Math.floor(Math.random() * 6), caretaking: 3 + Math.floor(Math.random() * 5) };
            var roleToPortrait = { Cook: 'cook.PNG', Security: 'security.PNG', Doctor: 'doctor.PNG', Repair: 'repair_man.PNG', Caretaker: 'commander.PNG' };
            var portrait = V + (roleToPortrait[role] || 'commander.PNG');
            var skills = 'Cooking: ' + preview.cooking + '/10 · Medical: ' + preview.medical + ' · Security: ' + preview.security + ' · Maintenance: ' + preview.maintenance + ' · Caretaking: ' + preview.caretaking;
            var overlay = document.createElement('div');
            overlay.className = 'hire-preview-overlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:20000;display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.style.cssText = 'background:#1a1525;border:1px solid rgba(140,120,160,0.4);border-radius:8px;padding:24px;max-width:400px;';
            box.innerHTML = '<h3 style="margin-bottom:12px;">Hire Worker</h3><div style="display:flex;gap:16px;margin-bottom:16px;"><img id="hire-preview-portrait" src="" alt="" style="width:80px;height:80px;object-fit:cover;border-radius:8px;"><div><strong id="hire-preview-name"></strong><br><span id="hire-preview-role" style="color:#a0a0a0;"></span><br><span id="hire-preview-skills" style="font-size:0.9em;color:#b0b0b0;"></span></div></div><p style="margin-bottom:16px;">Cost: 5 plants, 3 materials</p><p style="margin-bottom:16px;">Arrives on next helicopter drop.</p><button class="btn btn-care" id="hire-preview-confirm" style="margin-right:8px;">Confirm</button><button class="btn menu-btn" id="hire-preview-cancel">Cancel</button>';
            box.querySelector('#hire-preview-portrait').src = portrait;
            box.querySelector('#hire-preview-name').textContent = preview.name;
            box.querySelector('#hire-preview-role').textContent = preview.role;
            box.querySelector('#hire-preview-skills').textContent = skills;
            overlay.appendChild(box);
            box.querySelector('#hire-preview-confirm').addEventListener('click', function() {
                var inv2 = gameState.inventory || {};
                if ((inv2.plants || 0) < 5 || (inv2.materials || 0) < 3 || gameState.inboundWorker) { if (hirePreviewModal) hirePreviewModal.remove(); hirePreviewModal = null; if (typeof render === 'function') render(); return; }
                inv2.plants = (inv2.plants || 0) - 5;
                inv2.materials = (inv2.materials || 0) - 3;
                gameState.inboundWorker = preview;
                if (typeof addStory === 'function') addStory('Worker hired (' + preview.role + '). ETA: next helicopter drop.', 'high');
                if (hirePreviewModal) hirePreviewModal.remove();
                hirePreviewModal = null;
                if (typeof render === 'function') render();
            });
            box.querySelector('#hire-preview-cancel').addEventListener('click', function() { overlay.remove(); hirePreviewModal = null; if (typeof render === 'function') render(); });
            overlay.addEventListener('click', function(e) { if (e.target === overlay) { overlay.remove(); hirePreviewModal = null; if (typeof render === 'function') render(); } });
            document.body.appendChild(overlay);
            hirePreviewModal = overlay;
        }
        function showAchievementsModal() {
            if (!gameState) return;
            if (achievementsModal) { achievementsModal.remove(); achievementsModal = null; }
            var overlay = document.createElement('div');
            overlay.className = 'achievements-overlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:20000;display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.style.cssText = 'background:#1a1525;border:1px solid rgba(140,120,160,0.4);border-radius:8px;padding:24px;max-width:480px;max-height:80vh;overflow:auto;';
            box.innerHTML = '<h3 style="margin-bottom:16px;">Achievements</h3><p style="margin-bottom:12px;color:#a0a0a0;">Player XP: ' + (gameState.playerXP || 0) + '</p><div id="achievements-list"></div><button class="btn menu-btn" id="achievements-close" style="margin-top:16px;">Close</button>';
            var list = box.querySelector('#achievements-list');
            ACHIEVEMENTS.forEach(function(a) {
                var unlocked = gameState.achievements && gameState.achievements[a.id];
                var row = document.createElement('div');
                row.style.cssText = 'padding:10px 12px;margin-bottom:8px;background:' + (unlocked ? 'rgba(100,180,100,0.15)' : 'rgba(255,255,255,0.05)') + ';border-radius:4px;border-left:3px solid ' + (unlocked ? '#6a9' : '#444') + ';';
                row.innerHTML = (unlocked ? '&#10003; ' : '&#9634; ') + '<strong>' + a.name + '</strong> <span style="color:#888;font-size:0.9em">+' + a.xp + ' XP</span>';
                list.appendChild(row);
            });
            overlay.appendChild(box);
            overlay.querySelector('#achievements-close').addEventListener('click', function() { overlay.remove(); achievementsModal = null; });
            overlay.addEventListener('click', function(e) { if (e.target === overlay) { overlay.remove(); achievementsModal = null; } });
            document.body.appendChild(overlay);
            achievementsModal = overlay;
        }
        function showReportsModal() {
            if (!gameState) return;
            if (reportsModal) { reportsModal.remove(); reportsModal = null; }
            var overlay = document.createElement('div');
            overlay.className = 'reports-overlay';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:20000;display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.className = 'reports-box';
            box.style.cssText = 'background:#1a1525;border:1px solid rgba(140,120,160,0.4);border-radius:8px;padding:24px;max-width:520px;max-height:85vh;overflow:auto;';
            box.innerHTML = '<h3 style="margin-bottom:16px;">Reports</h3><div id="reports-list"></div><button class="btn menu-btn" id="reports-close" style="margin-top:16px;">Close</button>';
            overlay.appendChild(box);
            var list = box.querySelector('#reports-list');
            ['A', 'B', 'C', 'D', 'E'].forEach(function(key) {
                var sec = REPORT_SECTIONS[key];
                if (!sec) return;
                var h4 = document.createElement('h4');
                h4.style.cssText = 'margin:16px 0 8px 0;font-size:0.95em;color:#b8a8c8;cursor:pointer;';
                h4.textContent = sec.title;
                h4.addEventListener('click', function() {
                    gameState.reportsSectionsRead = gameState.reportsSectionsRead || {};
                    gameState.reportsSectionsRead[key] = true;
                    checkAchievement(gameState, 'dull_boy', typeof gameState._addStory === 'function' ? gameState._addStory : function() {});
                    if (typeof render === 'function') render();
                });
                list.appendChild(h4);
                (sec.items || []).forEach(function(r) {
                    var div = document.createElement('div');
                    div.style.cssText = 'margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:4px;cursor:pointer;';
                    div.innerHTML = '<strong>' + (r.title || '') + '</strong>';
                    div.addEventListener('click', function() {
                        gameState.reportsSectionsRead = gameState.reportsSectionsRead || {};
                        gameState.reportsSectionsRead[key] = true;
                        checkAchievement(gameState, 'dull_boy', typeof gameState._addStory === 'function' ? gameState._addStory : function() {});
                        if (typeof render === 'function') render();
                        alert((r.title || '') + '\n\n' + (r.body || ''));
                    });
                    list.appendChild(div);
                });
            });
            overlay.querySelector('#reports-close').addEventListener('click', function() { overlay.remove(); reportsModal = null; });
            overlay.addEventListener('click', function(e) { if (e.target === overlay) { overlay.remove(); reportsModal = null; } });
            document.body.appendChild(overlay);
            reportsModal = overlay;
        }
        function maybeAddReport(state) {
            if (!state.reports) state.reports = [];
        }

        // New Game: growl, fade to black, wait for growl to finish, then prologue
        document.getElementById('btn-new-game').addEventListener('click', () => {
            if (localStorage.getItem('desolation_save') && !confirm('Start a new game? Current save will be overwritten.')) return;
            hideCinema();
            if (window._introTitleAudio) { window._introTitleAudio.pause(); window._introTitleAudio.currentTime = 0; }
            const growlSnd = loadAudioMain('howlings.mp3');
            growlSnd.play().catch(() => {});
            document.body.style.transition = 'background 1.2s ease';
            document.body.style.background = '#000';
            const growlMs = Math.min(getAudioDurationMs(growlSnd, 4), 8000);
            setTimeout(() => {
                document.body.style.transition = '';
                runPrologue(startGame);
            }, growlMs + 400);
        });

        document.getElementById('btn-load-game').addEventListener('click', () => {
            if (loadGame()) return;
            alert('No save file found.');
        });

        document.getElementById('btn-exhibition').addEventListener('click', () => {
            if (confirm('Start an exhibition match vs CPU? (Uses same game for now)')) startGame();
        });

        // First: show "Click to start" so audio can play after user gesture. Then run intro.
        (function init() {
            const clickStart = document.getElementById('click-to-start');
            const cinema = document.getElementById('cinema');
            if (sessionStorage.getItem('desolation_skip_intro')) {
                if (clickStart) clickStart.classList.add('hidden');
                if (cinema) {
                    cinema.classList.remove('hidden');
                    cinema.style.display = 'block';
                    showScreen('cinema-title-full');
                    showMenuOverlay();
                }
                return;
            }
            if (clickStart) {
                clickStart.classList.remove('hidden');
                clickStart.style.display = 'block';
                clickStart.querySelector('.screen').addEventListener('click', function go() {
                    clickStart.classList.add('hidden');
                    clickStart.style.display = 'none';
                    if (cinema) {
                        cinema.classList.remove('hidden');
                        cinema.style.display = 'block';
                        const skip = document.createElement('button');
                        skip.textContent = 'Skip intro';
                        skip.className = 'menu-btn skip-intro-btn';
                        skip.style.cssText = 'opacity:0.8;';
                        skip.addEventListener('click', function() {
                            sessionStorage.setItem('desolation_skip_intro', '1');
                            showScreen('cinema-title-full');
                            showMenuOverlay();
                        });
                        cinema.appendChild(skip);
                        setTimeout(() => { skip.style.opacity = '1'; }, 2000);
                        runIntro();
                    } else {
                        cinema.classList.remove('hidden');
                        cinema.style.display = 'block';
                        showScreen('cinema-title-full');
                        showMenuOverlay();
                    }
                }, { once: true });
            } else if (cinema) {
                cinema.classList.remove('hidden');
                cinema.style.display = 'block';
                runIntro();
            } else {
                showMenuOverlay();
            }
        })();
    </script>
</body>
</html>
